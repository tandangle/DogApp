"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var MODULE_PREFIX = 'fs-loader-';
var globalHolder = {};
var initializeGlobalNamespace = function () {
    var holder;
    // if there is no window obj use nodejs global lib variable
    if (typeof window === 'undefined') {
        holder = globalHolder;
    }
    else {
        holder = window;
    }
    // @ts-ignore
    var namespace = holder.filestackInternals;
    if (!namespace) {
        namespace = {
            modules: {},
        };
        holder.filestackInternals = namespace;
    }
    if (!namespace.modules) {
        namespace.modules = {};
    }
    return namespace;
};
var filestackInternals = initializeGlobalNamespace();
var modules = filestackInternals && filestackInternals.modules;
/**
 * Remove listeners (browser compatible)
 *
 * @param node
 * @param func
 * @param name
 */
var removeListener = function (node, func, name) {
    if (node.detachEvent) {
        node.detachEvent('onreadystatechange', func);
    }
    else {
        node.removeEventListener(name, func, false);
    }
};
/**
 * Load multiple modules
 *
 * @param {*} modules
 */
exports.loadModules = function (modulesList) { return Promise.all(modulesList.map(function (_a) {
    var id = _a.id, url = _a.url;
    return exports.loadModule(id, url);
})).then(function (res) {
    var toReturn = {};
    res.forEach(function (mod, idx) {
        var el = modulesList[idx];
        toReturn[el.id] = mod;
    });
    return toReturn;
}); };
/**
 * Load single module from url with given id
 *
 * @param {*} id - module id
 * @param {*} url
 */
exports.loadModule = function (id, url) {
    if (typeof window === 'undefined') {
        return Promise.reject(new Error('Load module is working only on browser env'));
    }
    if (!id) {
        throw new Error('Module id is required');
    }
    var moduleDefinition = modules[id];
    id = MODULE_PREFIX + id;
    if (!moduleDefinition) {
        modules[id] = {};
        moduleDefinition = modules[id];
    }
    if (moduleDefinition.instance) {
        return Promise.resolve(moduleDefinition.instance);
    }
    if (moduleDefinition.promise) {
        return moduleDefinition.promise;
    }
    return moduleDefinition.promise = new Promise(function (resolve, reject) {
        var readyStateChange = function (evt) {
            if (evt.type === 'load' || (/^(complete|loaded)$/.test((evt.currentTarget || evt.srcElement).readyState))) {
                var node = evt.currentTarget || evt.srcElement;
                removeListener(node, readyStateChange, 'load');
                removeListener(node, reject, 'error');
                // slow dow checking if module is loaded to ensure that script that  register module is called
                setTimeout(function () { return resolve(modules[id] ? modules[id].instance : undefined); }, 10);
            }
        };
        var script = document.createElement('script');
        script.id = id;
        // @ts-ignore fix for IE
        if (script.attachEvent && !(script.attachEvent.toString && script.attachEvent.toString().indexOf('[native code') < 0)) {
            // @ts-ignore
            script.attachEvent('onreadystatechange', readyStateChange);
        }
        else {
            script.addEventListener('load', readyStateChange, false);
            script.addEventListener('onerror', reject, false);
        }
        script.setAttribute('crossorigin', 'anonymous');
        script.setAttribute('charset', 'utf-8');
        script.setAttribute('async', 'true');
        script.src = url;
        document.body.appendChild(script);
    });
};
/**
 * Register that module is ready
 *
 * @param {string} id
 * @param {any} instance
 * @param {any} metadata - additional module metadata like version
 */
exports.registerModule = function (id, instance, metadata) {
    // loader not working on nodejs envs
    if (typeof window === 'undefined') {
        return;
    }
    if (!id) {
        throw new Error('Module id is required');
    }
    if (!modules) {
        throw new Error('Loader is not initialized');
    }
    id = MODULE_PREFIX + id;
    if (modules[id]) {
        modules[id] = { instance: instance, metadata: metadata };
    }
};
/**
 * Load external css from given url
 *
 * @param {*} url
 */
exports.loadCss = function (url) {
    var alreadyAddedThisTag = document.querySelector("link[href=\"" + url + "\"]");
    if (alreadyAddedThisTag !== null) {
        return Promise.resolve();
    }
    return new Promise(function (resolve) {
        var head = document.getElementsByTagName('head')[0];
        var link = document.createElement('link');
        var loaded = function () {
            resolve();
            link.removeEventListener('load', loaded);
        };
        link.rel = 'stylesheet';
        link.href = url;
        link.addEventListener('load', loaded);
        head.appendChild(link);
    });
};
/**
 * Enum just for unify filestack module names
 */
var FILESTACK_MODULES;
(function (FILESTACK_MODULES) {
    FILESTACK_MODULES["FILESTACK_SDK"] = "filestack-sdk";
    FILESTACK_MODULES["TRANSFORMS_UI"] = "transforms-ui";
    FILESTACK_MODULES["PICKER"] = "picker";
})(FILESTACK_MODULES = exports.FILESTACK_MODULES || (exports.FILESTACK_MODULES = {}));
;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9saWIvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxJQUFNLGFBQWEsR0FBRyxZQUFZLENBQUM7QUFDbkMsSUFBTSxZQUFZLEdBQVEsRUFBRSxDQUFDO0FBZTdCLElBQU0seUJBQXlCLEdBQUc7SUFDaEMsSUFBSSxNQUFVLENBQUM7SUFFZiwyREFBMkQ7SUFDM0QsSUFBSSxPQUFPLE1BQU0sS0FBSyxXQUFXLEVBQUU7UUFDakMsTUFBTSxHQUFHLFlBQVksQ0FBQztLQUN2QjtTQUFNO1FBQ0wsTUFBTSxHQUFHLE1BQU0sQ0FBQTtLQUNoQjtJQUVELGFBQWE7SUFDYixJQUFJLFNBQVMsR0FBYyxNQUFNLENBQUMsa0JBQWtCLENBQUM7SUFFckQsSUFBSSxDQUFDLFNBQVMsRUFBRTtRQUNkLFNBQVMsR0FBRztZQUNWLE9BQU8sRUFBRSxFQUFFO1NBQ1osQ0FBQztRQUVGLE1BQU0sQ0FBQyxrQkFBa0IsR0FBRyxTQUFTLENBQUM7S0FDdkM7SUFFRCxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sRUFBRTtRQUN0QixTQUFTLENBQUMsT0FBTyxHQUFHLEVBQUUsQ0FBQztLQUN4QjtJQUVELE9BQU8sU0FBUyxDQUFDO0FBQ25CLENBQUMsQ0FBQztBQUVGLElBQU0sa0JBQWtCLEdBQUcseUJBQXlCLEVBQUUsQ0FBQztBQUN2RCxJQUFNLE9BQU8sR0FBRyxrQkFBa0IsSUFBSSxrQkFBa0IsQ0FBQyxPQUFPLENBQUM7QUFFakU7Ozs7OztHQU1HO0FBQ0gsSUFBTSxjQUFjLEdBQUcsVUFBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUk7SUFDdEMsSUFBSSxJQUFJLENBQUMsV0FBVyxFQUFFO1FBQ3BCLElBQUksQ0FBQyxXQUFXLENBQUMsb0JBQW9CLEVBQUUsSUFBSSxDQUFDLENBQUM7S0FDOUM7U0FBTTtRQUNMLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLEVBQUUsSUFBSSxF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Qy9CLG9EQUErQixDQUFBO0lBQy9CLHNDQUFpQixDQUFBO0FBQ25CLENBQUMsRUFKVyxpQkFBaUIsR0FBakIseUJBQWlCLEtBQWpCLHlCQUFpQixRQUk1QjtBQUFBLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBNT0RVTEVfUFJFRklYID0gJ2ZzLWxvYWRlci0nO1xuY29uc3QgZ2xvYmFsSG9sZGVyOiBhbnkgPSB7fTtcblxuZXhwb3J0IHR5cGUgTW9kdWxlRGVmID0ge1xuICBwcm9taXNlPzogUHJvbWlzZTxhbnk+XG4gIHJlc29sdmVQcm9taXNlPzogYW55O1xuICBpbnN0YW5jZT86IGFueTtcbiAgbWV0YWRhdGE/OiBhbnk7XG59XG5cbmV4cG9ydCB0eXBlIE5hbWVzcGFjZSA9IHtcbiAgICBtb2R1bGVzOiB7XG4gICAgIFtrZXk6IHN0cmluZ106IE1vZHVsZURlZlxuICAgIH1cbn07XG5cbmNvbnN0IGluaXRpYWxpemVHbG9iYWxOYW1lc3BhY2UgPSAoKSA9PiB7XG4gIGxldCBob2xkZXI6YW55O1xuXG4gIC8vIGlmIHRoZXJlIGlzIG5vIHdpbmRvdyBvYmogdXNlIG5vZGVqcyBnbG9iYWwgbGliIHZhcmlhYmxlXG4gIGlmICh0eXBlb2Ygd2luZG93ID09PSAndW5kZWZpbmVkJykge1xuICAgIGhvbGRlciA9IGdsb2JhbEhvbGRlcjtcbiAgfSBlbHNlIHtcbiAgICBob2xkZXIgPSB3aW5kb3dcbiAgfVxuXG4gIC8vIEB0cy1pZ25vcmVcbiAgbGV0IG5hbWVzcGFjZTogTmFtZXNwYWNlID0gaG9sZGVyLmZpbGVzdGFja0ludGVybmFscztcblxuICBpZiAoIW5hbWVzcGFjZSkge1xuICAgIG5hbWVzcGFjZSA9IHtcbiAgICAgIG1vZHVsZXM6IHt9LFxuICAgIH07XG5cbiAgICBob2xkZXIuZmlsZXN0YWNrSW50ZXJuYWxzID0gbmFtZXNwYWNlO1xuICB9XG5cbiAgaWYgKCFuYW1lc3BhY2UubW9kdWxlcykge1xuICAgIG5hbWVzcGFjZS5tb2R1bGVzID0ge307XG4gIH1cbiAgXG4gIHJldHVybiBuYW1lc3BhY2U7XG59O1xuXG5jb25zdCBmaWxlc3RhY2tJbnRlcm5hbHMgPSBpbml0aWFsaXplR2xvYmFsTmFtZXNwYWNlKCk7XG5jb25zdCBtb2R1bGVzID0gZmlsZXN0YWNrSW50ZXJuYWxzICYmIGZpbGVzdGFja0ludGVybmFscy5tb2R1bGVzO1xuXG4vKipcbiAqIFJlbW92ZSBsaXN0ZW5lcnMgKGJyb3dzZXIgY29tcGF0aWJsZSlcbiAqIFxuICogQHBhcmFtIG5vZGUgXG4gKiBAcGFyYW0gZnVuYyBcbiAqIEBwYXJhbSBuYW1lIFxuICovXG5jb25zdCByZW1vdmVMaXN0ZW5lciA9IChub2RlLCBmdW5jLCBuYW1lLCApID0+IHtcbiAgaWYgKG5vZGUuZGV0YWNoRXZlbnQpIHtcbiAgICBub2RlLmRldGFjaEV2ZW50KCdvbnJlYWR5c3RhdGVjaGFuZ2UnLCBmdW5jKTtcbiAgfSBlbHNlIHtcbiAgICBub2RlLnJlbW92ZUV2ZW50TGlzdGVuZXIobmFtZSwgZnVuYywgZmFsc2UpO1xuICB9XG59XG5cbi8qKlxuICogTG9hZCBtdWx0aXBsZSBtb2R1bGVzXG4gKiBcbiAqIEBwYXJhbSB7Kn0gbW9kdWxlcyBcbiAqL1xuZXhwb3J0IGNvbnN0IGxvYWRNb2R1bGVzID0gKG1vZHVsZXNMaXN0KSA9PiBQcm9taXNlLmFsbChtb2R1bGVzTGlzdC5tYXAoKHsgaWQsIHVybCB9KSA9PiBsb2FkTW9kdWxlKGlkLCB1cmwpKSkudGhlbigocmVzKSA9PiB7XG4gIGNvbnN0IHRvUmV0dXJuID0ge307XG5cbiAgcmVzLmZvckVhY2goKG1vZCwgaWR4KSA9PiB7XG4gICAgY29uc3QgZWwgPSBtb2R1bGVzTGlzdFtpZHhdO1xuICAgIHRvUmV0dXJuW2VsLmlkXSA9IG1vZDtcbiAgfSk7XG5cbiAgcmV0dXJuIHRvUmV0dXJuO1xufSk7XG5cbi8qKlxuICogTG9hZCBzaW5nbGUgbW9kdWxlIGZyb20gdXJsIHdpdGggZ2l2ZW4gaWRcbiAqXG4gKiBAcGFyYW0geyp9IGlkIC0gbW9kdWxlIGlkIFxuICogQHBhcmFtIHsqfSB1cmxcbiAqL1xuZXhwb3J0IGNvbnN0IGxvYWRNb2R1bGUgPSAoaWQ6IHN0cmluZywgdXJsOiBzdHJpbmcpID0+IHtcbiAgaWYgKHR5cGVvZiB3aW5kb3cgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgcmV0dXJuIFByb21pc2UucmVqZWN0KG5ldyBFcnJvcignTG9hZCBtb2R1bGUgaXMgd29ya2luZyBvbmx5IG9uIGJyb3dzZXIgZW52JykpO1xuICB9XG5cbiAgaWYgKCFpZCkge1xuICAgIHRocm93IG5ldyBFcnJvcignTW9kdWxlIGlkIGlzIHJlcXVpcmVkJylcbiAgfVxuXG4gIGxldCBtb2R1bGVEZWZpbml0aW9uID0gbW9kdWxlc1tpZF07XG5cbiAgaWQgPSAgTU9EVUxFX1BSRUZJWCArIGlkO1xuXG4gIGlmICghbW9kdWxlRGVmaW5pdGlvbikge1xuICAgIG1vZHVsZXNbaWRdID0ge307XG4gICAgbW9kdWxlRGVmaW5pdGlvbiA9IG1vZHVsZXNbaWRdO1xuICB9XG5cbiAgaWYgKG1vZHVsZURlZmluaXRpb24uaW5zdGFuY2UpIHtcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKG1vZHVsZURlZmluaXRpb24uaW5zdGFuY2UpO1xuICB9XG5cbiAgaWYgKG1vZHVsZURlZmluaXRpb24ucHJvbWlzZSkge1xuICAgIHJldHVybiBtb2R1bGVEZWZpbml0aW9uLnByb21pc2U7XG4gIH1cblxuICByZXR1cm4gbW9kdWxlRGVmaW5pdGlvbi5wcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIGNvbnN0IHJlYWR5U3RhdGVDaGFuZ2UgPSAoZXZ0OiBhbnkpID0+IHtcbiAgICAgIGlmIChldnQudHlwZSA9PT0gJ2xvYWQnIHx8ICgvXihjb21wbGV0ZXxsb2FkZWQpJC8udGVzdCgoZXZ0LmN1cnJlbnRUYXJnZXQgfHwgZXZ0LnNyY0VsZW1lbnQpLnJlYWR5U3RhdGUpKSkge1xuICAgICAgICBjb25zdCBub2RlID0gIGV2dC5jdXJyZW50VGFyZ2V0IHx8IGV2dC5zcmNFbGVtZW50O1xuXG4gICAgICAgIHJlbW92ZUxpc3RlbmVyKG5vZGUsIHJlYWR5U3RhdGVDaGFuZ2UsICdsb2FkJyk7XG4gICAgICAgIHJlbW92ZUxpc3RlbmVyKG5vZGUsIHJlamVjdCwgJ2Vycm9yJyk7XG5cbiAgICAgICAgLy8gc2xvdyBkb3cgY2hlY2tpbmcgaWYgbW9kdWxlIGlzIGxvYWRlZCB0byBlbnN1cmUgdGhhdCBzY3JpcHQgdGhhdCAgcmVnaXN0ZXIgbW9kdWxlIGlzIGNhbGxlZFxuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHJlc29sdmUobW9kdWxlc1tpZF0gPyBtb2R1bGVzW2lkXS5pbnN0YW5jZSA6IHVuZGVmaW5lZCksIDEwKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTtcbiAgICBcbiAgICBzY3JpcHQuaWQgPSBpZDtcblxuICAgIC8vIEB0cy1pZ25vcmUgZml4IGZvciBJRVxuICAgIGlmIChzY3JpcHQuYXR0YWNoRXZlbnQgJiYgIShzY3JpcHQuYXR0YWNoRXZlbnQudG9TdHJpbmcgJiYgc2NyaXB0LmF0dGFjaEV2ZW50LnRvU3RyaW5nKCkuaW5kZXhPZignW25hdGl2ZSBjb2RlJykgPCAwKSkge1xuICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgc2NyaXB0LmF0dGFjaEV2ZW50KCdvbnJlYWR5c3RhdGVjaGFuZ2UnLCByZWFkeVN0YXRlQ2hhbmdlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgc2NyaXB0LmFkZEV2ZW50TGlzdGVuZXIoJ2xvYWQnLCByZWFkeVN0YXRlQ2hhbmdlLCBmYWxzZSk7XG4gICAgICBzY3JpcHQuYWRkRXZlbnRMaXN0ZW5lcignb25lcnJvcicsIHJlamVjdCwgZmFsc2UpO1xuICAgIH1cblxuICAgIHNjcmlwdC5zZXRBdHRyaWJ1dGUoJ2Nyb3Nzb3JpZ2luJywgJ2Fub255bW91cycpO1xuICAgIHNjcmlwdC5zZXRBdHRyaWJ1dGUoJ2NoYXJzZXQnLCAndXRmLTgnKTtcbiAgICBzY3JpcHQuc2V0QXR0cmlidXRlKCdhc3luYycsICd0cnVlJyk7XG5cbiAgICBzY3JpcHQuc3JjID0gdXJsO1xuXG4gICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChzY3JpcHQpO1xuICB9KTtcbn07XG5cbi8qKlxuICogUmVnaXN0ZXIgdGhhdCBtb2R1bGUgaXMgcmVhZHlcbiAqIFxuICogQHBhcmFtIHtzdHJpbmd9IGlkIFxuICogQHBhcmFtIHthbnl9IGluc3RhbmNlIFxuICogQHBhcmFtIHthbnl9IG1ldGFkYXRhIC0gYWRkaXRpb25hbCBtb2R1bGUgbWV0YWRhdGEgbGlrZSB2ZXJzaW9uXG4gKi9cbmV4cG9ydCBjb25zdCByZWdpc3Rlck1vZHVsZSA9IChpZDogc3RyaW5nLCBpbnN0YW5jZTogYW55LCBtZXRhZGF0YT86IGFueSkgPT4ge1xuICAvLyBsb2FkZXIgbm90IHdvcmtpbmcgb24gbm9kZWpzIGVudnNcbiAgaWYgKHR5cGVvZiB3aW5kb3cgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgaWYgKCFpZCkge1xuICAgIHRocm93IG5ldyBFcnJvcignTW9kdWxlIGlkIGlzIHJlcXVpcmVkJylcbiAgfVxuXG4gIGlmICghbW9kdWxlcykge1xuICAgIHRocm93IG5ldyBFcnJvcignTG9hZGVyIGlzIG5vdCBpbml0aWFsaXplZCcpXG4gIH1cblxuICBpZCA9IE1PRFVMRV9QUkVGSVggKyBpZDtcblxuICBpZiAobW9kdWxlc1tpZF0pIHtcbiAgICBtb2R1bGVzW2lkXSA9IHsgaW5zdGFuY2UsIG1ldGFkYXRhIH1cbiAgfVxufTtcblxuLyoqXG4gKiBMb2FkIGV4dGVybmFsIGNzcyBmcm9tIGdpdmVuIHVybFxuICogXG4gKiBAcGFyYW0geyp9IHVybCBcbiAqL1xuZXhwb3J0IGNvbnN0IGxvYWRDc3MgPSAodXJsKSA9PiB7XG4gIGNvbnN0IGFscmVhZHlBZGRlZFRoaXNUYWcgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGBsaW5rW2hyZWY9XCIke3VybH1cIl1gKTtcbiAgaWYgKGFscmVhZHlBZGRlZFRoaXNUYWcgIT09IG51bGwpIHtcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG4gIH1cblxuICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgICBjb25zdCBoZWFkID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2hlYWQnKVswXTtcbiAgICBjb25zdCBsaW5rID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnbGluaycpO1xuXG4gICAgY29uc3QgbG9hZGVkID0gKCkgPT4ge1xuICAgICAgcmVzb2x2ZSgpO1xuICAgICAgbGluay5yZW1vdmVFdmVudExpc3RlbmVyKCdsb2FkJywgbG9hZGVkKTtcbiAgICB9O1xuXG4gICAgbGluay5yZWwgPSAnc3R5bGVzaGVldCc7XG4gICAgbGluay5ocmVmID0gdXJsO1xuICAgIGxpbmsuYWRkRXZlbnRMaXN0ZW5lcignbG9hZCcsIGxvYWRlZCk7XG4gICAgaGVhZC5hcHBlbmRDaGlsZChsaW5rKTtcbiAgfSk7XG59O1xuXG4vKipcbiAqIEVudW0ganVzdCBmb3IgdW5pZnkgZmlsZXN0YWNrIG1vZHVsZSBuYW1lc1xuICovXG5leHBvcnQgZW51bSBGSUxFU1RBQ0tfTU9EVUxFUyB7XG4gIEZJTEVTVEFDS19TREsgPSAnZmlsZXN0YWNrLXNkaycsXG4gIFRSQU5TRk9STVNfVUkgPSAndHJhbnNmb3Jtcy11aScsXG4gIFBJQ0tFUiA9ICdwaWNrZXInLFxufTtcbiJdfQ==
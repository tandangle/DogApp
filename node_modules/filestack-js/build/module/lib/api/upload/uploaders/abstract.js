import { __extends } from "tslib";
/*
 * Copyright (c) 2019 by Filestack.
 * Some rights reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import Debug from 'debug';
import * as EventEmitter from 'eventemitter3';
import { isMobile } from './../../../utils';
import { FilestackError } from './../../../../filestack_error';
// regular part size
export var DEFAULT_PART_SIZE = 6 * 1024 * 1024;
// Minimum part size for upload by multipart
export var MIN_PART_SIZE = 5 * 1024 * 1024;
// when mode is set to fallback or intelligent, this part size is required
export var INTELLIGENT_CHUNK_SIZE = 8 * 1024 * 1024;
// Mobile Chunk size for ii
export var INTELLIGENT_MOBILE_CHUNK_SIZE = 1024 * 1024;
// minimum intelligent chunk size
export var MIN_CHUNK_SIZE = 32 * 1024;
export var DEFAULT_STORE_LOCATION = 's3';
var debug = Debug('fs:upload:abstract');
var UploaderAbstract = /** @class */ (function (_super) {
    __extends(UploaderAbstract, _super);
    function UploaderAbstract(storeOptions, concurrency) {
        if (concurrency === void 0) { concurrency = 3; }
        var _this = _super.call(this) || this;
        _this.storeOptions = storeOptions;
        _this.concurrency = concurrency;
        // Parts size options
        _this.partSize = DEFAULT_PART_SIZE;
        // chunk size for ii uploads
        _this.intelligentChunkSize = isMobile() ? INTELLIGENT_MOBILE_CHUNK_SIZE : INTELLIGENT_CHUNK_SIZE;
        _this.timeout = 30 * 1000;
        _this.uploadMode = "default" /* DEFAULT */;
        _this.isModeLocked = false; // if account does not support ii in fallback mode we should abort
        _this.integrityCheck = true;
        _this.uploadTags = null;
        return _this;
    }
    UploaderAbstract.prototype.setSecurity = function (security) {
        debug('Set security %O', security);
        this.security = security;
    };
    UploaderAbstract.prototype.setApikey = function (apikey) {
        debug("Set apikey to " + apikey);
        this.apikey = apikey;
    };
    UploaderAbstract.prototype.setTimeout = function (timeout) {
        debug("Set request timeout to " + timeout);
        this.timeout = timeout;
    };
    UploaderAbstract.prototype.setRetryConfig = function (cfg) {
        debug("Set retry config to " + cfg);
        this.retryConfig = cfg;
    };
    UploaderAbstract.prototype.setUrl = function (url) {
        debug("Set upload url to " + url);
        this.url = url;
    };
    UploaderAbstract.prototype.setUploadTags = function (tags) {
        debug("Set tags to %O", tags);
        this.uploadTags = tags;
    };
    /**
     * Set state of checking file integrity
     * @param state
     */
    UploaderAbstract.prototype.setIntegrityCheck = function (state) {
        this.integrityCheck = state;
    };
    /**
     * Sets upload mode
     *
     * @param {UploadMode} mode
     * @param {boolean} [lock=false]
     * @returns
     * @memberof MultipartUploader
     */
    UploaderAbstract.prototype.setUploadMode = function (mode, lock) {
        if (lock === void 0) { lock = false; }
        // this shouldnt happend but for safety reasons if will stay
        /* istanbul ignore next */
        if (this.isModeLocked === true) {
            debug("Cannot switch mode to " + mode + ". Locked! Probably mode is not supported at this apikey");
            return;
        }
        this.isModeLocked = lock;
        debug("Set upload mode to " + mode);
        this.uploadMode = mode;
    };
    /**
     * Set upload part size
     * if part size is smaller than minimum 5mb it will throw error
     *
     * @param {number} size
     * @returns {void}
     * @memberof S3Uploader
     */
    UploaderAbstract.prototype.setPartSize = function (size) {
        if (this.uploadMode !== "default" /* DEFAULT */) {
            debug('Cannot set part size because upload mode is other than default. ');
            return;
        }
        debug("Set part size to " + size);
        if (size < MIN_PART_SIZE) {
            throw new FilestackError('Minimum part size is 5MB');
        }
        this.partSize = size;
    };
    /**
     * Returns current part size
     */
    UploaderAbstract.prototype.getPartSize = function () {
        return this.partSize;
    };
    /**
     * Set start part size for ii
     *
     * @param {number} size
     * @memberof S3Uploader
     */
    UploaderAbstract.prototype.setIntelligentChunkSize = function (size) {
        debug("Set inteligent chunk size to " + size);
        if (size < MIN_CHUNK_SIZE) {
            throw new FilestackError("Minimum intelligent chunk size is " + MIN_CHUNK_SIZE);
        }
        this.intelligentChunkSize = size;
    };
    /**
     * Returns intelligent chunk size
     */
    UploaderAbstract.prototype.getIntelligentChunkSize = function () {
        return this.intelligentChunkSize;
    };
    /**
     * Returns filestack upload url
     *
     * @private
     * @returns
     * @memberof MultipartUploader
     */
    UploaderAbstract.prototype.getUrl = function () {
        if (!this.url) {
            throw new FilestackError('Upload url not set');
        }
        return this.url;
    };
    return UploaderAbstract;
}(EventEmitter));
export { UploaderAbstract };

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9saWIvYXBpL3VwbG9hZC91cGxvYWRlcnMvYWJzdHJhY3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOzs7Ozs7Ozs7Ozs7Ozs7R0FlRztBQUNILE9BQU8sS0FBSyxNQUFNLE9BQU8sQ0FBQztBQUMxQixPQUFPLEtBQUssWUFBWSxNQUFNLGVBQWUsQ0FBQztBQU05QyxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDNUMsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLCtCQUErQixDQUFDO0FBRS9ELG9CQUFvQjtBQUNwQixNQUFNLENBQUMsSUFBTSxpQkFBaUIsR0FBRyxDQUFDLEdBQUcsSUFBSSxHQUFHLElBQUksQ0FBQztBQUVqRCw0Q0FBNEM7QUFDNUMsTUFBTSxDQUFDLElBQU0sYUFBYSxHQUFHLENBQUMsR0FBRyxJQUFJLEdBQUcsSUFBSSxDQUFDO0FBRTdDLDBFQUEwRTtBQUMxRSxNQUFNLENBQUMsSUFBTSxzQkFBc0IsR0FBRyxDQUFDLEdBQUcsSUFBSSxHQUFHLElBQUksQ0FBQztBQUV0RCwyQkFBMkI7QUFDM0IsTUFBTSxDQUFDLElBQU0sNkJBQTZCLEdBQUcsSUFBSSxHQUFHLElBQUksQ0FBQztBQUV6RCxpQ0FBaUM7QUFDakMsTUFBTSxDQUFDLElBQU0sY0FBYyxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUM7QUFFeEMsTUFBTSxDQUFDLElBQU0sc0JBQXNCLEdBQUcsSUFBSSxDQUFDO0FBRTNDLElBQU0sS0FBSyxHQUFHLEtBQUssQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO0FBUTFDO0lBQStDLG9DQUFZO0lBc0J6RCwwQkFBK0IsWUFBZ0MsRUFBcUIsV0FBdUI7UUFBdkIsNEJBQUEsRUFBQSxlQUF1QjtRQUEzRyxZQUNFLGlCQUFPLFNBQ1I7UUFGOEIsa0JBQVksR0FBWixZQUFZLENBQW9CO1FBQXFCLGlCQUFXLEdBQVgsV0FBVyxDQUFZO1FBckIzRyxxQkFBcUI7UUFDWCxjQUFRLEdBQVcs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Q0FBQyxDQUFDO1FBQzlDLElBQUksSUFBSSxHQUFHLGNBQWMsRUFBRTtZQUN6QixNQUFNLElBQUksY0FBYyxDQUFDLHVDQUFxQyxjQUFnQixDQUFDLENBQUM7U0FDakY7UUFDRCxJQUFJLENBQUMsb0JBQW9CLEdBQUcsSUFBSSxDQUFDO0lBQ25DLENBQUM7SUFFRDs7T0FFRztJQUNJLGtEQUF1QixHQUE5QjtRQUNFLE9BQU8sSUFBSSxDQUFDLG9CQUFvQixDQUFDO0lBQ25DLENBQUM7SUFFRDs7Ozs7O09BTUc7SUFDSSxpQ0FBTSxHQUFiO1FBQ0UsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUU7WUFDYixNQUFNLElBQUksY0FBYyxDQUFDLG9CQUFvQixDQUFDLENBQUM7U0FDaEQ7UUFFRCxPQUFPLElBQUksQ0FBQyxHQUFHLENBQUM7SUFDbEIsQ0FBQztJQXlCSCx1QkFBQztBQUFELENBaExBLEFBZ0xDLENBaEw4QyxZQUFZLEdBZ0wxRCIsImZpbGUiOiJsaWIvYXBpL3VwbG9hZC91cGxvYWRlcnMvYWJzdHJhY3QuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogQ29weXJpZ2h0IChjKSAyMDE5IGJ5IEZpbGVzdGFjay5cbiAqIFNvbWUgcmlnaHRzIHJlc2VydmVkLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuaW1wb3J0IERlYnVnIGZyb20gJ2RlYnVnJztcbmltcG9ydCAqIGFzIEV2ZW50RW1pdHRlciBmcm9tICdldmVudGVtaXR0ZXIzJztcblxuaW1wb3J0IHsgRmlsZSwgVXBsb2FkVGFncyB9IGZyb20gJy4vLi4vZmlsZSc7XG5pbXBvcnQgeyBTdG9yZVVwbG9hZE9wdGlvbnMgfSBmcm9tICcuLy4uL3R5cGVzJztcbmltcG9ydCB7IFNlY3VyaXR5IH0gZnJvbSAnLi8uLi8uLi8uLi9jbGllbnQnO1xuaW1wb3J0IHsgRnNSZXRyeUNvbmZpZyB9IGZyb20gJy4vLi4vLi4vLi4vcmVxdWVzdCc7XG5pbXBvcnQgeyBpc01vYmlsZSB9IGZyb20gJy4vLi4vLi4vLi4vdXRpbHMnO1xuaW1wb3J0IHsgRmlsZXN0YWNrRXJyb3IgfSBmcm9tICcuLy4uLy4uLy4uLy4uL2ZpbGVzdGFja19lcnJvcic7XG5cbi8vIHJlZ3VsYXIgcGFydCBzaXplXG5leHBvcnQgY29uc3QgREVGQVVMVF9QQVJUX1NJWkUgPSA2ICogMTAyNCAqIDEwMjQ7XG5cbi8vIE1pbmltdW0gcGFydCBzaXplIGZvciB1cGxvYWQgYnkgbXVsdGlwYXJ0XG5leHBvcnQgY29uc3QgTUlOX1BBUlRfU0laRSA9IDUgKiAxMDI0ICogMTAyNDtcblxuLy8gd2hlbiBtb2RlIGlzIHNldCB0byBmYWxsYmFjayBvciBpbnRlbGxpZ2VudCwgdGhpcyBwYXJ0IHNpemUgaXMgcmVxdWlyZWRcbmV4cG9ydCBjb25zdCBJTlRFTExJR0VOVF9DSFVOS19TSVpFID0gOCAqIDEwMjQgKiAxMDI0O1xuXG4vLyBNb2JpbGUgQ2h1bmsgc2l6ZSBmb3IgaWlcbmV4cG9ydCBjb25zdCBJTlRFTExJR0VOVF9NT0JJTEVfQ0hVTktfU0laRSA9IDEwMjQgKiAxMDI0O1xuXG4vLyBtaW5pbXVtIGludGVsbGlnZW50IGNodW5rIHNpemVcbmV4cG9ydCBjb25zdCBNSU5fQ0hVTktfU0laRSA9IDMyICogMTAyNDtcblxuZXhwb3J0IGNvbnN0IERFRkFVTFRfU1RPUkVfTE9DQVRJT04gPSAnczMnO1xuXG5jb25zdCBkZWJ1ZyA9IERlYnVnKCdmczp1cGxvYWQ6YWJzdHJhY3QnKTtcblxuZXhwb3J0IGNvbnN0IGVudW0gVXBsb2FkTW9kZSB7XG4gIERFRkFVTFQgPSAnZGVmYXVsdCcsXG4gIElOVEVMTElHRU5UID0gJ2ludGVsbGlnZW50JyxcbiAgRkFMTEJBQ0sgPSAnZmFsbGJhY2snLFxufVxuXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgVXBsb2FkZXJBYnN0cmFjdCBleHRlbmRzIEV2ZW50RW1pdHRlciB7XG4gIC8vIFBhcnRzIHNpemUgb3B0aW9uc1xuICBwcm90ZWN0ZWQgcGFydFNpemU6IG51bWJlciA9IERFRkFVTFRfUEFSVF9TSVpFO1xuXG4gIC8vIGNodW5rIHNpemUgZm9yIGlpIHVwbG9hZHNcbiAgcHJvdGVjdGVkIGludGVsbGlnZW50Q2h1bmtTaXplOiBudW1iZXIgPSBpc01vYmlsZSgpID8gSU5URUxMSUdFTlRfTU9CSUxFX0NIVU5LX1NJWkUgOiBJTlRFTExJR0VOVF9DSFVOS19TSVpFO1xuXG4gIC8vIHVwbG9hZCBvcHRpb25zXG4gIHByb3RlY3RlZCB1cmw6IHN0cmluZztcbiAgcHJvdGVjdGVkIHRpbWVvdXQ6IG51bWJlciA9IDMwICogMTAwMDtcbiAgcHJvdGVjdGVkIHVwbG9hZE1vZGU6IFVwbG9hZE1vZGUgPSBVcGxvYWRNb2RlLkRFRkFVTFQ7XG5cbiAgLy8gYXBwbGljYXRpb24gc2V0dGluZ3NcbiAgcHJvdGVjdGVkIGFwaWtleTogc3RyaW5nO1xuICBwcm90ZWN0ZWQgc2VjdXJpdHk6IFNlY3VyaXR5O1xuXG4gIHByb3RlY3RlZCBpc01vZGVMb2NrZWQ6IGJvb2xlYW4gPSBmYWxzZTsgLy8gaWYgYWNjb3VudCBkb2VzIG5vdCBzdXBwb3J0IGlpIGluIGZhbGxiYWNrIG1vZGUgd2Ugc2hvdWxkIGFib3J0XG4gIHByb3RlY3RlZCByZXRyeUNvbmZpZzogRnNSZXRyeUNvbmZpZztcbiAgcHJvdGVjdGVkIGludGVncml0eUNoZWNrOiBib29sZWFuID0gdHJ1ZTtcblxuICBwcm90ZWN0ZWQgdXBsb2FkVGFnczogVXBsb2FkVGFncyA9IG51bGw7XG5cbiAgY29uc3RydWN0b3IocHJvdGVjdGVkIHJlYWRvbmx5IHN0b3JlT3B0aW9uczogU3RvcmVVcGxvYWRPcHRpb25zLCBwcm90ZWN0ZWQgcmVhZG9ubHkgY29uY3VycmVuY3k6IG51bWJlciA9IDMpIHtcbiAgICBzdXBlcigpO1xuICB9XG5cbiAgcHVibGljIHNldFNlY3VyaXR5KHNlY3VyaXR5OiBTZWN1cml0eSk6IHZvaWQge1xuICAgIGRlYnVnKCdTZXQgc2VjdXJpdHkgJU8nLCBzZWN1cml0eSk7XG4gICAgdGhpcy5zZWN1cml0eSA9IHNlY3VyaXR5O1xuICB9XG5cbiAgcHVibGljIHNldEFwaWtleShhcGlrZXk6IHN0cmluZyk6IHZvaWQge1xuICAgIGRlYnVnKGBTZXQgYXBpa2V5IHRvICR7YXBpa2V5fWApO1xuICAgIHRoaXMuYXBpa2V5ID0gYXBpa2V5O1xuICB9XG5cbiAgcHVibGljIHNldFRpbWVvdXQodGltZW91dDogbnVtYmVyKTogdm9pZCB7XG4gICAgZGVidWcoYFNldCByZXF1ZXN0IHRpbWVvdXQgdG8gJHt0aW1lb3V0fWApO1xuICAgIHRoaXMudGltZW91dCA9IHRpbWVvdXQ7XG4gIH1cblxuICBwdWJsaWMgc2V0UmV0cnlDb25maWcoY2ZnOiBGc1JldHJ5Q29uZmlnKSB7XG4gICAgZGVidWcoYFNldCByZXRyeSBjb25maWcgdG8gJHtjZmd9YCk7XG4gICAgdGhpcy5yZXRyeUNvbmZpZyA9IGNmZztcbiAgfVxuXG4gIHB1YmxpYyBzZXRVcmwodXJsOiBzdHJpbmcpOiB2b2lkIHtcbiAgICBkZWJ1ZyhgU2V0IHVwbG9hZCB1cmwgdG8gJHt1cmx9YCk7XG4gICAgdGhpcy51cmwgPSB1cmw7XG4gIH1cblxuICBwdWJsaWMgc2V0VXBsb2FkVGFncyh0YWdzOiBVcGxvYWRUYWdzKSB7XG4gICAgZGVidWcoYFNldCB0YWdzIHRvICVPYCwgdGFncyk7XG4gICAgdGhpcy51cGxvYWRUYWdzID0gdGFncztcbiAgfVxuXG4gIC8qKlxuICAgKiBTZXQgc3RhdGUgb2YgY2hlY2tpbmcgZmlsZSBpbnRlZ3JpdHlcbiAgICogQHBhcmFtIHN0YXRlXG4gICAqL1xuICBwdWJsaWMgc2V0SW50ZWdyaXR5Q2hlY2soc3RhdGUpIHtcbiAgICB0aGlzLmludGVncml0eUNoZWNrID0gc3RhdGU7XG4gIH1cblxuICAvKipcbiAgICogU2V0cyB1cGxvYWQgbW9kZVxuICAgKlxuICAgKiBAcGFyYW0ge1VwbG9hZE1vZGV9IG1vZGVcbiAgICogQHBhcmFtIHtib29sZWFufSBbbG9jaz1mYWxzZV1cbiAgICogQHJldHVybnNcbiAgICogQG1lbWJlcm9mIE11bHRpcGFydFVwbG9hZGVyXG4gICAqL1xuICBwdWJsaWMgc2V0VXBsb2FkTW9kZShtb2RlOiBVcGxvYWRNb2RlLCBsb2NrOiBib29sZWFuID0gZmFsc2UpOiB2b2lkIHtcbiAgICAvLyB0aGlzIHNob3VsZG50IGhhcHBlbmQgYnV0IGZvciBzYWZldHkgcmVhc29ucyBpZiB3aWxsIHN0YXlcbiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqL1xuICAgIGlmICh0aGlzLmlzTW9kZUxvY2tlZCA9PT0gdHJ1ZSkge1xuICAgICAgZGVidWcoYENhbm5vdCBzd2l0Y2ggbW9kZSB0byAke21vZGV9LiBMb2NrZWQhIFByb2JhYmx5IG1vZGUgaXMgbm90IHN1cHBvcnRlZCBhdCB0aGlzIGFwaWtleWApO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHRoaXMuaXNNb2RlTG9ja2VkID0gbG9jaztcblxuICAgIGRlYnVnKGBTZXQgdXBsb2FkIG1vZGUgdG8gJHttb2RlfWApO1xuXG4gICAgdGhpcy51cGxvYWRNb2RlID0gbW9kZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZXQgdXBsb2FkIHBhcnQgc2l6ZVxuICAgKiBpZiBwYXJ0IHNpemUgaXMgc21hbGxlciB0aGFuIG1pbmltdW0gNW1iIGl0IHdpbGwgdGhyb3cgZXJyb3JcbiAgICpcbiAgICogQHBhcmFtIHtudW1iZXJ9IHNpemVcbiAgICogQHJldHVybnMge3ZvaWR9XG4gICAqIEBtZW1iZXJvZiBTM1VwbG9hZGVyXG4gICAqL1xuICBwdWJsaWMgc2V0UGFydFNpemUoc2l6ZTogbnVtYmVyKTogdm9pZCB7XG4gICAgaWYgKHRoaXMudXBsb2FkTW9kZSAhPT0gVXBsb2FkTW9kZS5ERUZBVUxUKSB7XG4gICAgICBkZWJ1ZygnQ2Fubm90IHNldCBwYXJ0IHNpemUgYmVjYXVzZSB1cGxvYWQgbW9kZSBpcyBvdGhlciB0aGFuIGRlZmF1bHQuICcpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGRlYnVnKGBTZXQgcGFydCBzaXplIHRvICR7c2l6ZX1gKTtcblxuICAgIGlmIChzaXplIDwgTUlOX1BBUlRfU0laRSkge1xuICAgICAgdGhyb3cgbmV3IEZpbGVzdGFja0Vycm9yKCdNaW5pbXVtIHBhcnQgc2l6ZSBpcyA1TUInKTtcbiAgICB9XG5cbiAgICB0aGlzLnBhcnRTaXplID0gc2l6ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIGN1cnJlbnQgcGFydCBzaXplXG4gICAqL1xuICBwdWJsaWMgZ2V0UGFydFNpemUoKSB7XG4gICAgcmV0dXJuIHRoaXMucGFydFNpemU7XG4gIH1cblxuICAvKipcbiAgICogU2V0IHN0YXJ0IHBhcnQgc2l6ZSBmb3IgaWlcbiAgICpcbiAgICogQHBhcmFtIHtudW1iZXJ9IHNpemVcbiAgICogQG1lbWJlcm9mIFMzVXBsb2FkZXJcbiAgICovXG4gIHB1YmxpYyBzZXRJbnRlbGxpZ2VudENodW5rU2l6ZShzaXplOiBudW1iZXIpOiB2b2lkIHtcbiAgICBkZWJ1ZyhgU2V0IGludGVsaWdlbnQgY2h1bmsgc2l6ZSB0byAke3NpemV9YCk7XG4gICAgaWYgKHNpemUgPCBNSU5fQ0hVTktfU0laRSkge1xuICAgICAgdGhyb3cgbmV3IEZpbGVzdGFja0Vycm9yKGBNaW5pbXVtIGludGVsbGlnZW50IGNodW5rIHNpemUgaXMgJHtNSU5fQ0hVTktfU0laRX1gKTtcbiAgICB9XG4gICAgdGhpcy5pbnRlbGxpZ2VudENodW5rU2l6ZSA9IHNpemU7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyBpbnRlbGxpZ2VudCBjaHVuayBzaXplXG4gICAqL1xuICBwdWJsaWMgZ2V0SW50ZWxsaWdlbnRDaHVua1NpemUoKTogbnVtYmVyIHtcbiAgICByZXR1cm4gdGhpcy5pbnRlbGxpZ2VudENodW5rU2l6ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIGZpbGVzdGFjayB1cGxvYWQgdXJsXG4gICAqXG4gICAqIEBwcml2YXRlXG4gICAqIEByZXR1cm5zXG4gICAqIEBtZW1iZXJvZiBNdWx0aXBhcnRVcGxvYWRlclxuICAgKi9cbiAgcHVibGljIGdldFVybCgpOiBzdHJpbmcge1xuICAgIGlmICghdGhpcy51cmwpIHtcbiAgICAgIHRocm93IG5ldyBGaWxlc3RhY2tFcnJvcignVXBsb2FkIHVybCBub3Qgc2V0Jyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMudXJsO1xuICB9XG5cbiAgLyoqXG4gICAqIFBhdXNlIHVwbG9hZCBxdWV1ZVxuICAgKlxuICAgKiBAbWVtYmVyb2YgTXVsdGlwYXJ0VXBsb2FkZXJcbiAgICovXG4gIHB1YmxpYyBhYnN0cmFjdCBwYXVzZSgpOiB2b2lkO1xuICAvKipcbiAgICogcmVzdW1lIHVwbG9hZCBxdWV1ZSBpZiBpdHMgcGF1c2VkXG4gICAqXG4gICAqIEBtZW1iZXJvZiBNdWx0aXBhcnRVcGxvYWRlclxuICAgKi9cbiAgcHVibGljIGFic3RyYWN0IHJlc3VtZSgpOiB2b2lkO1xuXG4gIC8qKlxuICAgKiBBYm9ydHMgcXVldWUgKGFsbCBwZW5kaW5nIHJlcXVlc3RzIHdpdGggd2lsbCBiZSBhYm9ydGVkKVxuICAgKlxuICAgKiBAbWVtYmVyb2YgTXVsdGlwYXJ0VXBsb2FkZXJcbiAgICovXG4gIHB1YmxpYyBhYnN0cmFjdCBhYm9ydChtc2c/OiBzdHJpbmcpOiB2b2lkO1xuXG4gIHB1YmxpYyBhYnN0cmFjdCBhZGRGaWxlKGZpbGU6IEZpbGUpOiBzdHJpbmc7XG5cbiAgcHVibGljIGFic3RyYWN0IGFzeW5jIGV4ZWN1dGUoKTogUHJvbWlzZTxhbnk+O1xufVxuIl19

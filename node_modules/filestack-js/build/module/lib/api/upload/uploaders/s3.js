/*
 * Copyright (c) 2019 by Filestack.
 * Some rights reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { __assign, __awaiter, __extends, __generator } from "tslib";
import PQueue from 'p-queue';
import Debug from 'debug';
import { FsRequest, FsCancelToken } from './../../../request';
import { uniqueTime, uniqueId, filterObject } from './../../../utils';
import { UploaderAbstract, INTELLIGENT_CHUNK_SIZE, MIN_CHUNK_SIZE, DEFAULT_STORE_LOCATION } from './abstract';
import { FilestackError, FilestackErrorType } from './../../../../filestack_error';
import { shouldRetry } from './../../../request/helpers';
var debug = Debug('fs:upload:s3');
var COMPLETE_TIMEOUT = 1000 * 1;
var S3Uploader = /** @class */ (function (_super) {
    __extends(S3Uploader, _super);
    function S3Uploader(storeOptions, concurrency) {
        var _this = _super.call(this, storeOptions, concurrency) || this;
        _this.payloads = {};
        _this.partsQueue = new PQueue({
            autoStart: false,
            concurrency: _this.concurrency,
        });
        _this.cancelToken = new FsCancelToken();
        return _this;
    }
    /**
     * Pause upload queue
     *
     * @memberof S3Uploader
     */
    S3Uploader.prototype.pause = function () {
        this.partsQueue.pause();
    };
    /**
     * resume upload queue if its paused
     *
     * @memberof S3Uploader
     */
    S3Uploader.prototype.resume = function () {
        /* istanbul ignore next */
        if (this.partsQueue.isPaused) {
            this.partsQueue.start();
        }
    };
    /**
     * Aborts queue (all pending requests with will be aborted)
     *
     * @memberof S3Uploader
     */
    S3Uploader.prototype.abort = function (msg) {
        this.cancelToken.cancel(msg || 'Aborted by user');
        this.partsQueue.clear();
    };
    /**
     * Execute all queued files
     *
     * @returns {Promise<any>}
     * @memberof S3Uploader
     */
    S3Uploader.prototype.execute = function () {
        return __awaiter(this, void 0, void 0, function () {
            var tasks;
            var _this = this;
            return __generator(this, function (_a) {
                tasks = Object.keys(this.payloads).map(function (id) {
                    return new Promise(function (resolve) { return __awaiter(_this, void 0, void 0, function () {
                        var e_1, file;
                        return __generator(this, function (_a) {
                            switch (_a.label) {
                                case 0:
                                    _a.trys.push([0, 5, , 6]);
                                    return [4 /*yield*/, this.startRequest(id)];
                                case 1:
                                    _a.sent();
                                    return [4 /*yield*/, this.prepareParts(id)];
                                case 2:
                                    _a.sent();
                                    return [4 /*yield*/, this.startPartsQueue(id)];
                                case 3:
                                    _a.sent();
                                    return [4 /*yield*/, this.completeRequest(id)];
                                case 4:
                                    _a.sent();
                                    return [3 /*break*/, 6];
                                case 5:
                                    e_1 = _a.sent();
                                    /* istanbul ignore next */
                                    this.emit('error', e_1);
                                    debug("[" + id + "] File upload failed. %O, \nDetails: %O ", e_1.message, e_1.details);
                                    return [3 /*break*/, 6];
                                case 6:
                                    file = this.getPayloadById(id).file;
                                    // release file buffer
                                    file.release();
                                    // cleanup payloads
                                    delete this.payloads[id];
                                    resolve(file);
                                    return [2 /*return*/];
                            }
                        });
                    }); });
                });
                return [2 /*return*/, Promise.all(tasks)];
            });
        });
    };
    /**
     * Add file to upload queue
     *
     * @param {File} file
     * @returns
     * @memberof S3Uploader
     */
    S3Uploader.prototype.addFile = function (file) {
        debug('Add file to queue: \n %o', file);
        var id = uniqueId(15) + "_" + uniqueTime();
        file.status = "Initialized" /* INIT */;
        // split file into parts and set it as waiting
        this.payloads[id] = {
            file: file,
            parts: [],
        };
        return id;
    };
    /**
     * Returns host for upload (region based)
     *
     * @private
     * @returns
     * @memberof S3Uploader
     */
    S3Uploader.prototype.getUploadUrl = function (id) {
        var location_url = this.getDefaultFields(id, ['location_url']).location_url;
        return location_url.indexOf('http') === 0 ? location_url : "https://" + location_url;
    };
    /**
     * Returns formatted store options
     *
     * @private
     * @returns
     * @memberof S3Uploader
     */
    S3Uploader.prototype.getStoreOptions = function (id) {
        var options = __assign({ location: DEFAULT_STORE_LOCATION }, this.storeOptions);
        if (this.storeOptions.disableStorageKey) {
            var payload = this.getPayloadById(id);
            if (options.path && options.path.substr(-1) !== '/') {
                options.path = options.path + "/";
            }
            options.path = "" + (options.path ? options.path : '/') + payload.file.name;
            delete options.disableStorageKey;
        }
        return options;
    };
    /**
     * Returns all default fields for filestack requests
     *
     * @private
     * @returns
     * @memberof S3Uploader
     */
    S3Uploader.prototype.getDefaultFields = function (id, requiredFields, fiiFallback) {
        if (fiiFallback === void 0) { fiiFallback = false; }
        var payload = this.getPayloadById(id);
        var fields = __assign(__assign({}, this.security), { apikey: this.apikey, uri: payload.uri, location_url: payload.location_url, upload_id: payload.upload_id, region: payload.region });
        if (this.uploadMode === "intelligent" /* INTELLIGENT */ || (this.uploadMode === "fallback" /* FALLBACK */ && fiiFallback)) {
            fields['fii'] = true;
        }
        return __assign(__assign({}, filterObject(fields, requiredFields)), { store: this.getStoreOptions(id) });
    };
    /**
     * Returns default headers needed for filestack request
     *
     * @private
     * @returns
     * @memberof S3Uploader
     */
    S3Uploader.prototype.getDefaultHeaders = function (id) {
        var headers = {};
        var file = this.getPayloadById(id);
        if (file.location_region) {
            headers['Filestack-Upload-Region'] = file.location_region;
        }
        return headers;
    };
    S3Uploader.prototype.getPayloadById = function (id) {
        return this.payloads[id];
    };
    /**
     * Split file onto parts for uploading with multipart mechanism and setup start
     *
     * @private
     * @memberof S3Uploader
     */
    S3Uploader.prototype.prepareParts = function (id) {
        var file = this.getPayloadById(id).file;
        // for intelligent or fallback mode we cant overwrite part size - requires 8MB
        if (["intelligent" /* INTELLIGENT */, "fallback" /* FALLBACK */].indexOf(this.uploadMode) > -1) {
            this.partSize = INTELLIGENT_CHUNK_SIZE;
        }
        var partsCount = file.getPartsCount(this.partSize);
        var parts = [];
        for (var i = 0; i < partsCount; i++) {
            parts[i] = __assign(__assign({}, file.getPartMetadata(i, this.partSize)), { offset: 0 });
        }
        // split file into parts and set it as waiting
        this.payloads[id].parts = parts;
        return Promise.resolve();
    };
    /**
     * Make start request for getting needed upload fields
     *
     * @private
     * @returns {Promise<any>}
     * @memberof S3Uploader
     */
    S3Uploader.prototype.startRequest = function (id) {
        var _this = this;
        var payload = this.getPayloadById(id);
        if (payload.file.size === 0) {
            this.setPayloadStatus(id, "Failed" /* FAILED */);
            return Promise.reject(new FilestackError("Invalid file \"" + payload.file.name + "\" size - 0", {}, FilestackErrorType.VALIDATION));
        }
        debug("[" + id + "] Make start request");
        return FsRequest.post(this.getUrl() + "/multipart/start", __assign({ filename: payload.file.name, mimetype: payload.file.type, size: payload.file.size }, this.getDefaultFields(id, ['apikey', 'policy', 'signature', 'fii'], true)), {
            timeout: this.timeout,
            cancelToken: this.cancelToken,
            headers: this.getDefaultHeaders(id),
            retry: this.retryConfig,
        })
            .then(function (_a) {
            var data = _a.data;
            if (!data || !data.location_url || !data.region || !data.upload_id || !data.uri) {
                debug("[" + id + "] Incorrect start response: \n%O\n", data);
                _this.setPayloadStatus(id, "Failed" /* FAILED */);
                return Promise.reject(new FilestackError('Incorrect start response', data, FilestackErrorType.REQUEST));
            }
            debug("[" + id + "] Assign payload data: \n%O\n", data);
            _this.updatePayload(id, data);
            // ii is not enabled in backend switch back to default upload mode
            if (["intelligent" /* INTELLIGENT */, "fallback" /* FALLBACK */].indexOf(_this.uploadMode) > -1 && (!data.upload_type || data.upload_type !== 'intelligent_ingestion')) {
                debug("[" + id + "] Intelligent Ingestion is not enabled on account, switch back to regular upload and lock mode change");
                _this.setUploadMode("default" /* DEFAULT */, true);
            }
            return data;
        })
            .catch(function (err) {
            debug("[" + id + "] Start request error %O", err);
            _this.setPayloadStatus(id, "Failed" /* FAILED */);
            return Promise.reject(new FilestackError('Cannot upload file. Start request failed', _this.getErrorDetails(err), FilestackErrorType.REQUEST));
        });
    };
    /**
     * Enqueue file parts to upload
     *
     * @private
     * @returns
     * @memberof S3Uploader
     */
    S3Uploader.prototype.startPartsQueue = function (id) {
        return __awaiter(this, void 0, void 0, function () {
            var payload, parts, waitingLength;
            var _this = this;
            return __generator(this, function (_a) {
                payload = this.getPayloadById(id);
                parts = payload.parts;
                waitingLength = parts.length;
                debug("[" + id + "] Create uploading queue from file. parts count - %d", waitingLength);
                return [2 /*return*/, new Promise(function (resolve, reject) { return __awaiter(_this, void 0, void 0, function () {
                        var _a;
                        var _this = this;
                        return __generator(this, function (_b) {
                            switch (_b.label) {
                                case 0:
                                    parts.forEach(function (part) {
                                        return _this.partsQueue
                                            .add(function () { return _this.startPart(id, part.partNumber); })
                                            .catch(function (e) {
                                            _this.setPayloadStatus(id, "Failed" /* FAILED */);
                                            debug("[" + id + "] Failed to upload part %s", e.message);
                                            _this.partsQueue.pause();
                                            _this.partsQueue.clear();
                                            return reject(e);
                                        });
                                    });
                                    debug("[" + id + "] All tasks for %s enqueued. Start processing main upload queue", id);
                                    this.partsQueue.start();
                                    _a = resolve;
                                    return [4 /*yield*/, this.partsQueue.onIdle()];
                                case 1:
                                    _a.apply(void 0, [_b.sent()]);
                                    return [2 /*return*/];
                            }
                        });
                    }); })];
            });
        });
    };
    /**
     * Decide if upload should be made using ii or regular upload
     * It allows change upload mode during upload queue
     *
     * @private
     * @param {number} partNumber
     * @returns {Promise<any>}
     * @memberof S3Uploader
     */
    S3Uploader.prototype.startPart = function (id, partNumber) {
        debug("[" + id + "] Start processing part " + partNumber + " with mode " + this.uploadMode);
        var payload = this.getPayloadById(id);
        payload.file.status = "Progress" /* PROGRESS */;
        return (this.uploadMode !== "intelligent" /* INTELLIGENT */ ? this.uploadRegular : this.uploadIntelligent).apply(this, [id, partNumber]);
    };
    /**
     * Returns part data needed for upload
     *
     * @private
     * @param {string} id - id of a currently uploading file
     * @param {FilePart} part
     * @returns
     * @memberof S3Uploader
     */
    S3Uploader.prototype.getS3PartMetadata = function (id, part, offset) {
        var _this = this;
        var url = this.getUploadUrl(id);
        debug("[" + id + "] Get data for part " + part.partNumber + ", url " + url + ", Md5: " + part.md5 + ", Size: " + part.size);
        var data = __assign(__assign({}, this.getDefaultFields(id, ['apikey', 'uri', 'region', 'signature', 'policy', 'upload_id', 'fii'])), { 
            // method specific keys
            part: part.partNumber + 1, size: part.size, offset: offset });
        if (this.integrityCheck && part.md5) {
            data.md5 = part.md5;
        }
        return FsRequest.post(url + "/multipart/upload", data, {
            headers: this.getDefaultHeaders(id),
            cancelToken: this.cancelToken,
            timeout: this.timeout,
            retry: this.retryConfig,
        }).catch(function (err) {
            _this.setPayloadStatus(id, "Failed" /* FAILED */);
            return Promise.reject(new FilestackError('Cannot get part metadata', _this.getErrorDetails(err), FilestackErrorType.REQUEST));
        });
    };
    /**
     * Regular multipart request to amazon
     *
     * @private
     * @param {number} partNumber
     * @returns {Promise<any>}
     * @memberof S3Uploader
     */
    S3Uploader.prototype.uploadRegular = function (id, partNumber) {
        return __awaiter(this, void 0, void 0, function () {
            var payload, partMetadata, part, _a, data, headers;
            var _this = this;
            return __generator(this, function (_b) {
                switch (_b.label) {
                    case 0:
                        payload = this.getPayloadById(id);
                        partMetadata = payload.parts[partNumber];
                        return [4 /*yield*/, payload.file.getPartByMetadata(partMetadata, this.integrityCheck)];
                    case 1:
                        part = _b.sent();
                        return [4 /*yield*/, this.getS3PartMetadata(id, part)];
                    case 2:
                        _a = _b.sent(), data = _a.data, headers = _a.headers;
                        debug("[" + id + "] Received part " + partNumber + " info body: \n%O\n headers: \n%O\n", data, headers);
                        return [2 /*return*/, FsRequest.put(data.url, part.buffer, {
                                cancelToken: this.cancelToken,
                                timeout: this.timeout,
                                headers: data.headers,
                                filestackHeaders: false,
                                // for now we cant test progress callback from upload
                                /* istanbul ignore next */
                                onProgress: function (pr) { return _this.onProgressUpdate(id, partNumber, pr.loaded); },
                                retry: this.retryConfig && this.uploadMode !== "fallback" /* FALLBACK */ ? this.retryConfig : undefined,
                            })
                                .then(function (res) {
                                if (res.headers.etag) {
                                    _this.setPartETag(id, partNumber, res.headers.etag);
                                }
                                else {
                                    // release memory
                                    part = null;
                                    throw new FilestackError('Cannot upload file, check S3 bucket settings', 'Etag header is not exposed in CORS settings', FilestackErrorType.REQUEST);
                                }
                                debug("[" + id + "] S3 Upload response headers for " + partNumber + ": \n%O\n", res.headers);
                                _this.onProgressUpdate(id, partNumber, part.size);
                                // release memory
                                part = null;
                                return res;
                            })
                                .catch(function (err) {
                                var resp = err && err.response ? err.response : null;
                                /* istanbul ignore next */
                                if (resp && resp.status === 403) {
                                    if (resp.data && resp.data.Error && resp.data.Error.code) {
                                        var code = resp.data.Error.code;
                                        if (Array.isArray(code)) {
                                            code = code.pop();
                                        }
                                        switch (code) {
                                            case 'RequestTimeTooSkewed':
                                                return _this.startPart(id, partNumber);
                                            default:
                                                return Promise.reject(new FilestackError('Cannot upload file', resp.data.Error, FilestackErrorType.REQUEST));
                                        }
                                    }
                                }
                                // release memory
                                part = null;
                                if (err instanceof FilestackError) {
                                    return Promise.reject(err);
                                }
                                // reset upload progress on failed part
                                _this.onProgressUpdate(id, partNumber, 0);
                                // if fallback, set upload mode to intelligent and restart current part
                                if ((_this.uploadMode === "fallback" /* FALLBACK */ && !_this.isModeLocked) || _this.uploadMode === "intelligent" /* INTELLIGENT */) {
                                    debug("[" + id + "] Regular upload failed. Switching to intelligent ingestion mode");
                                    _this.setUploadMode("intelligent" /* INTELLIGENT */);
                                    // restart part
                                    return _this.startPart(id, partNumber);
                                }
                                return Promise.reject(new FilestackError('Cannot upload file part', _this.getErrorDetails(err), FilestackErrorType.REQUEST));
                            })];
                }
            });
        });
    };
    /**
     * Upload file using intelligent mechanism
     *
     * @private
     * @param {string} id
     * @param {number} partNumber
     * @returns {Promise<any>}
     * @memberof S3Uploader
     */
    S3Uploader.prototype.uploadIntelligent = function (id, partNumber) {
        return __awaiter(this, void 0, void 0, function () {
            var _this = this;
            return __generator(this, function (_a) {
                return [2 /*return*/, this.uploadNextChunk(id, partNumber).then(function () { return _this.commitPart(id, partNumber); })];
            });
        });
    };
    /**
     * Recursively upload file in chunk mode (intelligent ingession)
     *
     * @private
     * @param {string} id
     * @param {number} partNumber
     * @param {number} chunkSize
     * @returns
     * @memberof S3Uploader
     */
    S3Uploader.prototype.uploadNextChunk = function (id, partNumber, chunkSize) {
        if (chunkSize === void 0) { chunkSize = this.intelligentChunkSize; }
        return __awaiter(this, void 0, void 0, function () {
            var payload, part, chunk, data;
            var _this = this;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        payload = this.getPayloadById(id);
                        part = payload.parts[partNumber];
                        chunkSize = Math.min(chunkSize, part.size - part.offset);
                        return [4 /*yield*/, payload.file.getChunkByMetadata(part, part.offset, chunkSize, this.integrityCheck)];
                    case 1:
                        chunk = _a.sent();
                        debug("[" + id + "] PartNum: " + partNumber + ", PartSize: " + part.size + ", StartByte: " + part.startByte + ", Offset: " + part.offset + ", ChunkSize: " + chunk.size + ",\n       Left: " + (part.size - part.offset - chunk.size));
                        return [4 /*yield*/, this.getS3PartMetadata(id, chunk, part.offset).catch(function (err) {
                                debug("[" + id + "] Getting chunk data for ii failed %O, Chunk size: " + chunkSize + ", offset " + part.offset + ", part " + partNumber, err);
                                return Promise.reject(err);
                            })];
                    case 2:
                        data = (_a.sent()).data;
                        return [2 /*return*/, FsRequest.put(data.url, chunk.buffer, {
                                cancelToken: this.cancelToken,
                                timeout: this.timeout,
                                headers: data.headers,
                                filestackHeaders: false,
                                // for now we cant test progress callback from upload
                                /* istanbul ignore next */
                                onProgress: function (pr) { return _this.onProgressUpdate(id, partNumber, part.offset + pr.loaded); },
                            })
                                .then(function (res) {
                                _this.onProgressUpdate(id, partNumber, part.offset + chunk.size);
                                var newOffset = Math.min(part.offset + chunkSize, part.size);
                                debug("[" + id + "] S3 Chunk uploaded! offset: " + part.offset + ", part " + partNumber + "! response headers for " + partNumber + ": \n%O\n", res.headers);
                                _this.setPartData(id, partNumber, 'offset', newOffset);
                                // if all chunks was uploaded then return resolve
                                if (newOffset === part.size) {
                                    return Promise.resolve(res);
                                }
                                // release memory
                                part = null;
                                chunk = null;
                                return _this.uploadNextChunk(id, partNumber, chunkSize);
                            })
                                .catch(function (err) {
                                var resp = err && err.response ? err.response : null;
                                /* istanbul ignore next */
                                if (resp && resp.status === 403) {
                                    if (resp.data && resp.data.Error && resp.data.Error.code) {
                                        var code = resp.data.Error.code;
                                        if (Array.isArray(code)) {
                                            code = code.pop();
                                        }
                                        switch (code) {
                                            case 'RequestTimeTooSkewed':
                                                return _this.startPart(id, partNumber);
                                            default:
                                                return Promise.reject(new FilestackError('Cannot upload file', resp.data.Error, FilestackErrorType.REQUEST));
                                        }
                                    }
                                }
                                // reset progress on failed upload
                                _this.onProgressUpdate(id, partNumber, part.offset);
                                var nextChunkSize = chunkSize / 2;
                                if (nextChunkSize < MIN_CHUNK_SIZE) {
                                    debug("[" + id + "] Minimal chunk size limit. Upload file failed!");
                                    return Promise.reject(new FilestackError('Min chunk size reached', err.data, FilestackErrorType.REQUEST));
                                }
                                if (shouldRetry(err)) {
                                    debug("[" + id + "] Request network error. Retry with new chunk size: " + nextChunkSize);
                                    return _this.uploadNextChunk(id, partNumber, nextChunkSize);
                                }
                                // release memory
                                part = null;
                                chunk = null;
                                return Promise.reject(new FilestackError('Cannot upload file part (FII)', _this.getErrorDetails(err), FilestackErrorType.REQUEST));
                            })];
                }
            });
        });
    };
    /**
     * Commit after upload all chunks of the part in ii mode
     *
     * @private
     * @param {string} id
     * @param {FilePart} part
     * @returns
     * @memberof S3Uploader
     */
    S3Uploader.prototype.commitPart = function (id, partNumber) {
        var _this = this;
        var payload = this.getPayloadById(id);
        var part = payload.parts[partNumber];
        return FsRequest.post(this.getUploadUrl(id) + "/multipart/commit", __assign(__assign({}, this.getDefaultFields(id, ['apikey', 'region', 'upload_id', 'policy', 'signature', 'uri'])), { size: payload.file.size, part: part.partNumber + 1 }), {
            cancelToken: this.cancelToken,
            timeout: this.timeout,
            headers: this.getDefaultHeaders(id),
            retry: this.retryConfig,
        })
            .then(function (res) {
            debug("[" + id + "] Commit Part number " + part.partNumber + ". Response: %O", res.data);
            return res;
        })
            .catch(function (err) {
            return Promise.reject(new FilestackError('Cannot commit file part metadata', _this.getErrorDetails(err), FilestackErrorType.REQUEST));
        });
    };
    /**
     * Complete request to merge all parts and get file handle etc
     *
     * @private
     * @returns
     * @memberof S3Uploader
     */
    S3Uploader.prototype.completeRequest = function (id) {
        var _this = this;
        var payload = this.getPayloadById(id);
        var parts = [];
        debug("[" + id + "] Run complete request");
        var partsHandle = payload.parts;
        var partLen = partsHandle.length;
        for (var i = 0; i < partLen; i++) {
            if (partsHandle[i].etag) {
                parts.push({ part_number: i + 1, etag: partsHandle[i].etag });
            }
        }
        debug("[" + id + "] Etags %O", parts);
        return FsRequest.post(this.getUrl() + "/multipart/complete", __assign(__assign({}, this.getDefaultFields(id, ['apikey', 'policy', 'signature', 'uri', 'region', 'upload_id', 'fii'], true)), { 
            // method specific keys
            filename: payload.file.name, mimetype: payload.file.type, size: payload.file.size, upload_tags: this.uploadTags && Object.keys(this.uploadTags).length ? this.uploadTags : undefined, parts: parts.length ? parts : undefined }), {
            timeout: this.timeout,
            cancelToken: this.cancelToken,
            headers: this.getDefaultHeaders(id),
            retry: this.retryConfig,
        })
            .then(function (res) {
            // if parts hasnt been merged, retry complete request again
            if (res.status === 202) {
                return new Promise(function (resolve, reject) {
                    setTimeout(function () {
                        return _this.completeRequest(id)
                            .then(resolve)
                            .catch(reject);
                    }, COMPLETE_TIMEOUT);
                });
            }
            // update file object
            var file = _this.getPayloadById(id).file;
            file.handle = res.data.handle;
            file.url = res.data.url;
            file.container = res.data.container;
            file.key = res.data.key;
            file.uploadTags = res.data.upload_tags;
            file.workflows = res.data.workflows;
            file.status = res.data.status;
            return file;
        })
            .catch(function (err) {
            _this.setPayloadStatus(id, "Failed" /* FAILED */);
            return Promise.reject(new FilestackError('Cannot complete file', _this.getErrorDetails(err), FilestackErrorType.REQUEST));
        });
    };
    /**
     * UUpgrade upload progress and run progress event
     *
     * @private
     * @param {string} id
     * @param {number} partNumber
     * @param {number} loaded
     * @memberof S3Uploader
     */
    S3Uploader.prototype.onProgressUpdate = function (id, partNumber, loaded) {
        this.setPartData(id, partNumber, 'progress', loaded);
        this.emitProgress();
    };
    /**
     * Emits normalized progress event
     *
     * @private
     * @memberof S3Uploader
     */
    S3Uploader.prototype.emitProgress = function () {
        var totalSize = 0;
        var totalBytes = 0;
        var filesProgress = {};
        for (var i in this.payloads) {
            var payload = this.payloads[i];
            // omit all failed files in progress event
            // this shouldn't happend because of promises rejection in execute. Left to be sure
            /* istanbul ignore next */
            if (payload.file.status === "Failed" /* FAILED */) {
                continue;
            }
            var totalParts = payload.parts.map(function (p) { return p.progress || 0; }).reduce(function (a, b) { return a + b; }, 0);
            totalBytes = totalBytes + totalParts;
            filesProgress[i] = {
                totalBytes: totalParts,
                totalPercent: Math.round((totalParts * 100) / payload.file.size) || 0,
            };
            totalSize = totalSize + payload.file.size;
        }
        var res = {
            totalBytes: totalBytes || 0,
            totalPercent: Math.round((totalBytes * 100) / totalSize) || 0,
            files: filesProgress,
        };
        debug("Upload progress %O", res);
        this.emit('progress', res);
    };
    /**
     * Apply provided data to given payload
     *
     * @private
     * @param {string} id
     * @param {*} data
     * @memberof S3Uploader
     */
    S3Uploader.prototype.updatePayload = function (id, data) {
        this.payloads[id] = __assign(__assign({}, this.payloads[id]), data);
    };
    /**
     * Sets etag for part
     *
     * @private
     * @param {number} partNumber
     * @param {string} etag
     * @memberof S3Uploader
     */
    S3Uploader.prototype.setPartETag = function (id, partNumber, etag) {
        debug("[" + id + "] Set " + etag + " etag for part " + partNumber);
        this.getPayloadById(id).parts[partNumber].etag = etag;
    };
    /**
     * Sets part value for a key
     *
     * @private
     * @param {number} partNumber
     * @param {string} etag
     * @memberof S3Uploader
     */
    S3Uploader.prototype.setPartData = function (id, partNumber, key, value) {
        debug("[" + id + "] Set " + key + " = " + value + " for part " + partNumber);
        var payload = this.getPayloadById(id);
        /* istanbul ignore next */
        if (!payload) {
            debug("[" + id + "] Cannot set " + key + " = " + value + " for part " + partNumber);
            return;
        }
        payload.parts[partNumber][key] = value;
    };
    /**
     * Set payload file state
     *
     * @param id
     * @param status
     */
    S3Uploader.prototype.setPayloadStatus = function (id, status) {
        debug("[" + id + "] Set payload status to " + status);
        /* istanbul ignore next: additional check in case if file will be deleted before setting status */
        if (!this.payloads[id]) {
            return;
        }
        this.payloads[id].file.status = status;
    };
    /**
     * Returns error details if response exists
     *
     * @param err
     */
    S3Uploader.prototype.getErrorDetails = function (err) {
        if (!err.response) {
            return {};
        }
        return {
            code: err.response.status,
            data: err.response.data,
            headers: err.response.headers,
        };
    };
    return S3Uploader;
}(UploaderAbstract));
export { S3Uploader };

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9saWIvYXBpL3VwbG9hZC91cGxvYWRlcnMvczMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7Ozs7Ozs7OztHQWVHOztBQUVILE9BQU8sTUFBTSxNQUFNLFNBQVMsQ0FBQztBQUM3QixPQUFPLEtBQUssTUFBTSxPQUFPLENBQUM7QUFJMUIsT0FBTyxFQUFFLFNBQVMsRUFBOEIsYUFBYSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDMUYsT0FBTyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsWUFBWSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDdEUsT0FBTyxFQUFFLGdCQUFnQixFQUFjLHNCQUFzQixFQUFFLGNBQWMsRUFBRSxzQkFBc0IsRUFBRSxNQUFNLFlBQVksQ0FBQztBQUMxSCxPQUFPLEVBQUUsY0FBYyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sK0JBQStCLENBQUM7QUFDbkYsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBRXpELElBQU0sS0FBSyxHQUFHLEtBQUssQ0FBQyxjQUFjLENBQUMsQ0FBQztBQUVwQyxJQUFNLGdCQUFnQixHQUFHLElBQUksR0FBRyxDQUFDLENBQUM7QUFtQmxDO0lBQWdDLDhCQUFnQjtJQU05QyxvQkFBWSxZQUFnQyxFQUFFLFdBQVk7UUFBMUQsWUFDRSxrQkFBTSxZQUFZLEVBQUUsV0FBVyxDQUFDLFNBUWpDO1FBWE8sY0FBUSxHQUFxQyxFQUFFLENBQUM7UUFLdEQsS0FBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLE1BQU0sQ0FBQztZQUMzQixTQUFTLEVBQUUsS0FBSztZQUNoQixXQUFXLEVBQUUsS0FBSSxDQUFDLFdBQVc7U0FDOUIsQ0FBQyxDQUFDO1FBRUgsS0FBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLGFBQWEsRUFBRSxDQUFDOztJQUN6QyxDQUFDO0lBRUQ7Ozs7T0FJRztJQUNJLDBCQUFLLEdBQVo7UUFDRSxJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUss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RyxNQUFNLENBQUM7SUFDekMsQ0FBQztJQUVEOzs7O09BSUc7SUFDSyxvQ0FBZSxHQUF2QixVQUF3QixHQUFtQjtRQUN6QyxJQUFJLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRTtZQUNqQixPQUFPLEVBQUUsQ0FBQztTQUNYO1FBRUQsT0FBTztZQUNMLElBQUksRUFBRSxHQUFHLENBQUMsUUFBUSxDQUFDLE1BQU07WUFDekIsSUFBSSxFQUFFLEdBQUcsQ0FBQyxRQUFRLENBQUMsSUFBSTtZQUN2QixPQUFPLEVBQUUsR0FBRyxDQUFDLFFBQVEsQ0FBQyxPQUFPO1NBQzlCLENBQUM7SUFDSixDQUFDO0lBQ0gsaUJBQUM7QUFBRCxDQXZ6QkEsQUF1ekJDLENBdnpCK0IsZ0JBQWdCLEdBdXpCL0MiLCJmaWxlIjoibGliL2FwaS91cGxvYWQvdXBsb2FkZXJzL3MzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIENvcHlyaWdodCAoYykgMjAxOSBieSBGaWxlc3RhY2suXG4gKiBTb21lIHJpZ2h0cyByZXNlcnZlZC5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IFBRdWV1ZSBmcm9tICdwLXF1ZXVlJztcbmltcG9ydCBEZWJ1ZyBmcm9tICdkZWJ1Zyc7XG5cbmltcG9ydCB7IEZpbGUsIEZpbGVQYXJ0LCBGaWxlUGFydE1ldGFkYXRhLCBGaWxlU3RhdGUgfSBmcm9tICcuLy4uL2ZpbGUnO1xuaW1wb3J0IHsgU3RvcmVVcGxvYWRPcHRpb25zIH0gZnJvbSAnLi8uLi90eXBlcyc7XG5pbXBvcnQgeyBGc1JlcXVlc3QsIEZzUmVzcG9uc2UsIEZzUmVxdWVzdEVycm9yLCBGc0NhbmNlbFRva2VuIH0gZnJvbSAnLi8uLi8uLi8uLi9yZXF1ZXN0JztcbmltcG9ydCB7IHVuaXF1ZVRpbWUsIHVuaXF1ZUlkLCBmaWx0ZXJPYmplY3QgfSBmcm9tICcuLy4uLy4uLy4uL3V0aWxzJztcbmltcG9ydCB7IFVwbG9hZGVyQWJzdHJhY3QsIFVwbG9hZE1vZGUsIElOVEVMTElHRU5UX0NIVU5LX1NJWkUsIE1JTl9DSFVOS19TSVpFLCBERUZBVUxUX1NUT1JFX0xPQ0FUSU9OIH0gZnJvbSAnLi9hYnN0cmFjdCc7XG5pbXBvcnQgeyBGaWxlc3RhY2tFcnJvciwgRmlsZXN0YWNrRXJyb3JUeXBlIH0gZnJvbSAnLi8uLi8uLi8uLi8uLi9maWxlc3RhY2tfZXJyb3InO1xuaW1wb3J0IHsgc2hvdWxkUmV0cnkgfSBmcm9tICcuLy4uLy4uLy4uL3JlcXVlc3QvaGVscGVycyc7XG5cbmNvbnN0IGRlYnVnID0gRGVidWcoJ2ZzOnVwbG9hZDpzMycpO1xuXG5jb25zdCBDT01QTEVURV9USU1FT1VUID0gMTAwMCAqIDE7XG5cbmV4cG9ydCBpbnRlcmZhY2UgVXBsb2FkUGFydCBleHRlbmRzIEZpbGVQYXJ0TWV0YWRhdGEge1xuICBldGFnPzogc3RyaW5nO1xuICBvZmZzZXQ/OiBudW1iZXI7XG4gIHByb2dyZXNzPzogbnVtYmVyO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFVwbG9hZFBheWxvYWQge1xuICBmaWxlOiBGaWxlO1xuICBwYXJ0czogVXBsb2FkUGFydFtdO1xuICBoYW5kbGU/OiBzdHJpbmc7XG4gIHVyaT86IHN0cmluZztcbiAgcmVnaW9uPzogc3RyaW5nO1xuICB1cGxvYWRfaWQ/OiBudW1iZXI7XG4gIGxvY2F0aW9uX3VybD86IHN0cmluZztcbiAgbG9jYXRpb25fcmVnaW9uPzogc3RyaW5nO1xufVxuXG5leHBvcnQgY2xhc3MgUzNVcGxvYWRlciBleHRlbmRzIFVwbG9hZGVyQWJzdHJhY3Qge1xuICBwcml2YXRlIHBhcnRzUXVldWU7XG4gIHByaXZhdGUgY2FuY2VsVG9rZW46IEZzQ2FuY2VsVG9rZW47IC8vIGdsb2JhbCBjYW5jZWwgdG9rZW4gZm9yIGFsbCByZXF1ZXN0c1xuXG4gIHByaXZhdGUgcGF5bG9hZHM6IHsgW2tleTogc3RyaW5nXTogVXBsb2FkUGF5bG9hZCB9ID0ge307XG5cbiAgY29uc3RydWN0b3Ioc3RvcmVPcHRpb25zOiBTdG9yZVVwbG9hZE9wdGlvbnMsIGNvbmN1cnJlbmN5Pykge1xuICAgIHN1cGVyKHN0b3JlT3B0aW9ucywgY29uY3VycmVuY3kpO1xuXG4gICAgdGhpcy5wYXJ0c1F1ZXVlID0gbmV3IFBRdWV1ZSh7XG4gICAgICBhdXRvU3RhcnQ6IGZhbHNlLFxuICAgICAgY29uY3VycmVuY3k6IHRoaXMuY29uY3VycmVuY3ksXG4gICAgfSk7XG5cbiAgICB0aGlzLmNhbmNlbFRva2VuID0gbmV3IEZzQ2FuY2VsVG9rZW4oKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBQYXVzZSB1cGxvYWQgcXVldWVcbiAgICpcbiAgICogQG1lbWJlcm9mIFMzVXBsb2FkZXJcbiAgICovXG4gIHB1YmxpYyBwYXVzZSgpOiB2b2lkIHtcbiAgICB0aGlzLnBhcnRzUXVldWUucGF1c2UoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiByZXN1bWUgdXBsb2FkIHF1ZXVlIGlmIGl0cyBwYXVzZWRcbiAgICpcbiAgICogQG1lbWJlcm9mIFMzVXBsb2FkZXJcbiAgICovXG4gIHB1YmxpYyByZXN1bWUoKTogdm9pZCB7XG4gICAgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi9cbiAgICBpZiAodGhpcy5wYXJ0c1F1ZXVlLmlzUGF1c2VkKSB7XG4gICAgICB0aGlzLnBhcnRzUXVldWUuc3RhcnQoKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQWJvcnRzIHF1ZXVlIChhbGwgcGVuZGluZyByZXF1ZXN0cyB3aXRoIHdpbGwgYmUgYWJvcnRlZClcbiAgICpcbiAgICogQG1lbWJlcm9mIFMzVXBsb2FkZXJcbiAgICovXG4gIHB1YmxpYyBhYm9ydChtc2c/OiBzdHJpbmcpOiB2b2lkIHtcbiAgICB0aGlzLmNhbmNlbFRva2VuLmNhbmNlbChtc2cgfHwgJ0Fib3J0ZWQgYnkgdXNlcicpO1xuICAgIHRoaXMucGFydHNRdWV1ZS5jbGVhcigpO1xuICB9XG5cbiAgLyoqXG4gICAqIEV4ZWN1dGUgYWxsIHF1ZXVlZCBmaWxlc1xuICAgKlxuICAgKiBAcmV0dXJucyB7UHJvbWlzZTxhbnk+fVxuICAgKiBAbWVtYmVyb2YgUzNVcGxvYWRlclxuICAgKi9cbiAgcHVibGljIGFzeW5jIGV4ZWN1dGUoKTogUHJvbWlzZTxhbnk+IHtcbiAgICBjb25zdCB0YXNrcyA9IE9iamVjdC5rZXlzKHRoaXMucGF5bG9hZHMpLm1hcChcbiAgICAgIGlkID0+XG4gICAgICAgIG5ldyBQcm9taXNlKGFzeW5jIHJlc29sdmUgPT4ge1xuICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLnN0YXJ0UmVxdWVzdChpZCk7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLnByZXBhcmVQYXJ0cyhpZCk7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLnN0YXJ0UGFydHNRdWV1ZShpZCk7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLmNvbXBsZXRlUmVxdWVzdChpZCk7XG4gICAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi9cbiAgICAgICAgICAgIHRoaXMuZW1pdCgnZXJyb3InLCBlKTtcbiAgICAgICAgICAgIGRlYnVnKGBbJHtpZH1dIEZpbGUgdXBsb2FkIGZhaWxlZC4gJU8sIFxcbkRldGFpbHM6ICVPIGAsIGUubWVzc2FnZSwgZS5kZXRhaWxzKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBjb25zdCBmaWxlID0gdGhpcy5nZXRQYXlsb2FkQnlJZChpZCkuZmlsZTtcblxuICAgICAgICAgIC8vIHJlbGVhc2UgZmlsZSBidWZmZXJcbiAgICAgICAgICBmaWxlLnJlbGVhc2UoKTtcblxuICAgICAgICAgIC8vIGNsZWFudXAgcGF5bG9hZHNcbiAgICAgICAgICBkZWxldGUgdGhpcy5wYXlsb2Fkc1tpZF07XG5cbiAgICAgICAgICByZXNvbHZlKGZpbGUpO1xuICAgICAgICB9KVxuICAgICk7XG5cbiAgICByZXR1cm4gUHJvbWlzZS5hbGwodGFza3MpO1xuICB9XG5cbiAgLyoqXG4gICAqIEFkZCBmaWxlIHRvIHVwbG9hZCBxdWV1ZVxuICAgKlxuICAgKiBAcGFyYW0ge0ZpbGV9IGZpbGVcbiAgICogQHJldHVybnNcbiAgICogQG1lbWJlcm9mIFMzVXBsb2FkZXJcbiAgICovXG4gIHB1YmxpYyBhZGRGaWxlKGZpbGU6IEZpbGUpOiBzdHJpbmcge1xuICAgIGRlYnVnKCdBZGQgZmlsZSB0byBxdWV1ZTogXFxuICVvJywgZmlsZSk7XG5cbiAgICBjb25zdCBpZCA9IGAke3VuaXF1ZUlkKDE1KX1fJHt1bmlxdWVUaW1lKCl9YDtcblxuICAgIGZpbGUuc3RhdHVzID0gRmlsZVN0YXRlLklOSVQ7XG5cbiAgICAvLyBzcGxpdCBmaWxlIGludG8gcGFydHMgYW5kIHNldCBpdCBhcyB3YWl0aW5nXG4gICAgdGhpcy5wYXlsb2Fkc1tpZF0gPSB7XG4gICAgICBmaWxlLFxuICAgICAgcGFydHM6IFtdLFxuICAgIH07XG5cbiAgICByZXR1cm4gaWQ7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyBob3N0IGZvciB1cGxvYWQgKHJlZ2lvbiBiYXNlZClcbiAgICpcbiAgICogQHByaXZhdGVcbiAgICogQHJldHVybnNcbiAgICogQG1lbWJlcm9mIFMzVXBsb2FkZXJcbiAgICovXG4gIHByaXZhdGUgZ2V0VXBsb2FkVXJsKGlkOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIGNvbnN0IHsgbG9jYXRpb25fdXJsIH0gPSB0aGlzLmdldERlZmF1bHRGaWVsZHMoaWQsIFsnbG9jYXRpb25fdXJsJ10pO1xuICAgIHJldHVybiBsb2NhdGlvbl91cmwuaW5kZXhPZignaHR0cCcpID09PSAwID8gbG9jYXRpb25fdXJsIDogYGh0dHBzOi8vJHtsb2NhdGlvbl91cmx9YDtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIGZvcm1hdHRlZCBzdG9yZSBvcHRpb25zXG4gICAqXG4gICAqIEBwcml2YXRlXG4gICAqIEByZXR1cm5zXG4gICAqIEBtZW1iZXJvZiBTM1VwbG9hZGVyXG4gICAqL1xuICBwcml2YXRlIGdldFN0b3JlT3B0aW9ucyhpZDogc3RyaW5nKTogU3RvcmVVcGxvYWRPcHRpb25zIHtcbiAgICBsZXQgb3B0aW9ucyA9IHtcbiAgICAgIGxvY2F0aW9uOiBERUZBVUxUX1NUT1JFX0xPQ0FUSU9OLCAvLyB0aGlzIHBhcmFtZXRlciBpcyByZXF1aXJlZCwgaWYgbm90IHNldCB1c2UgZGVmYXVsdCBvbmVcbiAgICAgIC4uLnRoaXMuc3RvcmVPcHRpb25zLFxuICAgIH07XG5cbiAgICBpZiAodGhpcy5zdG9yZU9wdGlvbnMuZGlzYWJsZVN0b3JhZ2VLZXkpIHtcbiAgICAgIGNvbnN0IHBheWxvYWQgPSB0aGlzLmdldFBheWxvYWRCeUlkKGlkKTtcblxuICAgICAgaWYgKG9wdGlvbnMucGF0aCAmJiBvcHRpb25zLnBhdGguc3Vic3RyKC0xKSAhPT0gJy8nKSB7XG4gICAgICAgIG9wdGlvbnMucGF0aCA9IGAke29wdGlvbnMucGF0aH0vYDtcbiAgICAgIH1cblxuICAgICAgb3B0aW9ucy5wYXRoID0gYCR7b3B0aW9ucy5wYXRoID8gb3B0aW9ucy5wYXRoIDogJy8nfSR7cGF5bG9hZC5maWxlLm5hbWV9YDtcblxuICAgICAgZGVsZXRlIG9wdGlvbnMuZGlzYWJsZVN0b3JhZ2VLZXk7XG4gICAgfVxuXG4gICAgcmV0dXJuIG9wdGlvbnM7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyBhbGwgZGVmYXVsdCBmaWVsZHMgZm9yIGZpbGVzdGFjayByZXF1ZXN0c1xuICAgKlxuICAgKiBAcHJpdmF0ZVxuICAgKiBAcmV0dXJuc1xuICAgKiBAbWVtYmVyb2YgUzNVcGxvYWRlclxuICAgKi9cbiAgcHJpdmF0ZSBnZXREZWZhdWx0RmllbGRzKGlkOiBzdHJpbmcsIHJlcXVpcmVkRmllbGRzOiBzdHJpbmdbXSwgZmlpRmFsbGJhY2s6IGJvb2xlYW4gPSBmYWxzZSkge1xuICAgIGNvbnN0IHBheWxvYWQgPSB0aGlzLmdldFBheWxvYWRCeUlkKGlkKTtcblxuICAgIGxldCBmaWVsZHMgPSB7XG4gICAgICAuLi50aGlzLnNlY3VyaXR5LFxuICAgICAgYXBpa2V5OiB0aGlzLmFwaWtleSxcbiAgICAgIHVyaTogcGF5bG9hZC51cmksXG4gICAgICBsb2NhdGlvbl91cmw6IHBheWxvYWQubG9jYXRpb25fdXJsLFxuICAgICAgdXBsb2FkX2lkOiBwYXlsb2FkLnVwbG9hZF9pZCxcbiAgICAgIHJlZ2lvbjogcGF5bG9hZC5yZWdpb24sXG4gICAgfTtcblxuICAgIGlmICh0aGlzLnVwbG9hZE1vZGUgPT09IFVwbG9hZE1vZGUuSU5URUxMSUdFTlQgfHwgKHRoaXMudXBsb2FkTW9kZSA9PT0gVXBsb2FkTW9kZS5GQUxMQkFDSyAmJiBmaWlGYWxsYmFjaykpIHtcbiAgICAgIGZpZWxkc1snZmlpJ10gPSB0cnVlO1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICAuLi5maWx0ZXJPYmplY3QoZmllbGRzLCByZXF1aXJlZEZpZWxkcyksXG4gICAgICBzdG9yZTogdGhpcy5nZXRTdG9yZU9wdGlvbnMoaWQpLFxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyBkZWZhdWx0IGhlYWRlcnMgbmVlZGVkIGZvciBmaWxlc3RhY2sgcmVxdWVzdFxuICAgKlxuICAgKiBAcHJpdmF0ZVxuICAgKiBAcmV0dXJuc1xuICAgKiBAbWVtYmVyb2YgUzNVcGxvYWRlclxuICAgKi9cbiAgcHJpdmF0ZSBnZXREZWZhdWx0SGVhZGVycyhpZDogc3RyaW5nKSB7XG4gICAgbGV0IGhlYWRlcnMgPSB7fTtcbiAgICBjb25zdCBmaWxlID0gdGhpcy5nZXRQYXlsb2FkQnlJZChpZCk7XG5cbiAgICBpZiAoZmlsZS5sb2NhdGlvbl9yZWdpb24pIHtcbiAgICAgIGhlYWRlcnNbJ0ZpbGVzdGFjay1VcGxvYWQtUmVnaW9uJ10gPSBmaWxlLmxvY2F0aW9uX3JlZ2lvbjtcbiAgICB9XG5cbiAgICByZXR1cm4gaGVhZGVycztcbiAgfVxuXG4gIHByaXZhdGUgZ2V0UGF5bG9hZEJ5SWQoaWQ6IHN0cmluZyk6IFVwbG9hZFBheWxvYWQge1xuICAgIHJldHVybiB0aGlzLnBheWxvYWRzW2lkXTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTcGxpdCBmaWxlIG9udG8gcGFydHMgZm9yIHVwbG9hZGluZyB3aXRoIG11bHRpcGFydCBtZWNoYW5pc20gYW5kIHNldHVwIHN0YXJ0XG4gICAqXG4gICAqIEBwcml2YXRlXG4gICAqIEBtZW1iZXJvZiBTM1VwbG9hZGVyXG4gICAqL1xuICBwcml2YXRlIHByZXBhcmVQYXJ0cyhpZDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgZmlsZSA9IHRoaXMuZ2V0UGF5bG9hZEJ5SWQoaWQpLmZpbGU7XG5cbiAgICAvLyBmb3IgaW50ZWxsaWdlbnQgb3IgZmFsbGJhY2sgbW9kZSB3ZSBjYW50IG92ZXJ3cml0ZSBwYXJ0IHNpemUgLSByZXF1aXJlcyA4TUJcbiAgICBpZiAoW1VwbG9hZE1vZGUuSU5URUxMSUdFTlQsIFVwbG9hZE1vZGUuRkFMTEJBQ0tdLmluZGV4T2YodGhpcy51cGxvYWRNb2RlKSA+IC0xKSB7XG4gICAgICB0aGlzLnBhcnRTaXplID0gSU5URUxMSUdFTlRfQ0hVTktfU0laRTtcbiAgICB9XG5cbiAgICBjb25zdCBwYXJ0c0NvdW50ID0gZmlsZS5nZXRQYXJ0c0NvdW50KHRoaXMucGFydFNpemUpO1xuXG4gICAgY29uc3QgcGFydHMgPSBbXTtcblxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcGFydHNDb3VudDsgaSsrKSB7XG4gICAgICBwYXJ0c1tpXSA9IHtcbiAgICAgICAgLi4uZmlsZS5nZXRQYXJ0TWV0YWRhdGEoaSwgdGhpcy5wYXJ0U2l6ZSksXG4gICAgICAgIG9mZnNldDogMCxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgLy8gc3BsaXQgZmlsZSBpbnRvIHBhcnRzIGFuZCBzZXQgaXQgYXMgd2FpdGluZ1xuICAgIHRoaXMucGF5bG9hZHNbaWRdLnBhcnRzID0gcGFydHM7XG5cbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG4gIH1cblxuICAvKipcbiAgICogTWFrZSBzdGFydCByZXF1ZXN0IGZvciBnZXR0aW5nIG5lZWRlZCB1cGxvYWQgZmllbGRzXG4gICAqXG4gICAqIEBwcml2YXRlXG4gICAqIEByZXR1cm5zIHtQcm9taXNlPGFueT59XG4gICAqIEBtZW1iZXJvZiBTM1VwbG9hZGVyXG4gICAqL1xuICBwcml2YXRlIHN0YXJ0UmVxdWVzdChpZDogc3RyaW5nKTogUHJvbWlzZTxhbnk+IHtcbiAgICBjb25zdCBwYXlsb2FkID0gdGhpcy5nZXRQYXlsb2FkQnlJZChpZCk7XG5cbiAgICBpZiAocGF5bG9hZC5maWxlLnNpemUgPT09IDApIHtcbiAgICAgIHRoaXMuc2V0UGF5bG9hZFN0YXR1cyhpZCwgRmlsZVN0YXRlLkZBSUxFRCk7XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QobmV3IEZpbGVzdGFja0Vycm9yKGBJbnZhbGlkIGZpbGUgXCIke3BheWxvYWQuZmlsZS5uYW1lfVwiIHNpemUgLSAwYCwge30sIEZpbGVzdGFja0Vycm9yVHlwZS5WQUxJREFUSU9OKSk7XG4gICAgfVxuXG4gICAgZGVidWcoYFske2lkfV0gTWFrZSBzdGFydCByZXF1ZXN0YCk7XG4gICAgcmV0dXJuIEZzUmVxdWVzdC5wb3N0KFxuICAgICAgYCR7dGhpcy5nZXRVcmwoKX0vbXVsdGlwYXJ0L3N0YXJ0YCxcbiAgICAgIHtcbiAgICAgICAgZmlsZW5hbWU6IHBheWxvYWQuZmlsZS5uYW1lLFxuICAgICAgICBtaW1ldHlwZTogcGF5bG9hZC5maWxlLnR5cGUsXG4gICAgICAgIHNpemU6IHBheWxvYWQuZmlsZS5zaXplLFxuICAgICAgICAuLi50aGlzLmdldERlZmF1bHRGaWVsZHMoaWQsIFsnYXBpa2V5JywgJ3BvbGljeScsICdzaWduYXR1cmUnLCAnZmlpJ10sIHRydWUpLFxuICAgICAgfSxcbiAgICAgIHtcbiAgICAgICAgdGltZW91dDogdGhpcy50aW1lb3V0LFxuICAgICAgICBjYW5jZWxUb2tlbjogdGhpcy5jYW5jZWxUb2tlbixcbiAgICAgICAgaGVhZGVyczogdGhpcy5nZXREZWZhdWx0SGVhZGVycyhpZCksXG4gICAgICAgIHJldHJ5OiB0aGlzLnJldHJ5Q29uZmlnLFxuICAgICAgfVxuICAgIClcbiAgICAgIC50aGVuKCh7IGRhdGEgfSkgPT4ge1xuICAgICAgICBpZiAoIWRhdGEgfHwgIWRhdGEubG9jYXRpb25fdXJsIHx8ICFkYXRhLnJlZ2lvbiB8fCAhZGF0YS51cGxvYWRfaWQgfHwgIWRhdGEudXJpKSB7XG4gICAgICAgICAgZGVidWcoYFske2lkfV0gSW5jb3JyZWN0IHN0YXJ0IHJlc3BvbnNlOiBcXG4lT1xcbmAsIGRhdGEpO1xuICAgICAgICAgIHRoaXMuc2V0UGF5bG9hZFN0YXR1cyhpZCwgRmlsZVN0YXRlLkZBSUxFRCk7XG4gICAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KG5ldyBGaWxlc3RhY2tFcnJvcignSW5jb3JyZWN0IHN0YXJ0IHJlc3BvbnNlJywgZGF0YSwgRmlsZXN0YWNrRXJyb3JUeXBlLlJFUVVFU1QpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGRlYnVnKGBbJHtpZH1dIEFzc2lnbiBwYXlsb2FkIGRhdGE6IFxcbiVPXFxuYCwgZGF0YSk7XG5cbiAgICAgICAgdGhpcy51cGRhdGVQYXlsb2FkKGlkLCBkYXRhKTtcblxuICAgICAgICAvLyBpaSBpcyBub3QgZW5hYmxlZCBpbiBiYWNrZW5kIHN3aXRjaCBiYWNrIHRvIGRlZmF1bHQgdXBsb2FkIG1vZGVcbiAgICAgICAgaWYgKFtVcGxvYWRNb2RlLklOVEVMTElHRU5ULCBVcGxvYWRNb2RlLkZBTExCQUNLXS5pbmRleE9mKHRoaXMudXBsb2FkTW9kZSkgPiAtMSAmJiAoIWRhdGEudXBsb2FkX3R5cGUgfHwgZGF0YS51cGxvYWRfdHlwZSAhPT0gJ2ludGVsbGlnZW50X2luZ2VzdGlvbicpKSB7XG4gICAgICAgICAgZGVidWcoYFske2lkfV0gSW50ZWxsaWdlbnQgSW5nZXN0aW9uIGlzIG5vdCBlbmFibGVkIG9uIGFjY291bnQsIHN3aXRjaCBiYWNrIHRvIHJlZ3VsYXIgdXBsb2FkIGFuZCBsb2NrIG1vZGUgY2hhbmdlYCk7XG4gICAgICAgICAgdGhpcy5zZXRVcGxvYWRNb2RlKFVwbG9hZE1vZGUuREVGQVVMVCwgdHJ1ZSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gZGF0YTtcbiAgICAgIH0pXG4gICAgICAuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgZGVidWcoYFske2lkfV0gU3RhcnQgcmVxdWVzdCBlcnJvciAlT2AsIGVycik7XG4gICAgICAgIHRoaXMuc2V0UGF5bG9hZFN0YXR1cyhpZCwgRmlsZVN0YXRlLkZBSUxFRCk7XG5cbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KG5ldyBGaWxlc3RhY2tFcnJvcignQ2Fubm90IHVwbG9hZCBmaWxlLiBTdGFydCByZXF1ZXN0IGZhaWxlZCcsIHRoaXMuZ2V0RXJyb3JEZXRhaWxzKGVyciksIEZpbGVzdGFja0Vycm9yVHlwZS5SRVFVRVNUKSk7XG4gICAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBFbnF1ZXVlIGZpbGUgcGFydHMgdG8gdXBsb2FkXG4gICAqXG4gICAqIEBwcml2YXRlXG4gICAqIEByZXR1cm5zXG4gICAqIEBtZW1iZXJvZiBTM1VwbG9hZGVyXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIHN0YXJ0UGFydHNRdWV1ZShpZDogc3RyaW5nKTogUHJvbWlzZTxhbnk+IHtcbiAgICBjb25zdCBwYXlsb2FkID0gdGhpcy5nZXRQYXlsb2FkQnlJZChpZCk7XG4gICAgY29uc3QgcGFydHMgPSBwYXlsb2FkLnBhcnRzO1xuICAgIGNvbnN0IHdhaXRpbmdMZW5ndGggPSBwYXJ0cy5sZW5ndGg7XG5cbiAgICBkZWJ1ZyhgWyR7aWR9XSBDcmVhdGUgdXBsb2FkaW5nIHF1ZXVlIGZyb20gZmlsZS4gcGFydHMgY291bnQgLSAlZGAsIHdhaXRpbmdMZW5ndGgpO1xuXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKGFzeW5jIChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHBhcnRzLmZvckVhY2gocGFydCA9PlxuICAgICAgICB0aGlzLnBhcnRzUXVldWVcbiAgICAgICAgICAuYWRkKCgpID0+IHRoaXMuc3RhcnRQYXJ0KGlkLCBwYXJ0LnBhcnROdW1iZXIpKVxuICAgICAgICAgIC5jYXRjaChlID0+IHtcbiAgICAgICAgICAgIHRoaXMuc2V0UGF5bG9hZFN0YXR1cyhpZCwgRmlsZVN0YXRlLkZBSUxFRCk7XG4gICAgICAgICAgICBkZWJ1ZyhgWyR7aWR9XSBGYWlsZWQgdG8gdXBsb2FkIHBhcnQgJXNgLCBlLm1lc3NhZ2UpO1xuXG4gICAgICAgICAgICB0aGlzLnBhcnRzUXVldWUucGF1c2UoKTtcbiAgICAgICAgICAgIHRoaXMucGFydHNRdWV1ZS5jbGVhcigpO1xuICAgICAgICAgICAgcmV0dXJuIHJlamVjdChlKTtcbiAgICAgICAgICB9KVxuICAgICAgKTtcblxuICAgICAgZGVidWcoYFske2lkfV0gQWxsIHRhc2tzIGZvciAlcyBlbnF1ZXVlZC4gU3RhcnQgcHJvY2Vzc2luZyBtYWluIHVwbG9hZCBxdWV1ZWAsIGlkKTtcbiAgICAgIHRoaXMucGFydHNRdWV1ZS5zdGFydCgpO1xuXG4gICAgICByZXNvbHZlKGF3YWl0IHRoaXMucGFydHNRdWV1ZS5vbklkbGUoKSk7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogRGVjaWRlIGlmIHVwbG9hZCBzaG91bGQgYmUgbWFkZSB1c2luZyBpaSBvciByZWd1bGFyIHVwbG9hZFxuICAgKiBJdCBhbGxvd3MgY2hhbmdlIHVwbG9hZCBtb2RlIGR1cmluZyB1cGxvYWQgcXVldWVcbiAgICpcbiAgICogQHByaXZhdGVcbiAgICogQHBhcmFtIHtudW1iZXJ9IHBhcnROdW1iZXJcbiAgICogQHJldHVybnMge1Byb21pc2U8YW55Pn1cbiAgICogQG1lbWJlcm9mIFMzVXBsb2FkZXJcbiAgICovXG4gIHByaXZhdGUgc3RhcnRQYXJ0KGlkOiBzdHJpbmcsIHBhcnROdW1iZXI6IG51bWJlcik6IFByb21pc2U8YW55PiB7XG4gICAgZGVidWcoYFske2lkfV0gU3RhcnQgcHJvY2Vzc2luZyBwYXJ0ICR7cGFydE51bWJlcn0gd2l0aCBtb2RlICR7dGhpcy51cGxvYWRNb2RlfWApO1xuXG4gICAgbGV0IHBheWxvYWQgPSB0aGlzLmdldFBheWxvYWRCeUlkKGlkKTtcblxuICAgIHBheWxvYWQuZmlsZS5zdGF0dXMgPSBGaWxlU3RhdGUuUFJPR1JFU1M7XG4gICAgcmV0dXJuICh0aGlzLnVwbG9hZE1vZGUgIT09IFVwbG9hZE1vZGUuSU5URUxMSUdFTlQgPyB0aGlzLnVwbG9hZFJlZ3VsYXIgOiB0aGlzLnVwbG9hZEludGVsbGlnZW50KS5hcHBseSh0aGlzLCBbaWQsIHBhcnROdW1iZXJdKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIHBhcnQgZGF0YSBuZWVkZWQgZm9yIHVwbG9hZFxuICAgKlxuICAgKiBAcHJpdmF0ZVxuICAgKiBAcGFyYW0ge3N0cmluZ30gaWQgLSBpZCBvZiBhIGN1cnJlbnRseSB1cGxvYWRpbmcgZmlsZVxuICAgKiBAcGFyYW0ge0ZpbGVQYXJ0fSBwYXJ0XG4gICAqIEByZXR1cm5zXG4gICAqIEBtZW1iZXJvZiBTM1VwbG9hZGVyXG4gICAqL1xuICBwcml2YXRlIGdldFMzUGFydE1ldGFkYXRhKGlkOiBzdHJpbmcsIHBhcnQ6IEZpbGVQYXJ0LCBvZmZzZXQ/OiBudW1iZXIpOiBQcm9taXNlPGFueT4ge1xuICAgIGNvbnN0IHVybCA9IHRoaXMuZ2V0VXBsb2FkVXJsKGlkKTtcblxuICAgIGRlYnVnKGBbJHtpZH1dIEdldCBkYXRhIGZvciBwYXJ0ICR7cGFydC5wYXJ0TnVtYmVyfSwgdXJsICR7dXJsfSwgTWQ1OiAke3BhcnQubWQ1fSwgU2l6ZTogJHtwYXJ0LnNpemV9YCk7XG5cbiAgICBjb25zdCBkYXRhID0ge1xuICAgICAgLi4udGhpcy5nZXREZWZhdWx0RmllbGRzKGlkLCBbJ2FwaWtleScsICd1cmknLCAncmVnaW9uJywgJ3NpZ25hdHVyZScsICdwb2xpY3knLCAndXBsb2FkX2lkJywgJ2ZpaSddKSxcbiAgICAgIC8vIG1ldGhvZCBzcGVjaWZpYyBrZXlzXG4gICAgICBwYXJ0OiBwYXJ0LnBhcnROdW1iZXIgKyAxLFxuICAgICAgc2l6ZTogcGFydC5zaXplLFxuICAgICAgb2Zmc2V0LFxuICAgIH07XG5cbiAgICBpZiAodGhpcy5pbnRlZ3JpdHlDaGVjayAmJiBwYXJ0Lm1kNSkge1xuICAgICAgZGF0YS5tZDUgPSBwYXJ0Lm1kNTtcbiAgICB9XG5cbiAgICByZXR1cm4gRnNSZXF1ZXN0LnBvc3QoYCR7dXJsfS9tdWx0aXBhcnQvdXBsb2FkYCwgZGF0YSwge1xuICAgICAgaGVhZGVyczogdGhpcy5nZXREZWZhdWx0SGVhZGVycyhpZCksXG4gICAgICBjYW5jZWxUb2tlbjogdGhpcy5jYW5jZWxUb2tlbixcbiAgICAgIHRpbWVvdXQ6IHRoaXMudGltZW91dCxcbiAgICAgIHJldHJ5OiB0aGlzLnJldHJ5Q29uZmlnLFxuICAgIH0pLmNhdGNoKGVyciA9PiB7XG4gICAgICB0aGlzLnNldFBheWxvYWRTdGF0dXMoaWQsIEZpbGVTdGF0ZS5GQUlMRUQpO1xuXG4gICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QobmV3IEZpbGVzdGFja0Vycm9yKCdDYW5ub3QgZ2V0IHBhcnQgbWV0YWRhdGEnLCB0aGlzLmdldEVycm9yRGV0YWlscyhlcnIpLCBGaWxlc3RhY2tFcnJvclR5cGUuUkVRVUVTVCkpO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlZ3VsYXIgbXVsdGlwYXJ0IHJlcXVlc3QgdG8gYW1hem9uXG4gICAqXG4gICAqIEBwcml2YXRlXG4gICAqIEBwYXJhbSB7bnVtYmVyfSBwYXJ0TnVtYmVyXG4gICAqIEByZXR1cm5zIHtQcm9taXNlPGFueT59XG4gICAqIEBtZW1iZXJvZiBTM1VwbG9hZGVyXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIHVwbG9hZFJlZ3VsYXIoaWQ6IHN0cmluZywgcGFydE51bWJlcjogbnVtYmVyKTogUHJvbWlzZTxhbnk+IHtcbiAgICBsZXQgcGF5bG9hZCA9IHRoaXMuZ2V0UGF5bG9hZEJ5SWQoaWQpO1xuICAgIGNvbnN0IHBhcnRNZXRhZGF0YSA9IHBheWxvYWQucGFydHNbcGFydE51bWJlcl07XG4gICAgbGV0IHBhcnQgPSBhd2FpdCBwYXlsb2FkLmZpbGUuZ2V0UGFydEJ5TWV0YWRhdGEocGFydE1ldGFkYXRhLCB0aGlzLmludGVncml0eUNoZWNrKTtcblxuICAgIGNvbnN0IHsgZGF0YSwgaGVhZGVycyB9ID0gYXdhaXQgdGhpcy5nZXRTM1BhcnRNZXRhZGF0YShpZCwgcGFydCk7XG4gICAgZGVidWcoYFske2lkfV0gUmVjZWl2ZWQgcGFydCAke3BhcnROdW1iZXJ9IGluZm8gYm9keTogXFxuJU9cXG4gaGVhZGVyczogXFxuJU9cXG5gLCBkYXRhLCBoZWFkZXJzKTtcbiAgICByZXR1cm4gRnNSZXF1ZXN0LnB1dChkYXRhLnVybCwgcGFydC5idWZmZXIsIHtcbiAgICAgIGNhbmNlbFRva2VuOiB0aGlzLmNhbmNlbFRva2VuLFxuICAgICAgdGltZW91dDogdGhpcy50aW1lb3V0LFxuICAgICAgaGVhZGVyczogZGF0YS5oZWFkZXJzLFxuICAgICAgZmlsZXN0YWNrSGVhZGVyczogZmFsc2UsXG4gICAgICAvLyBmb3Igbm93IHdlIGNhbnQgdGVzdCBwcm9ncmVzcyBjYWxsYmFjayBmcm9tIHVwbG9hZFxuICAgICAgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi9cbiAgICAgIG9uUHJvZ3Jlc3M6IChwcjogUHJvZ3Jlc3NFdmVudCkgPT4gdGhpcy5vblByb2dyZXNzVXBkYXRlKGlkLCBwYXJ0TnVtYmVyLCBwci5sb2FkZWQpLFxuICAgICAgcmV0cnk6IHRoaXMucmV0cnlDb25maWcgJiYgdGhpcy51cGxvYWRNb2RlICE9PSBVcGxvYWRNb2RlLkZBTExCQUNLID8gdGhpcy5yZXRyeUNvbmZpZyA6IHVuZGVmaW5lZCxcbiAgICB9KVxuICAgIC50aGVuKHJlcyA9PiB7XG4gICAgICBpZiAocmVzLmhlYWRlcnMuZXRhZykge1xuICAgICAgICB0aGlzLnNldFBhcnRFVGFnKGlkLCBwYXJ0TnVtYmVyLCByZXMuaGVhZGVycy5ldGFnKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIHJlbGVhc2UgbWVtb3J5XG4gICAgICAgIHBhcnQgPSBudWxsO1xuICAgICAgICB0aHJvdyBuZXcgRmlsZXN0YWNrRXJyb3IoJ0Nhbm5vdCB1cGxvYWQgZmlsZSwgY2hlY2sgUzMgYnVja2V0IHNldHRpbmdzJywgJ0V0YWcgaGVhZGVyIGlzIG5vdCBleHBvc2VkIGluIENPUlMgc2V0dGluZ3MnLCBGaWxlc3RhY2tFcnJvclR5cGUuUkVRVUVTVCk7XG4gICAgICB9XG5cbiAgICAgIGRlYnVnKGBbJHtpZH1dIFMzIFVwbG9hZCByZXNwb25zZSBoZWFkZXJzIGZvciAke3BhcnROdW1iZXJ9OiBcXG4lT1xcbmAsIHJlcy5oZWFkZXJzKTtcblxuICAgICAgdGhpcy5vblByb2dyZXNzVXBkYXRlKGlkLCBwYXJ0TnVtYmVyLCBwYXJ0LnNpemUpO1xuXG4gICAgICAvLyByZWxlYXNlIG1lbW9yeVxuICAgICAgcGFydCA9IG51bGw7XG5cbiAgICAgIHJldHVybiByZXM7XG4gICAgfSlcbiAgICAuY2F0Y2goZXJyID0+IHtcbiAgICAgIGNvbnN0IHJlc3AgPSBlcnIgJiYgZXJyLnJlc3BvbnNlID8gZXJyLnJlc3BvbnNlIDogbnVsbDtcblxuICAgICAgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi9cbiAgICAgIGlmIChyZXNwICYmIHJlc3Auc3RhdHVzID09PSA0MDMpIHtcbiAgICAgICAgaWYgKHJlc3AuZGF0YSAmJiByZXNwLmRhdGEuRXJyb3IgJiYgcmVzcC5kYXRhLkVycm9yLmNvZGUpIHtcbiAgICAgICAgICBsZXQgY29kZSA9IHJlc3AuZGF0YS5FcnJvci5jb2RlO1xuXG4gICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoY29kZSkpIHtcbiAgICAgICAgICAgIGNvZGUgPSBjb2RlLnBvcCgpO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIHN3aXRjaCAoY29kZSkge1xuICAgICAgICAgICAgY2FzZSAnUmVxdWVzdFRpbWVUb29Ta2V3ZWQnOlxuICAgICAgICAgICAgICByZXR1cm4gdGhpcy5zdGFydFBhcnQoaWQsIHBhcnROdW1iZXIpO1xuICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KG5ldyBGaWxlc3RhY2tFcnJvcignQ2Fubm90IHVwbG9hZCBmaWxlJywgcmVzcC5kYXRhLkVycm9yLCBGaWxlc3RhY2tFcnJvclR5cGUuUkVRVUVTVCkpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICAvLyByZWxlYXNlIG1lbW9yeVxuICAgICAgcGFydCA9IG51bGw7XG5cbiAgICAgIGlmIChlcnIgaW5zdGFuY2VvZiBGaWxlc3RhY2tFcnJvcikge1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZXJyKTtcbiAgICAgIH1cbiAgICAgIC8vIHJlc2V0IHVwbG9hZCBwcm9ncmVzcyBvbiBmYWlsZWQgcGFydFxuICAgICAgdGhpcy5vblByb2dyZXNzVXBkYXRlKGlkLCBwYXJ0TnVtYmVyLCAwKTtcblxuICAgICAgLy8gaWYgZmFsbGJhY2ssIHNldCB1cGxvYWQgbW9kZSB0byBpbnRlbGxpZ2VudCBhbmQgcmVzdGFydCBjdXJyZW50IHBhcnRcbiAgICAgIGlmICgodGhpcy51cGxvYWRNb2RlID09PSBVcGxvYWRNb2RlLkZBTExCQUNLICYmICF0aGlzLmlzTW9kZUxvY2tlZCkgfHwgdGhpcy51cGxvYWRNb2RlID09PSBVcGxvYWRNb2RlLklOVEVMTElHRU5UKSB7XG4gICAgICAgIGRlYnVnKGBbJHtpZH1dIFJlZ3VsYXIgdXBsb2FkIGZhaWxlZC4gU3dpdGNoaW5nIHRvIGludGVsbGlnZW50IGluZ2VzdGlvbiBtb2RlYCk7XG4gICAgICAgIHRoaXMuc2V0VXBsb2FkTW9kZShVcGxvYWRNb2RlLklOVEVMTElHRU5UKTtcbiAgICAgICAgLy8gcmVzdGFydCBwYXJ0XG4gICAgICAgIHJldHVybiB0aGlzLnN0YXJ0UGFydChpZCwgcGFydE51bWJlcik7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChuZXcgRmlsZXN0YWNrRXJyb3IoJ0Nhbm5vdCB1cGxvYWQgZmlsZSBwYXJ0JywgdGhpcy5nZXRFcnJvckRldGFpbHMoZXJyKSwgRmlsZXN0YWNrRXJyb3JUeXBlLlJFUVVFU1QpKTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBVcGxvYWQgZmlsZSB1c2luZyBpbnRlbGxpZ2VudCBtZWNoYW5pc21cbiAgICpcbiAgICogQHByaXZhdGVcbiAgICogQHBhcmFtIHtzdHJpbmd9IGlkXG4gICAqIEBwYXJhbSB7bnVtYmVyfSBwYXJ0TnVtYmVyXG4gICAqIEByZXR1cm5zIHtQcm9taXNlPGFueT59XG4gICAqIEBtZW1iZXJvZiBTM1VwbG9hZGVyXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIHVwbG9hZEludGVsbGlnZW50KGlkOiBzdHJpbmcsIHBhcnROdW1iZXI6IG51bWJlcik6IFByb21pc2U8YW55PiB7XG4gICAgcmV0dXJuIHRoaXMudXBsb2FkTmV4dENodW5rKGlkLCBwYXJ0TnVtYmVyKS50aGVuKCgpID0+IHRoaXMuY29tbWl0UGFydChpZCwgcGFydE51bWJlcikpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlY3Vyc2l2ZWx5IHVwbG9hZCBmaWxlIGluIGNodW5rIG1vZGUgKGludGVsbGlnZW50IGluZ2Vzc2lvbilcbiAgICpcbiAgICogQHByaXZhdGVcbiAgICogQHBhcmFtIHtzdHJpbmd9IGlkXG4gICAqIEBwYXJhbSB7bnVtYmVyfSBwYXJ0TnVtYmVyXG4gICAqIEBwYXJhbSB7bnVtYmVyfSBjaHVua1NpemVcbiAgICogQHJldHVybnNcbiAgICogQG1lbWJlcm9mIFMzVXBsb2FkZXJcbiAgICovXG4gIHByaXZhdGUgYXN5bmMgdXBsb2FkTmV4dENodW5rKGlkOiBzdHJpbmcsIHBhcnROdW1iZXI6IG51bWJlciwgY2h1bmtTaXplOiBudW1iZXIgPSB0aGlzLmludGVsbGlnZW50Q2h1bmtTaXplKSB7XG4gICAgY29uc3QgcGF5bG9hZCA9IHRoaXMuZ2V0UGF5bG9hZEJ5SWQoaWQpO1xuICAgIGxldCBwYXJ0ID0gcGF5bG9hZC5wYXJ0c1twYXJ0TnVtYmVyXTtcbiAgICBjaHVua1NpemUgPSBNYXRoLm1pbihjaHVua1NpemUsIHBhcnQuc2l6ZSAtIHBhcnQub2Zmc2V0KTtcblxuICAgIGxldCBjaHVuayA9IGF3YWl0IHBheWxvYWQuZmlsZS5nZXRDaHVua0J5TWV0YWRhdGEocGFydCwgcGFydC5vZmZzZXQsIGNodW5rU2l6ZSwgdGhpcy5pbnRlZ3JpdHlDaGVjayk7XG5cbiAgICBkZWJ1ZyhcbiAgICAgIGBbJHtpZH1dIFBhcnROdW06ICR7cGFydE51bWJlcn0sIFBhcnRTaXplOiAke3BhcnQuc2l6ZX0sIFN0YXJ0Qnl0ZTogJHtwYXJ0LnN0YXJ0Qnl0ZX0sIE9mZnNldDogJHtwYXJ0Lm9mZnNldH0sIENodW5rU2l6ZTogJHtjaHVuay5zaXplfSxcbiAgICAgICBMZWZ0OiAke3BhcnQuc2l6ZSAtIHBhcnQub2Zmc2V0IC0gY2h1bmsuc2l6ZX1gXG4gICAgKTtcblxuICAgIC8vIGNhdGNoIGVycm9yIGZvciBkZWJ1ZyBwdXJwb3Nlc1xuICAgIGNvbnN0IHsgZGF0YSB9ID0gYXdhaXQgdGhpcy5nZXRTM1BhcnRNZXRhZGF0YShpZCwgY2h1bmssIHBhcnQub2Zmc2V0KS5jYXRjaChlcnIgPT4ge1xuICAgICAgZGVidWcoYFske2lkfV0gR2V0dGluZyBjaHVuayBkYXRhIGZvciBpaSBmYWlsZWQgJU8sIENodW5rIHNpemU6ICR7Y2h1bmtTaXplfSwgb2Zmc2V0ICR7cGFydC5vZmZzZXR9LCBwYXJ0ICR7cGFydE51bWJlcn1gLCBlcnIpO1xuICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGVycik7XG4gICAgfSk7XG5cbiAgICByZXR1cm4gRnNSZXF1ZXN0LnB1dChkYXRhLnVybCwgY2h1bmsuYnVmZmVyLCB7XG4gICAgICBjYW5jZWxUb2tlbjogdGhpcy5jYW5jZWxUb2tlbixcbiAgICAgIHRpbWVvdXQ6IHRoaXMudGltZW91dCxcbiAgICAgIGhlYWRlcnM6IGRhdGEuaGVhZGVycyxcbiAgICAgIGZpbGVzdGFja0hlYWRlcnM6IGZhbHNlLFxuICAgICAgLy8gZm9yIG5vdyB3ZSBjYW50IHRlc3QgcHJvZ3Jlc3MgY2FsbGJhY2sgZnJvbSB1cGxvYWRcbiAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovXG4gICAgICBvblByb2dyZXNzOiAocHI6IFByb2dyZXNzRXZlbnQpID0+IHRoaXMub25Qcm9ncmVzc1VwZGF0ZShpZCwgcGFydE51bWJlciwgcGFydC5vZmZzZXQgKyBwci5sb2FkZWQpLFxuICAgIH0pXG4gICAgICAudGhlbihyZXMgPT4ge1xuICAgICAgICB0aGlzLm9uUHJvZ3Jlc3NVcGRhdGUoaWQsIHBhcnROdW1iZXIsIHBhcnQub2Zmc2V0ICsgY2h1bmsuc2l6ZSk7XG4gICAgICAgIGNvbnN0IG5ld09mZnNldCA9IE1hdGgubWluKHBhcnQub2Zmc2V0ICsgY2h1bmtTaXplLCBwYXJ0LnNpemUpO1xuXG4gICAgICAgIGRlYnVnKGBbJHtpZH1dIFMzIENodW5rIHVwbG9hZGVkISBvZmZzZXQ6ICR7cGFydC5vZmZzZXR9LCBwYXJ0ICR7cGFydE51bWJlcn0hIHJlc3BvbnNlIGhlYWRlcnMgZm9yICR7cGFydE51bWJlcn06IFxcbiVPXFxuYCwgcmVzLmhlYWRlcnMpO1xuICAgICAgICB0aGlzLnNldFBhcnREYXRhKGlkLCBwYXJ0TnVtYmVyLCAnb2Zmc2V0JywgbmV3T2Zmc2V0KTtcblxuICAgICAgICAvLyBpZiBhbGwgY2h1bmtzIHdhcyB1cGxvYWRlZCB0aGVuIHJldHVybiByZXNvbHZlXG4gICAgICAgIGlmIChuZXdPZmZzZXQgPT09IHBhcnQuc2l6ZSkge1xuICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUocmVzKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIHJlbGVhc2UgbWVtb3J5XG4gICAgICAgIHBhcnQgPSBudWxsO1xuICAgICAgICBjaHVuayA9IG51bGw7XG4gICAgICAgIHJldHVybiB0aGlzLnVwbG9hZE5leHRDaHVuayhpZCwgcGFydE51bWJlciwgY2h1bmtTaXplKTtcbiAgICAgIH0pXG4gICAgICAuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgY29uc3QgcmVzcCA9IGVyciAmJiBlcnIucmVzcG9uc2UgPyBlcnIucmVzcG9uc2UgOiBudWxsO1xuICAgICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqL1xuICAgICAgICBpZiAocmVzcCAmJiByZXNwLnN0YXR1cyA9PT0gNDAzKSB7XG4gICAgICAgICAgaWYgKHJlc3AuZGF0YSAmJiByZXNwLmRhdGEuRXJyb3IgJiYgcmVzcC5kYXRhLkVycm9yLmNvZGUpIHtcbiAgICAgICAgICAgIGxldCBjb2RlID0gcmVzcC5kYXRhLkVycm9yLmNvZGU7XG5cbiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGNvZGUpKSB7XG4gICAgICAgICAgICAgIGNvZGUgPSBjb2RlLnBvcCgpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBzd2l0Y2ggKGNvZGUpIHtcbiAgICAgICAgICAgICAgY2FzZSAnUmVxdWVzdFRpbWVUb29Ta2V3ZWQnOlxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnN0YXJ0UGFydChpZCwgcGFydE51bWJlcik7XG4gICAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KG5ldyBGaWxlc3RhY2tFcnJvcignQ2Fubm90IHVwbG9hZCBmaWxlJywgcmVzcC5kYXRhLkVycm9yLCBGaWxlc3RhY2tFcnJvclR5cGUuUkVRVUVTVCkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIC8vIHJlc2V0IHByb2dyZXNzIG9uIGZhaWxlZCB1cGxvYWRcbiAgICAgICAgdGhpcy5vblByb2dyZXNzVXBkYXRlKGlkLCBwYXJ0TnVtYmVyLCBwYXJ0Lm9mZnNldCk7XG4gICAgICAgIGNvbnN0IG5leHRDaHVua1NpemUgPSBjaHVua1NpemUgLyAyO1xuXG4gICAgICAgIGlmIChuZXh0Q2h1bmtTaXplIDwgTUlOX0NIVU5LX1NJWkUpIHtcbiAgICAgICAgICBkZWJ1ZyhgWyR7aWR9XSBNaW5pbWFsIGNodW5rIHNpemUgbGltaXQuIFVwbG9hZCBmaWxlIGZhaWxlZCFgKTtcbiAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QobmV3IEZpbGVzdGFja0Vycm9yKCdNaW4gY2h1bmsgc2l6ZSByZWFjaGVkJywgZXJyLmRhdGEsIEZpbGVzdGFja0Vycm9yVHlwZS5SRVFVRVNUKSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoc2hvdWxkUmV0cnkoZXJyKSkge1xuICAgICAgICAgIGRlYnVnKGBbJHtpZH1dIFJlcXVlc3QgbmV0d29yayBlcnJvci4gUmV0cnkgd2l0aCBuZXcgY2h1bmsgc2l6ZTogJHtuZXh0Q2h1bmtTaXplfWApO1xuICAgICAgICAgIHJldHVybiB0aGlzLnVwbG9hZE5leHRDaHVuayhpZCwgcGFydE51bWJlciwgbmV4dENodW5rU2l6ZSk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyByZWxlYXNlIG1lbW9yeVxuICAgICAgICBwYXJ0ID0gbnVsbDtcbiAgICAgICAgY2h1bmsgPSBudWxsO1xuXG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChuZXcgRmlsZXN0YWNrRXJyb3IoJ0Nhbm5vdCB1cGxvYWQgZmlsZSBwYXJ0IChGSUkpJywgdGhpcy5nZXRFcnJvckRldGFpbHMoZXJyKSwgRmlsZXN0YWNrRXJyb3JUeXBlLlJFUVVFU1QpKTtcbiAgICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIENvbW1pdCBhZnRlciB1cGxvYWQgYWxsIGNodW5rcyBvZiB0aGUgcGFydCBpbiBpaSBtb2RlXG4gICAqXG4gICAqIEBwcml2YXRlXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBpZFxuICAgKiBAcGFyYW0ge0ZpbGVQYXJ0fSBwYXJ0XG4gICAqIEByZXR1cm5zXG4gICAqIEBtZW1iZXJvZiBTM1VwbG9hZGVyXG4gICAqL1xuICBwcml2YXRlIGNvbW1pdFBhcnQoaWQ6IHN0cmluZywgcGFydE51bWJlcjogbnVtYmVyKSB7XG4gICAgY29uc3QgcGF5bG9hZCA9IHRoaXMuZ2V0UGF5bG9hZEJ5SWQoaWQpO1xuICAgIGNvbnN0IHBhcnQgPSBwYXlsb2FkLnBhcnRzW3BhcnROdW1iZXJdO1xuXG4gICAgcmV0dXJuIEZzUmVxdWVzdC5wb3N0KFxuICAgICAgYCR7dGhpcy5nZXRVcGxvYWRVcmwoaWQpfS9tdWx0aXBhcnQvY29tbWl0YCxcbiAgICAgIHtcbiAgICAgICAgLi4udGhpcy5nZXREZWZhdWx0RmllbGRzKGlkLCBbJ2FwaWtleScsICdyZWdpb24nLCAndXBsb2FkX2lkJywgJ3BvbGljeScsICdzaWduYXR1cmUnLCAndXJpJ10pLFxuICAgICAgICBzaXplOiBwYXlsb2FkLmZpbGUuc2l6ZSxcbiAgICAgICAgcGFydDogcGFydC5wYXJ0TnVtYmVyICsgMSxcbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgIGNhbmNlbFRva2VuOiB0aGlzLmNhbmNlbFRva2VuLFxuICAgICAgICB0aW1lb3V0OiB0aGlzLnRpbWVvdXQsXG4gICAgICAgIGhlYWRlcnM6IHRoaXMuZ2V0RGVmYXVsdEhlYWRlcnMoaWQpLFxuICAgICAgICByZXRyeTogdGhpcy5yZXRyeUNvbmZpZyxcbiAgICAgIH1cbiAgICApXG4gICAgICAudGhlbigocmVzOiBGc1Jlc3BvbnNlKSA9PiB7XG4gICAgICAgIGRlYnVnKGBbJHtpZH1dIENvbW1pdCBQYXJ0IG51bWJlciAke3BhcnQucGFydE51bWJlcn0uIFJlc3BvbnNlOiAlT2AsIHJlcy5kYXRhKTtcblxuICAgICAgICByZXR1cm4gcmVzO1xuICAgICAgfSlcbiAgICAgIC5jYXRjaChlcnIgPT4ge1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QobmV3IEZpbGVzdGFja0Vycm9yKCdDYW5ub3QgY29tbWl0IGZpbGUgcGFydCBtZXRhZGF0YScsIHRoaXMuZ2V0RXJyb3JEZXRhaWxzKGVyciksIEZpbGVzdGFja0Vycm9yVHlwZS5SRVFVRVNUKSk7XG4gICAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDb21wbGV0ZSByZXF1ZXN0IHRvIG1lcmdlIGFsbCBwYXJ0cyBhbmQgZ2V0IGZpbGUgaGFuZGxlIGV0Y1xuICAgKlxuICAgKiBAcHJpdmF0ZVxuICAgKiBAcmV0dXJuc1xuICAgKiBAbWVtYmVyb2YgUzNVcGxvYWRlclxuICAgKi9cbiAgcHJpdmF0ZSBjb21wbGV0ZVJlcXVlc3QoaWQ6IHN0cmluZyk6IFByb21pc2U8YW55PiB7XG4gICAgY29uc3QgcGF5bG9hZCA9IHRoaXMuZ2V0UGF5bG9hZEJ5SWQoaWQpO1xuICAgIGxldCBwYXJ0cyA9IFtdO1xuXG4gICAgZGVidWcoYFske2lkfV0gUnVuIGNvbXBsZXRlIHJlcXVlc3RgKTtcblxuICAgIGNvbnN0IHBhcnRzSGFuZGxlID0gcGF5bG9hZC5wYXJ0cztcbiAgICBjb25zdCBwYXJ0TGVuID0gcGFydHNIYW5kbGUubGVuZ3RoO1xuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwYXJ0TGVuOyBpKyspIHtcbiAgICAgIGlmIChwYXJ0c0hhbmRsZVtpXS5ldGFnKSB7XG4gICAgICAgIHBhcnRzLnB1c2goeyBwYXJ0X251bWJlcjogaSArIDEsIGV0YWc6IHBhcnRzSGFuZGxlW2ldLmV0YWcgfSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgZGVidWcoYFske2lkfV0gRXRhZ3MgJU9gLCBwYXJ0cyk7XG5cbiAgICByZXR1cm4gRnNSZXF1ZXN0LnBvc3QoXG4gICAgICBgJHt0aGlzLmdldFVybCgpfS9tdWx0aXBhcnQvY29tcGxldGVgLFxuICAgICAge1xuICAgICAgICAuLi50aGlzLmdldERlZmF1bHRGaWVsZHMoaWQsIFsnYXBpa2V5JywgJ3BvbGljeScsICdzaWduYXR1cmUnLCAndXJpJywgJ3JlZ2lvbicsICd1cGxvYWRfaWQnLCAnZmlpJ10sIHRydWUpLFxuICAgICAgICAvLyBtZXRob2Qgc3BlY2lmaWMga2V5c1xuICAgICAgICBmaWxlbmFtZTogcGF5bG9hZC5maWxlLm5hbWUsXG4gICAgICAgIG1pbWV0eXBlOiBwYXlsb2FkLmZpbGUudHlwZSxcbiAgICAgICAgc2l6ZTogcGF5bG9hZC5maWxlLnNpemUsXG4gICAgICAgIHVwbG9hZF90YWdzOiB0aGlzLnVwbG9hZFRhZ3MgJiYgT2JqZWN0LmtleXModGhpcy51cGxvYWRUYWdzKS5sZW5ndGggPyB0aGlzLnVwbG9hZFRhZ3MgOiB1bmRlZmluZWQsXG4gICAgICAgIHBhcnRzOiBwYXJ0cy5sZW5ndGggPyBwYXJ0cyA6IHVuZGVmaW5lZCxcbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgIHRpbWVvdXQ6IHRoaXMudGltZW91dCxcbiAgICAgICAgY2FuY2VsVG9rZW46IHRoaXMuY2FuY2VsVG9rZW4sXG4gICAgICAgIGhlYWRlcnM6IHRoaXMuZ2V0RGVmYXVsdEhlYWRlcnMoaWQpLFxuICAgICAgICByZXRyeTogdGhpcy5yZXRyeUNvbmZpZyxcbiAgICAgIH1cbiAgICApXG4gICAgICAudGhlbihyZXMgPT4ge1xuICAgICAgICAvLyBpZiBwYXJ0cyBoYXNudCBiZWVuIG1lcmdlZCwgcmV0cnkgY29tcGxldGUgcmVxdWVzdCBhZ2FpblxuICAgICAgICBpZiAocmVzLnN0YXR1cyA9PT0gMjAyKSB7XG4gICAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIHNldFRpbWVvdXQoXG4gICAgICAgICAgICAgICgpID0+XG4gICAgICAgICAgICAgICAgdGhpcy5jb21wbGV0ZVJlcXVlc3QoaWQpXG4gICAgICAgICAgICAgICAgICAudGhlbihyZXNvbHZlKVxuICAgICAgICAgICAgICAgICAgLmNhdGNoKHJlamVjdCksXG4gICAgICAgICAgICAgIENPTVBMRVRFX1RJTUVPVVRcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyB1cGRhdGUgZmlsZSBvYmplY3RcbiAgICAgICAgbGV0IGZpbGUgPSB0aGlzLmdldFBheWxvYWRCeUlkKGlkKS5maWxlO1xuXG4gICAgICAgIGZpbGUuaGFuZGxlID0gcmVzLmRhdGEuaGFuZGxlO1xuICAgICAgICBmaWxlLnVybCA9IHJlcy5kYXRhLnVybDtcbiAgICAgICAgZmlsZS5jb250YWluZXIgPSByZXMuZGF0YS5jb250YWluZXI7XG4gICAgICAgIGZpbGUua2V5ID0gcmVzLmRhdGEua2V5O1xuICAgICAgICBmaWxlLnVwbG9hZFRhZ3MgPSByZXMuZGF0YS51cGxvYWRfdGFncztcbiAgICAgICAgZmlsZS53b3JrZmxvd3MgPSByZXMuZGF0YS53b3JrZmxvd3M7XG4gICAgICAgIGZpbGUuc3RhdHVzID0gcmVzLmRhdGEuc3RhdHVzO1xuXG4gICAgICAgIHJldHVybiBmaWxlO1xuICAgICAgfSlcbiAgICAgIC5jYXRjaChlcnIgPT4ge1xuICAgICAgICB0aGlzLnNldFBheWxvYWRTdGF0dXMoaWQsIEZpbGVTdGF0ZS5GQUlMRUQpO1xuXG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChuZXcgRmlsZXN0YWNrRXJyb3IoJ0Nhbm5vdCBjb21wbGV0ZSBmaWxlJywgdGhpcy5nZXRFcnJvckRldGFpbHMoZXJyKSwgRmlsZXN0YWNrRXJyb3JUeXBlLlJFUVVFU1QpKTtcbiAgICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFVVcGdyYWRlIHVwbG9hZCBwcm9ncmVzcyBhbmQgcnVuIHByb2dyZXNzIGV2ZW50XG4gICAqXG4gICAqIEBwcml2YXRlXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBpZFxuICAgKiBAcGFyYW0ge251bWJlcn0gcGFydE51bWJlclxuICAgKiBAcGFyYW0ge251bWJlcn0gbG9hZGVkXG4gICAqIEBtZW1iZXJvZiBTM1VwbG9hZGVyXG4gICAqL1xuICBwcml2YXRlIG9uUHJvZ3Jlc3NVcGRhdGUoaWQ6IHN0cmluZywgcGFydE51bWJlcjogbnVtYmVyLCBsb2FkZWQ6IG51bWJlcikge1xuICAgIHRoaXMuc2V0UGFydERhdGEoaWQsIHBhcnROdW1iZXIsICdwcm9ncmVzcycsIGxvYWRlZCk7XG4gICAgdGhpcy5lbWl0UHJvZ3Jlc3MoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBFbWl0cyBub3JtYWxpemVkIHByb2dyZXNzIGV2ZW50XG4gICAqXG4gICAqIEBwcml2YXRlXG4gICAqIEBtZW1iZXJvZiBTM1VwbG9hZGVyXG4gICAqL1xuICBwcml2YXRlIGVtaXRQcm9ncmVzcygpIHtcbiAgICBsZXQgdG90YWxTaXplID0gMDtcbiAgICBsZXQgdG90YWxCeXRlcyA9IDA7XG5cbiAgICBsZXQgZmlsZXNQcm9ncmVzcyA9IHt9O1xuICAgIGZvciAobGV0IGkgaW4gdGhpcy5wYXlsb2Fkcykge1xuICAgICAgY29uc3QgcGF5bG9hZCA9IHRoaXMucGF5bG9hZHNbaV07XG4gICAgICAvLyBvbWl0IGFsbCBmYWlsZWQgZmlsZXMgaW4gcHJvZ3Jlc3MgZXZlbnRcbiAgICAgIC8vIHRoaXMgc2hvdWxkbid0IGhhcHBlbmQgYmVjYXVzZSBvZiBwcm9taXNlcyByZWplY3Rpb24gaW4gZXhlY3V0ZS4gTGVmdCB0byBiZSBzdXJlXG4gICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqL1xuICAgICAgaWYgKHBheWxvYWQuZmlsZS5zdGF0dXMgPT09IEZpbGVTdGF0ZS5GQUlMRUQpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHRvdGFsUGFydHMgPSBwYXlsb2FkLnBhcnRzLm1hcChwID0+IHAucHJvZ3Jlc3MgfHwgMCkucmVkdWNlKChhLCBiKSA9PiBhICsgYiwgMCk7XG5cbiAgICAgIHRvdGFsQnl0ZXMgPSB0b3RhbEJ5dGVzICsgdG90YWxQYXJ0cztcblxuICAgICAgZmlsZXNQcm9ncmVzc1tpXSA9IHtcbiAgICAgICAgdG90YWxCeXRlczogdG90YWxQYXJ0cyxcbiAgICAgICAgdG90YWxQZXJjZW50OiBNYXRoLnJvdW5kKCh0b3RhbFBhcnRzICogMTAwKSAvIHBheWxvYWQuZmlsZS5zaXplKSB8fCAwLFxuICAgICAgfTtcblxuICAgICAgdG90YWxTaXplID0gdG90YWxTaXplICsgcGF5bG9hZC5maWxlLnNpemU7XG4gICAgfVxuXG4gICAgY29uc3QgcmVzID0ge1xuICAgICAgdG90YWxCeXRlczogdG90YWxCeXRlcyB8fCAwLFxuICAgICAgdG90YWxQZXJjZW50OiBNYXRoLnJvdW5kKCh0b3RhbEJ5dGVzICogMTAwKSAvIHRvdGFsU2l6ZSkgfHwgMCxcbiAgICAgIGZpbGVzOiBmaWxlc1Byb2dyZXNzLFxuICAgIH07XG5cbiAgICBkZWJ1ZyhgVXBsb2FkIHByb2dyZXNzICVPYCwgcmVzKTtcbiAgICB0aGlzLmVtaXQoJ3Byb2dyZXNzJywgcmVzKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBcHBseSBwcm92aWRlZCBkYXRhIHRvIGdpdmVuIHBheWxvYWRcbiAgICpcbiAgICogQHByaXZhdGVcbiAgICogQHBhcmFtIHtzdHJpbmd9IGlkXG4gICAqIEBwYXJhbSB7Kn0gZGF0YVxuICAgKiBAbWVtYmVyb2YgUzNVcGxvYWRlclxuICAgKi9cbiAgcHJpdmF0ZSB1cGRhdGVQYXlsb2FkKGlkOiBzdHJpbmcsIGRhdGE6IGFueSkge1xuICAgIHRoaXMucGF5bG9hZHNbaWRdID0ge1xuICAgICAgLi4udGhpcy5wYXlsb2Fkc1tpZF0sXG4gICAgICAuLi5kYXRhLFxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogU2V0cyBldGFnIGZvciBwYXJ0XG4gICAqXG4gICAqIEBwcml2YXRlXG4gICAqIEBwYXJhbSB7bnVtYmVyfSBwYXJ0TnVtYmVyXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBldGFnXG4gICAqIEBtZW1iZXJvZiBTM1VwbG9hZGVyXG4gICAqL1xuICBwcml2YXRlIHNldFBhcnRFVGFnKGlkOiBzdHJpbmcsIHBhcnROdW1iZXI6IG51bWJlciwgZXRhZzogc3RyaW5nKSB7XG4gICAgZGVidWcoYFske2lkfV0gU2V0ICR7ZXRhZ30gZXRhZyBmb3IgcGFydCAke3BhcnROdW1iZXJ9YCk7XG4gICAgdGhpcy5nZXRQYXlsb2FkQnlJZChpZCkucGFydHNbcGFydE51bWJlcl0uZXRhZyA9IGV0YWc7XG4gIH1cblxuICAvKipcbiAgICogU2V0cyBwYXJ0IHZhbHVlIGZvciBhIGtleVxuICAgKlxuICAgKiBAcHJpdmF0ZVxuICAgKiBAcGFyYW0ge251bWJlcn0gcGFydE51bWJlclxuICAgKiBAcGFyYW0ge3N0cmluZ30gZXRhZ1xuICAgKiBAbWVtYmVyb2YgUzNVcGxvYWRlclxuICAgKi9cbiAgcHJpdmF0ZSBzZXRQYXJ0RGF0YShpZDogc3RyaW5nLCBwYXJ0TnVtYmVyOiBudW1iZXIsIGtleTogc3RyaW5nLCB2YWx1ZTogYW55KSB7XG4gICAgZGVidWcoYFske2lkfV0gU2V0ICR7a2V5fSA9ICR7dmFsdWV9IGZvciBwYXJ0ICR7cGFydE51bWJlcn1gKTtcblxuICAgIGNvbnN0IHBheWxvYWQgPSB0aGlzLmdldFBheWxvYWRCeUlkKGlkKTtcblxuICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovXG4gICAgaWYgKCFwYXlsb2FkKSB7XG4gICAgICBkZWJ1ZyhgWyR7aWR9XSBDYW5ub3Qgc2V0ICR7a2V5fSA9ICR7dmFsdWV9IGZvciBwYXJ0ICR7cGFydE51bWJlcn1gKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBwYXlsb2FkLnBhcnRzW3BhcnROdW1iZXJdW2tleV0gPSB2YWx1ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZXQgcGF5bG9hZCBmaWxlIHN0YXRlXG4gICAqXG4gICAqIEBwYXJhbSBpZFxuICAgKiBAcGFyYW0gc3RhdHVzXG4gICAqL1xuICBwcml2YXRlIHNldFBheWxvYWRTdGF0dXMoaWQ6IHN0cmluZywgc3RhdHVzOiBGaWxlU3RhdGUpIHtcbiAgICBkZWJ1ZyhgWyR7aWR9XSBTZXQgcGF5bG9hZCBzdGF0dXMgdG8gJHtzdGF0dXN9YCk7XG4gICAgLyogaXN0YW5idWwgaWdub3JlIG5leHQ6IGFkZGl0aW9uYWwgY2hlY2sgaW4gY2FzZSBpZiBmaWxlIHdpbGwgYmUgZGVsZXRlZCBiZWZvcmUgc2V0dGluZyBzdGF0dXMgKi9cbiAgICBpZiAoIXRoaXMucGF5bG9hZHNbaWRdKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5wYXlsb2Fkc1tpZF0uZmlsZS5zdGF0dXMgPSBzdGF0dXM7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyBlcnJvciBkZXRhaWxzIGlmIHJlc3BvbnNlIGV4aXN0c1xuICAgKlxuICAgKiBAcGFyYW0gZXJyXG4gICAqL1xuICBwcml2YXRlIGdldEVycm9yRGV0YWlscyhlcnI6IEZzUmVxdWVzdEVycm9yKSB7XG4gICAgaWYgKCFlcnIucmVzcG9uc2UpIHtcbiAgICAgIHJldHVybiB7fTtcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgY29kZTogZXJyLnJlc3BvbnNlLnN0YXR1cyxcbiAgICAgIGRhdGE6IGVyci5yZXNwb25zZS5kYXRhLFxuICAgICAgaGVhZGVyczogZXJyLnJlc3BvbnNlLmhlYWRlcnMsXG4gICAgfTtcbiAgfVxufVxuIl19

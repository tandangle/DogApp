/*
 * Copyright (c) 2018 by Filestack.
 * Some rights reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the 'License');
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an 'AS IS' BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { __assign, __awaiter, __generator } from "tslib";
// import { config } from './../../config';
import * as nock from 'nock';
import { Prefetch } from './prefetch';
import { FsRequestErrorCode } from '../request';
var testApiKey = 'AHv2222222222444444uez';
var testSecurity = {
    policy: 'examplePolicy',
    signature: 'exampleSignature',
};
var testURL = {
    fileApiUrl: '',
    uploadApiUrl: 'https://uploadtesturl-fs.com',
    cloudApiUrl: '',
    cdnUrl: '',
    pickerUrl: '',
    processUrl: '',
};
var testSession = {
    apikey: testApiKey,
    urls: testURL,
};
var scope = nock(testURL.uploadApiUrl);
// mock cors responses for all request for browser tests
scope.defaultReplyHeaders({
    'access-control-allow-origin': function (req) { return req.headers['origin']; },
    'access-control-allow-methods': function (req) { return req.headers['access-control-request-method']; },
    'access-control-allow-headers': function (req) { return req.headers['access-control-request-headers']; },
    'content-type': 'application/json',
});
describe('Prefetch', function () {
    beforeEach(function () {
        scope
            .options(/.*/)
            .reply(204);
    });
    it('Should make correct request to prefetch and return new config', function () { return __awaiter(void 0, void 0, void 0, function () {
        var sessionCopy, serverResponse, test, prefetch, res;
        return __generator(this, function (_a) {
            switch (_a.label) {
                case 0:
                    sessionCopy = __assign({}, testSession);
                    serverResponse = {
                        blocked: false,
                        settings: {
                            customsource: false,
                            inapp_browser: false,
                        },
                        permissions: {
                            transforms_ui: false,
                        },
                        updated_config: {
                            fromSources: ['googledrive'],
                        },
                    };
                    scope.post('/prefetch').once().reply(200, serverResponse);
                    test = function () { return 2; };
                    prefetch = new Prefetch(sessionCopy);
                    return [4 /*yield*/, prefetch.getConfig({
                            pickerOptions: {
                                // @ts-ignore
                                onFileSelected: test,
                                fromSources: ['googledrive', 'test'],
                            },
                        })];
                case 1:
                    res = _a.sent();
                    expect(res.pickerOptions.onFileSelected).toEqual(test);
                    expect(res.pickerOptions.fromSources).toEqual(['googledrive']);
                    scope.done();
                    return [2 /*return*/];
            }
        });
    }); });
    it('should set correct params to sessions (prefetch)', function () { return __awaiter(void 0, void 0, void 0, function () {
        var sessionCopy, serverResponse, prefetch, res;
        return __generator(this, function (_a) {
            switch (_a.label) {
                case 0:
                    sessionCopy = __assign({}, testSession);
                    serverResponse = {
                        blocked: false,
                        settings: {
                            customsource: false,
                            inapp_browser: true,
                        },
                        permissions: {
                            transforms_ui: true,
                        },
                        updated_config: {
                            fromSources: ['googledrive'],
                        },
                    };
                    scope.post('/prefetch').once().reply(200, serverResponse);
                    prefetch = new Prefetch(sessionCopy);
                    return [4 /*yield*/, prefetch.getConfig({
                            pickerOptions: {
                                fromSources: ['facebook', 'test'],
                            },
                        })];
                case 1:
                    res = _a.sent();
                    expect(sessionCopy.prefetch).toEqual(expect.any(Object));
                    expect(sessionCopy.prefetch.settings.inapp_browser).toEqual(true);
                    expect(sessionCopy.prefetch.permissions.transforms_ui).toEqual(true);
                    scope.done();
                    return [2 /*return*/];
            }
        });
    }); });
    it('should throw error when response code is other thant 200', function () { return __awaiter(void 0, void 0, void 0, function () {
        var sessionCopy, prefetch, err_1;
        return __generator(this, function (_a) {
            switch (_a.label) {
                case 0:
                    _a.trys.push([0, 2, , 3]);
                    sessionCopy = __assign({}, testSession);
                    prefetch = new Prefetch(sessionCopy);
                    scope.post('/prefetch').once().reply(500);
                    return [4 /*yield*/, prefetch.getConfig({})];
                case 1:
                    _a.sent();
                    return [3 /*break*/, 3];
                case 2:
                    err_1 = _a.sent();
                    expect(err_1.code).toEqual(FsRequestErrorCode.SERVER);
                    return [3 /*break*/, 3];
                case 3:
                    scope.done();
                    return [2 /*return*/];
            }
        });
    }); });
    it('should add security to request when provided', function () { return __awaiter(void 0, void 0, void 0, function () {
        var sessionCopy, mockPref, prefetch, res;
        return __generator(this, function (_a) {
            switch (_a.label) {
                case 0:
                    sessionCopy = __assign(__assign({}, testSession), { signature: testSecurity.signature, policy: testSecurity.policy });
                    mockPref = jest.fn().mockImplementation(function () { return ({}); });
                    scope.post('/prefetch').once().reply(200, function (_, data) { return mockPref(data); });
                    prefetch = new Prefetch(sessionCopy);
                    return [4 /*yield*/, prefetch.getConfig({
                            pickerOptions: {},
                        })];
                case 1:
                    res = _a.sent();
                    expect(mockPref).toHaveBeenCalledWith({
                        apikey: testApiKey,
                        settings: ['inapp_browser'],
                        security: {
                            signature: testSecurity.signature,
                            policy: testSecurity.policy,
                        },
                    });
                    scope.done();
                    return [2 /*return*/];
            }
        });
    }); });
    it('should always add inapp browser setting to request', function () { return __awaiter(void 0, void 0, void 0, function () {
        var mockPref, prefetch;
        return __generator(this, function (_a) {
            switch (_a.label) {
                case 0:
                    mockPref = jest.fn().mockImplementation(function () { return ({}); });
                    scope.post('/prefetch').once().reply(200, function (_, data) { return mockPref(data); });
                    prefetch = new Prefetch(__assign({}, testSession));
                    return [4 /*yield*/, prefetch.getConfig({})];
                case 1:
                    _a.sent();
                    expect(mockPref).toHaveBeenCalledWith({
                        apikey: testApiKey,
                        settings: ['inapp_browser'],
                    });
                    scope.done();
                    return [2 /*return*/];
            }
        });
    }); });
    it('should always add inapp browser setting to request event if some settings are provided', function () { return __awaiter(void 0, void 0, void 0, function () {
        var mockPref, prefetch;
        return __generator(this, function (_a) {
            switch (_a.label) {
                case 0:
                    mockPref = jest.fn().mockImplementation(function () { return ({}); });
                    scope.post('/prefetch').once().reply(200, function (_, data) { return mockPref(data); });
                    prefetch = new Prefetch(__assign({}, testSession));
                    return [4 /*yield*/, prefetch.getConfig({ settings: ['inapp_browser'] })];
                case 1:
                    _a.sent();
                    expect(mockPref).toHaveBeenCalledWith({
                        apikey: testApiKey,
                        settings: ['inapp_browser'],
                    });
                    scope.done();
                    return [2 /*return*/];
            }
        });
    }); });
    it('should return old config when updated_config is missing in response', function () { return __awaiter(void 0, void 0, void 0, function () {
        var sessionCopy, pickerOptions, prefetch, res;
        return __generator(this, function (_a) {
            switch (_a.label) {
                case 0:
                    sessionCopy = __assign(__assign({}, testSession), { signature: testSecurity.signature, policy: testSecurity.policy });
                    scope.post('/prefetch').once().reply(200, {
                        blocked: true,
                    });
                    pickerOptions = {
                        uploadInBackground: true,
                        onUploadDone: function () { return console.log; },
                        storeTo: {
                            location: 'asd',
                        },
                    };
                    prefetch = new Prefetch(sessionCopy);
                    return [4 /*yield*/, prefetch.getConfig({ pickerOptions: pickerOptions })];
                case 1:
                    res = _a.sent();
                    expect(res.pickerOptions).toEqual(pickerOptions);
                    scope.done();
                    return [2 /*return*/];
            }
        });
    }); });
});

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9saWIvYXBpL3ByZWZldGNoLnNwZWMuYnJvd3Nlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7Ozs7O0dBZUc7O0FBRUgsMkNBQTJDO0FBQzNDLE9BQU8sS0FBSyxJQUFJLE1BQU0sTUFBTSxDQUFDO0FBQzdCLE9BQU8sRUFBRSxRQUFRLEVBQWtCLE1BQU0sWUFBWSxDQUFDO0FBRXRELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLFlBQVksQ0FBQztBQUVoRCxJQUFNLFVBQVUsR0FBRyx3QkFBd0IsQ0FBQztBQUM1QyxJQUFNLFlBQVksR0FBYTtJQUM3QixNQUFNLEVBQUUsZUFBZTtJQUN2QixTQUFTLEVBQUUsa0JBQWtCO0NBQzlCLENBQUM7QUFFRixJQUFNLE9BQU8sR0FBRztJQUNkLFVBQVUsRUFBRSxFQUFFO0lBQ2QsWUFBWSxFQUFFLDhCQUE4QjtJQUM1QyxXQUFXLEVBQUUsRUFBRTtJQUNmLE1BQU0sRUFBRSxFQUFFO0lBQ1YsU0FBUyxFQUFFLEVBQUU7SUFDYixVQUFVLEVBQUUsRUFBRTtDQUNmLENBQUM7QUFFRixJQUFNLFdBQVcsR0FBWTtJQUMzQixNQUFNLEVBQUUsVUFBVTtJQUNsQixJQUFJLEVBQUUsT0FBTztDQUNkLENBQUM7QUFFRixJQUFJLEtBQUssR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxDQUFDO0FBRXZDLHdEQUF3RDtBQUN4RCxLQUFLLENBQUMsbUJBQW1CLENBQUM7SUFDeEIsNkJBQTZCLEVBQUUsVUFBQSxHQUFHLElBQUksT0FBQSxHQUFHLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxFQUFyQixDQUFxQjtJQUMzRCw4QkFBOEIsRUFBRSxVQUFBLEdBQUcsSUFBSSxPQUFBLEdBQUcsQ0FBQyxPQUFPLENBQUMsK0JBQStCLENBQUMsRUFBNUMsQ0FBNEM7SUFDbkYsOEJBQThCLEVBQUUsVUFBQSxHQUFHLElBQUksT0FBQSxHQUFHLENBQUMsT0FBTyxDQUFD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QUFBLE9BQU8sQ0FBQyxHQUFHLEVBQVgsQ0FBVzt3QkFDL0IsT0FBTyxFQUFFOzRCQUNQLFFBQVEsRUFBRSxLQUFLO3lCQUNoQjtxQkFDRixDQUFDO29CQUVJLFFBQVEsR0FBRyxJQUFJLFFBQVEsQ0FBQyxXQUFXLENBQUMsQ0FBQztvQkFDL0IscUJBQU0sUUFBUSxDQUFDLFNBQVMsQ0FBQyxFQUFFLGFBQWEsZUFBQSxFQUFFLENBQUMsRUFBQTs7b0JBQWpELEdBQUcsR0FBRyxTQUEyQztvQkFFdkQsTUFBTSxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUM7b0JBRWpELEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQzs7OztTQUNkLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwiZmlsZSI6ImxpYi9hcGkvcHJlZmV0Y2guc3BlYy5icm93c2VyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIENvcHlyaWdodCAoYykgMjAxOCBieSBGaWxlc3RhY2suXG4gKiBTb21lIHJpZ2h0cyByZXNlcnZlZC5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgJ0xpY2Vuc2UnKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiAnQVMgSVMnIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG4vLyBpbXBvcnQgeyBjb25maWcgfSBmcm9tICcuLy4uLy4uL2NvbmZpZyc7XG5pbXBvcnQgKiBhcyBub2NrIGZyb20gJ25vY2snO1xuaW1wb3J0IHsgUHJlZmV0Y2gsIFByZWZldGNoRXZlbnRzIH0gZnJvbSAnLi9wcmVmZXRjaCc7XG5pbXBvcnQgeyBTZXNzaW9uLCBTZWN1cml0eSB9IGZyb20gJy4vLi4vY2xpZW50JztcbmltcG9ydCB7IEZzUmVxdWVzdEVycm9yQ29kZSB9IGZyb20gJy4uL3JlcXVlc3QnO1xuXG5jb25zdCB0ZXN0QXBpS2V5ID0gJ0FIdjIyMjIyMjIyMjI0NDQ0NDR1ZXonO1xuY29uc3QgdGVzdFNlY3VyaXR5OiBTZWN1cml0eSA9IHtcbiAgcG9saWN5OiAnZXhhbXBsZVBvbGljeScsXG4gIHNpZ25hdHVyZTogJ2V4YW1wbGVTaWduYXR1cmUnLFxufTtcblxuY29uc3QgdGVzdFVSTCA9IHtcbiAgZmlsZUFwaVVybDogJycsXG4gIHVwbG9hZEFwaVVybDogJ2h0dHBzOi8vdXBsb2FkdGVzdHVybC1mcy5jb20nLFxuICBjbG91ZEFwaVVybDogJycsXG4gIGNkblVybDogJycsXG4gIHBpY2tlclVybDogJycsXG4gIHByb2Nlc3NVcmw6ICcnLFxufTtcblxuY29uc3QgdGVzdFNlc3Npb246IFNlc3Npb24gPSB7XG4gIGFwaWtleTogdGVzdEFwaUtleSxcbiAgdXJsczogdGVzdFVSTCxcbn07XG5cbmxldCBzY29wZSA9IG5vY2sodGVzdFVSTC51cGxvYWRBcGlVcmwpO1xuXG4vLyBtb2NrIGNvcnMgcmVzcG9uc2VzIGZvciBhbGwgcmVxdWVzdCBmb3IgYnJvd3NlciB0ZXN0c1xuc2NvcGUuZGVmYXVsdFJlcGx5SGVhZGVycyh7XG4gICdhY2Nlc3MtY29udHJvbC1hbGxvdy1vcmlnaW4nOiByZXEgPT4gcmVxLmhlYWRlcnNbJ29yaWdpbiddLFxuICAnYWNjZXNzLWNvbnRyb2wtYWxsb3ctbWV0aG9kcyc6IHJlcSA9PiByZXEuaGVhZGVyc1snYWNjZXNzLWNvbnRyb2wtcmVxdWVzdC1tZXRob2QnXSxcbiAgJ2FjY2Vzcy1jb250cm9sLWFsbG93LWhlYWRlcnMnOiByZXEgPT4gcmVxLmhlYWRlcnNbJ2FjY2Vzcy1jb250cm9sLXJlcXVlc3QtaGVhZGVycyddLFxuICAnY29udGVudC10eXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxufSk7XG5cbmRlc2NyaWJlKCdQcmVmZXRjaCcsICgpID0+IHtcbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgc2NvcGVcbiAgICAub3B0aW9ucygvLiovKVxuICAgIC5yZXBseSgyMDQpO1xuICB9KTtcblxuICBpdCgnU2hvdWxkIG1ha2UgY29ycmVjdCByZXF1ZXN0IHRvIHByZWZldGNoIGFuZCByZXR1cm4gbmV3IGNvbmZpZycsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBzZXNzaW9uQ29weSA9ICB7IC4uLnRlc3RTZXNzaW9uIH07XG5cbiAgICBjb25zdCBzZXJ2ZXJSZXNwb25zZSA9IHtcbiAgICAgIGJsb2NrZWQ6IGZhbHNlLFxuICAgICAgc2V0dGluZ3M6IHtcbiAgICAgICAgY3VzdG9tc291cmNlOiBmYWxzZSxcbiAgICAgICAgaW5hcHBfYnJvd3NlcjogZmFsc2UsXG4gICAgICB9LFxuICAgICAgcGVybWlzc2lvbnM6IHtcbiAgICAgICAgdHJhbnNmb3Jtc191aTogZmFsc2UsXG4gICAgICB9LFxuICAgICAgdXBkYXRlZF9jb25maWc6IHtcbiAgICAgICAgZnJvbVNvdXJjZXM6IFsnZ29vZ2xlZHJpdmUnXSxcbiAgICAgIH0sXG4gICAgfTtcblxuICAgIHNjb3BlLnBvc3QoJy9wcmVmZXRjaCcpLm9uY2UoKS5yZXBseSgyMDAsIHNlcnZlclJlc3BvbnNlKTtcblxuICAgIGNvbnN0IHRlc3QgPSAoKSA9PiAyO1xuXG4gICAgY29uc3QgcHJlZmV0Y2ggPSBuZXcgUHJlZmV0Y2goc2Vzc2lvbkNvcHkpO1xuICAgIGNvbnN0IHJlcyA9IGF3YWl0IHByZWZldGNoLmdldENvbmZpZyh7XG4gICAgICBwaWNrZXJPcHRpb25zOiB7XG4gICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgb25GaWxlU2VsZWN0ZWQ6IHRlc3QsXG4gICAgICAgIGZyb21Tb3VyY2VzOiBbJ2dvb2dsZWRyaXZlJywgJ3Rlc3QnXSxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBleHBlY3QocmVzLnBpY2tlck9wdGlvbnMub25GaWxlU2VsZWN0ZWQpLnRvRXF1YWwodGVzdCk7XG4gICAgZXhwZWN0KHJlcy5waWNrZXJPcHRpb25zLmZyb21Tb3VyY2VzKS50b0VxdWFsKFsnZ29vZ2xlZHJpdmUnXSk7XG5cbiAgICBzY29wZS5kb25lKCk7XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgc2V0IGNvcnJlY3QgcGFyYW1zIHRvIHNlc3Npb25zIChwcmVmZXRjaCknLCBhc3luYyAoKSA9PiB7XG4gICAgY29uc3Qgc2Vzc2lvbkNvcHkgPSAgeyAuLi50ZXN0U2Vzc2lvbiB9O1xuICAgIGNvbnN0IHNlcnZlclJlc3BvbnNlID0ge1xuICAgICAgYmxvY2tlZDogZmFsc2UsXG4gICAgICBzZXR0aW5nczoge1xuICAgICAgICBjdXN0b21zb3VyY2U6IGZhbHNlLFxuICAgICAgICBpbmFwcF9icm93c2VyOiB0cnVlLFxuICAgICAgfSxcbiAgICAgIHBlcm1pc3Npb25zOiB7XG4gICAgICAgIHRyYW5zZm9ybXNfdWk6IHRydWUsXG4gICAgICB9LFxuICAgICAgdXBkYXRlZF9jb25maWc6IHtcbiAgICAgICAgZnJvbVNvdXJjZXM6IFsnZ29vZ2xlZHJpdmUnXSxcbiAgICAgIH0sXG4gICAgfTtcblxuICAgIHNjb3BlLnBvc3QoJy9wcmVmZXRjaCcpLm9uY2UoKS5yZXBseSgyMDAsIHNlcnZlclJlc3BvbnNlKTtcblxuICAgIGNvbnN0IHByZWZldGNoID0gbmV3IFByZWZldGNoKHNlc3Npb25Db3B5KTtcbiAgICBjb25zdCByZXMgPSBhd2FpdCBwcmVmZXRjaC5nZXRDb25maWcoe1xuICAgICAgcGlja2VyT3B0aW9uczoge1xuICAgICAgICBmcm9tU291cmNlczogWydmYWNlYm9vaycsICd0ZXN0J10sXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgZXhwZWN0KHNlc3Npb25Db3B5LnByZWZldGNoKS50b0VxdWFsKGV4cGVjdC5hbnkoT2JqZWN0KSk7XG4gICAgZXhwZWN0KHNlc3Npb25Db3B5LnByZWZldGNoLnNldHRpbmdzLmluYXBwX2Jyb3dzZXIpLnRvRXF1YWwodHJ1ZSk7XG4gICAgZXhwZWN0KHNlc3Npb25Db3B5LnByZWZldGNoLnBlcm1pc3Npb25zLnRyYW5zZm9ybXNfdWkpLnRvRXF1YWwodHJ1ZSk7XG5cbiAgICBzY29wZS5kb25lKCk7XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgdGhyb3cgZXJyb3Igd2hlbiByZXNwb25zZSBjb2RlIGlzIG90aGVyIHRoYW50IDIwMCcsIGFzeW5jICgpID0+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3Qgc2Vzc2lvbkNvcHkgPSAgeyAuLi50ZXN0U2Vzc2lvbiB9O1xuICAgICAgY29uc3QgcHJlZmV0Y2ggPSBuZXcgUHJlZmV0Y2goc2Vzc2lvbkNvcHkpO1xuXG4gICAgICBzY29wZS5wb3N0KCcvcHJlZmV0Y2gnKS5vbmNlKCkucmVwbHkoNTAwKTtcblxuICAgICAgYXdhaXQgcHJlZmV0Y2guZ2V0Q29uZmlnKHt9KTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGV4cGVjdChlcnIuY29kZSkudG9FcXVhbChGc1JlcXVlc3RFcnJvckNvZGUuU0VSVkVSKTtcbiAgICB9XG5cbiAgICBzY29wZS5kb25lKCk7XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgYWRkIHNlY3VyaXR5IHRvIHJlcXVlc3Qgd2hlbiBwcm92aWRlZCcsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBzZXNzaW9uQ29weSA9ICB7XG4gICAgICAuLi50ZXN0U2Vzc2lvbixcbiAgICAgIHNpZ25hdHVyZTogdGVzdFNlY3VyaXR5LnNpZ25hdHVyZSxcbiAgICAgIHBvbGljeTogdGVzdFNlY3VyaXR5LnBvbGljeSxcbiAgICB9O1xuXG4gICAgY29uc3QgbW9ja1ByZWYgPSBqZXN0LmZuKCkgLm1vY2tJbXBsZW1lbnRhdGlvbigoKSA9PiAoe30pKTtcblxuICAgIHNjb3BlLnBvc3QoJy9wcmVmZXRjaCcpLm9uY2UoKS5yZXBseSgyMDAsIChfLCBkYXRhKSA9PiBtb2NrUHJlZihkYXRhKSk7XG5cbiAgICBjb25zdCBwcmVmZXRjaCA9IG5ldyBQcmVmZXRjaChzZXNzaW9uQ29weSk7XG4gICAgY29uc3QgcmVzID0gYXdhaXQgcHJlZmV0Y2guZ2V0Q29uZmlnKHtcbiAgICAgIHBpY2tlck9wdGlvbnM6IHt9LFxuICAgIH0pO1xuXG4gICAgZXhwZWN0KG1vY2tQcmVmKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCh7XG4gICAgICBhcGlrZXk6IHRlc3RBcGlLZXksXG4gICAgICBzZXR0aW5nczogWydpbmFwcF9icm93c2VyJ10sXG4gICAgICBzZWN1cml0eToge1xuICAgICAgICBzaWduYXR1cmU6IHRlc3RTZWN1cml0eS5zaWduYXR1cmUsXG4gICAgICAgIHBvbGljeTogdGVzdFNlY3VyaXR5LnBvbGljeSxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBzY29wZS5kb25lKCk7XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgYWx3YXlzIGFkZCBpbmFwcCBicm93c2VyIHNldHRpbmcgdG8gcmVxdWVzdCcsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBtb2NrUHJlZiA9IGplc3QuZm4oKSAubW9ja0ltcGxlbWVudGF0aW9uKCgpID0+ICh7fSkpO1xuICAgIHNjb3BlLnBvc3QoJy9wcmVmZXRjaCcpLm9uY2UoKS5yZXBseSgyMDAsIChfLCBkYXRhKSA9PiBtb2NrUHJlZihkYXRhKSk7XG5cbiAgICBjb25zdCBwcmVmZXRjaCA9IG5ldyBQcmVmZXRjaCh7IC4uLnRlc3RTZXNzaW9uIH0pO1xuICAgIGF3YWl0IHByZWZldGNoLmdldENvbmZpZyh7fSk7XG5cbiAgICBleHBlY3QobW9ja1ByZWYpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKHtcbiAgICAgIGFwaWtleTogdGVzdEFwaUtleSxcbiAgICAgIHNldHRpbmdzOiBbJ2luYXBwX2Jyb3dzZXInXSxcbiAgICB9KTtcblxuICAgIHNjb3BlLmRvbmUoKTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCBhbHdheXMgYWRkIGluYXBwIGJyb3dzZXIgc2V0dGluZyB0byByZXF1ZXN0IGV2ZW50IGlmIHNvbWUgc2V0dGluZ3MgYXJlIHByb3ZpZGVkJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IG1vY2tQcmVmID0gamVzdC5mbigpIC5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4gKHt9KSk7XG4gICAgc2NvcGUucG9zdCgnL3ByZWZldGNoJykub25jZSgpLnJlcGx5KDIwMCwgKF8sIGRhdGEpID0+IG1vY2tQcmVmKGRhdGEpKTtcblxuICAgIGNvbnN0IHByZWZldGNoID0gbmV3IFByZWZldGNoKHsgLi4udGVzdFNlc3Npb24gfSk7XG4gICAgYXdhaXQgcHJlZmV0Y2guZ2V0Q29uZmlnKHsgc2V0dGluZ3M6IFsnaW5hcHBfYnJvd3NlciddIH0pO1xuXG4gICAgZXhwZWN0KG1vY2tQcmVmKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCh7XG4gICAgICBhcGlrZXk6IHRlc3RBcGlLZXksXG4gICAgICBzZXR0aW5nczogWydpbmFwcF9icm93c2VyJ10sXG4gICAgfSk7XG5cbiAgICBzY29wZS5kb25lKCk7XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgcmV0dXJuIG9sZCBjb25maWcgd2hlbiB1cGRhdGVkX2NvbmZpZyBpcyBtaXNzaW5nIGluIHJlc3BvbnNlJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IHNlc3Npb25Db3B5ID0gIHtcbiAgICAgIC4uLnRlc3RTZXNzaW9uLFxuICAgICAgc2lnbmF0dXJlOiB0ZXN0U2VjdXJpdHkuc2lnbmF0dXJlLFxuICAgICAgcG9saWN5OiB0ZXN0U2VjdXJpdHkucG9saWN5LFxuICAgIH07XG5cbiAgICBzY29wZS5wb3N0KCcvcHJlZmV0Y2gnKS5vbmNlKCkucmVwbHkoMjAwLCB7XG4gICAgICBibG9ja2VkOiB0cnVlLFxuICAgIH0pO1xuXG4gICAgY29uc3QgcGlja2VyT3B0aW9ucyA9IHtcbiAgICAgIHVwbG9hZEluQmFja2dyb3VuZDogdHJ1ZSxcbiAgICAgIG9uVXBsb2FkRG9uZTogKCkgPT4gY29uc29sZS5sb2csXG4gICAgICBzdG9yZVRvOiB7XG4gICAgICAgIGxvY2F0aW9uOiAnYXNkJyxcbiAgICAgIH0sXG4gICAgfTtcblxuICAgIGNvbnN0IHByZWZldGNoID0gbmV3IFByZWZldGNoKHNlc3Npb25Db3B5KTtcbiAgICBjb25zdCByZXMgPSBhd2FpdCBwcmVmZXRjaC5nZXRDb25maWcoeyBwaWNrZXJPcHRpb25zIH0pO1xuXG4gICAgZXhwZWN0KHJlcy5waWNrZXJPcHRpb25zKS50b0VxdWFsKHBpY2tlck9wdGlvbnMpO1xuXG4gICAgc2NvcGUuZG9uZSgpO1xuICB9KTtcbn0pO1xuIl19

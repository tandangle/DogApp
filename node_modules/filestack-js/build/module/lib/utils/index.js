/*
 * Copyright (c) 2018 by Filestack.
 * Some rights reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { __assign } from "tslib";
import { Map } from './extensions';
import fileType from 'file-type';
import * as isutf8 from 'isutf8';
// more info https://gist.github.com/AshHeskes/6038140
var extensionToMime = {
    'text/vnd.dvb.subtitle': 'sub',
    'application/x-msmetafile': 'wmz',
    'application/x-msi': 'msi',
    'application/x-ms': 'ms',
    'application/atom+xml': 'atom',
    'application/json': ['json', 'map', 'topojson'],
    'application/ld+json': 'jsonld',
    'application/rss+xml': 'rss',
    'application/vnd.geo+json': 'geojson',
    'application/xml': ['rdf', 'xml'],
    'application/javascript': 'js',
    'application/manifest+json': 'webmanifest',
    'application/x-web-app-manifest+json': 'webapp',
    'text/cache-manifest': 'appcache',
    'image/x-icon': ['cur', 'ico'],
    'application/msword': 'doc',
    'application/vnd.ms-excel': 'xls',
    'application/vnd.ms-powerpoint': 'ppt',
    'application/vnd.openxmlformats-officedocument.wordprocessingml.document': 'docx',
    'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': 'xlsx',
    'application/vnd.openxmlformats-officedocument.presentationml.presentation': 'pptx',
    'application/vnd.debian.binary-package': 'deb',
    'application/font-woff': 'woff',
    'application/font-woff2': 'woff2',
    'application/vnd.ms-fontobject': 'eot',
    'application/x-font-ttf': ['ttc', 'ttf'],
    'font/opentype': 'otf',
    'application/java-archive': ['ear', 'jar', 'war'],
    'application/mac-binhex40': 'hqx',
    'application/octet-stream': ['bin', 'deb', 'dll', 'dmg', 'img', 'iso', 'msi', 'msm', 'msp', 'safariextz'],
    'application/postscript': ['ai', 'eps', 'ps'],
    'application/rtf': 'rtf',
    'application/vnd.google-earth.kml+xml': 'kml',
    'application/vnd.google-earth.kmz': 'kmz',
    'application/vnd.wap.wmlc': 'wmlc',
    'application/x-7z-compressed': '7z',
    'application/x-bb-appworld': 'bbaw',
    'application/x-bittorrent': 'torrent',
    'application/x-chrome-extension': 'crx',
    'application/x-cocoa': 'cco',
    'application/x-java-archive-diff': 'jardiff',
    'application/x-java-jnlp-file': 'jnlp',
    'application/x-makeself': 'run',
    'application/x-cd-image': 'iso',
    'application/x-opera-extension': 'oex',
    'application/x-perl': ['pl', 'pm'],
    'application/x-pilot': ['pdb', 'prc'],
    'application/x-rar-compressed': 'rar',
    'application/x-redhat-package-manager': 'rpm',
    'application/x-sea': 'sea',
    'application/x-shockwave-flash': 'swf',
    'application/x-stuffit': 'sit',
    'application/x-tcl': ['tcl', 'tk'],
    'application/x-x509-ca-cert': ['crt', 'der', 'pem'],
    'application/x-xpinstall': 'xpi',
    'application/x-ms-dos-executable': 'exe',
    'application/xhtml+xml': 'xhtml',
    'application/xslt+xml': 'xsl',
    'application/zip': 'zip',
    'text/css': 'css',
    'text/csv': 'csv',
    'text/html': ['htm', 'html', 'shtml'],
    'text/markdown': 'md',
    'text/mathml': 'mml',
    'text/plain': 'txt',
    'text/vcard': ['vcard', 'vcf'],
    'text/vnd.rim.location.xloc': 'xloc',
    'text/vnd.sun.j2me.app-descriptor': 'jad',
    'text/vnd.wap.wml': 'wml',
    'text/vtt': 'vtt',
    'text/x-component': 'htc',
    'application/x-desktop': 'desktop',
    'text/x-markdown': 'md',
    'application/x-typescript': 'ts',
    'application/x-java-archive': 'jar',
    'application/x-sharedlib': 'so',
};
/**
 * Resolve cdn url based on handle type
 *
 * @private
 * @param session session object
 * @param handle file handle (hash, src://alias, url)
 */
export var resolveCdnUrl = function (session, handle) {
    var cdnURL = session.urls.cdnUrl;
    if (handle && (handle.indexOf('src:') === 0 || handle.indexOf('http') === 0)) {
        if (!session.apikey) {
            throw new Error('Api key is required when storage alias is provided');
        }
        // apikey is required for alias or external sources call
        return cdnURL + "/" + session.apikey;
    }
    return cdnURL;
};
/**
 * Resolve all urls with provided cnames
 *
 * @private
 * @param urls
 * @param cname
 */
export var resolveHost = function (urls, cname) {
    if (!cname) {
        return urls;
    }
    var hosts = /filestackapi.com|filestackcontent.com/i;
    Object.keys(urls).forEach(function (key) {
        urls[key] = urls[key].replace(hosts, cname);
    });
    return urls;
};
/**
 * Removes empty options from object
 *
 * @private
 * @param obj
 */
export var removeEmpty = function (obj) {
    var newObj = __assign({}, obj);
    Object.keys(newObj).forEach(function (k) { return !newObj[k] && typeof newObj[k] !== 'boolean' && delete newObj[k]; });
    return newObj;
};
/**
 * Returns unique time
 */
var last;
export var uniqueTime = function () {
    var time = Date.now();
    last = time === last ? time + 1 : time;
    return last;
};
/**
 * Generates random string with provided length
 *
 * @param len
 */
export var uniqueId = function (len) {
    if (len === void 0) { len = 10; }
    return new Array(len).join().replace(/(.|$)/g, function () { return ((Math.random() * 36) | 0).toString(36)[Math.random() < 0.5 ? 'toString' : 'toUpperCase'](); });
};
/**
 * Check if input is a svg
 *
 * @param {Uint8Array | Buffer} file
 * @returns {string} - mimetype
 */
export var getMimetype = function (file, name) {
    var type = fileType(file);
    if (type && ['text/plain', 'application/octet-stream', 'application/x-ms', 'application/x-msi'].indexOf(type.mime) === -1) {
        return type.mime;
    }
    if (name && name.indexOf('.') > -1) {
        var ext = name.split('.').pop();
        var keys = Object.keys(Map);
        var mapLen = keys.length;
        for (var i = 0; i < mapLen; i++) {
            if (Map[keys[i]].indexOf(ext) > -1) {
                return keys[i];
            }
        }
    }
    try {
        if (isutf8(file)) {
            return 'text/plain';
        }
    }
    catch (e) {
        /* istanbul ignore next */
        console.warn('Additional mimetype checks (text/plain) are currently not supported for browsers');
    }
    // this is only fallback, omit it in coverage
    /* istanbul ignore next */
    return 'application/octet-stream';
};
/**
 * Sanitize file name
 *
 * @param name
 * @param {bool} options  - enable,disable sanitizer, default enabled
 * @param {string} options.replacement - replacement for sanitized chars defaults to "-"
 * @param {string[]} options.exclude - array with excluded chars default - ['\', '{', '}','|', '%', '`', '"', "'", '~', '[', ']', '#', '|', '^', '<', '>']
 */
export var sanitizeName = function (name, options) {
    if (options === void 0) { options = true; }
    if (typeof options === 'boolean' && !options) {
        return name;
    }
    var ext;
    var replacement = typeof options !== 'boolean' && options.replacement ? options.replacement : '-';
    var exclude = typeof options !== 'boolean' && options.exclude ? options.exclude : ['\\', '{', '}', '|', '%', '`', '"', "'", '~', '[', ']', '#', '|', '^', '<', '>'];
    if (!name || name.length === 0) {
        return 'undefined';
    }
    var fileParts = name.split('.');
    if (fileParts.length > 1) {
        ext = fileParts.pop();
    }
    return "" + fileParts
        .join('.')
        .split('')
        .map(function (char) { return (exclude.indexOf(char) > -1 ? replacement : char); })
        .join('') + (ext ? '.' + ext : '');
};
/**
 * Filter object to given fields
 *
 * @param toFilter
 * @param requiredFields
 */
export var filterObject = function (toFilter, requiredFields) {
    if (!requiredFields || requiredFields.length === 0) {
        return toFilter;
    }
    if (Object.keys(toFilter).length === 0) {
        return toFilter;
    }
    return Object.keys(toFilter)
        .filter(function (f) { return requiredFields.indexOf(f) > -1; })
        .reduce(function (obj, key) {
        var _a;
        return (__assign(__assign({}, obj), (_a = {}, _a[key] = toFilter[key], _a)));
    }, {});
};
/**
 * Deep cleanup object from functions
 *
 * @param obj
 */
export var cleanUpCallbacks = function (obj) {
    if (!obj || Object.keys(obj).length === 0) {
        return obj;
    }
    Object.keys(obj).forEach(function (k) {
        if (typeof obj[k] === 'function') {
            obj[k] = undefined;
        }
        if (obj[k] === Object(obj[k])) {
            obj[k] = cleanUpCallbacks(obj[k]);
        }
    });
    return obj;
};
export * from './index.node';

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9saWIvdXRpbHMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7Ozs7Ozs7OztHQWVHOztBQUlILE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFDbkMsT0FBTyxRQUFRLE1BQU0sV0FBVyxDQUFDO0FBQ2pDLE9BQU8sS0FBSyxNQUFNLE1BQU0sUUFBUSxDQUFDO0FBRWpDLHNEQUFzRDtBQUN0RCxJQUFNLGVBQWUsR0FBRztJQUN0Qix1QkFBdUIsRUFBRSxLQUFLO0lBQzlCLDBCQUEwQixFQUFFLEtBQUs7SUFDakMsbUJBQW1CLEVBQUUsS0FBSztJQUMxQixrQkFBa0IsRUFBRSxJQUFJO0lBQ3hCLHNCQUFzQixFQUFFLE1BQU07SUFDOUIsa0JBQWtCLEVBQUUsQ0FBQyxNQUFNLEVBQUUsS0FBSyxFQUFFLFVBQVUsQ0FBQztJQUMvQyxxQkFBcUIsRUFBRSxRQUFRO0lBQy9CLHFCQUFxQixFQUFFLEtBQUs7SUFDNUIsMEJBQTBCLEVBQUUsU0FBUztJQUNyQyxpQkFBaUIsRUFBRSxDQUFDLEtBQUssRUFBRSxLQUFLLENBQUM7SUFDakMsd0JBQXdCLEVBQUUsSUFBSTtJQUM5QiwyQkFBMkIsRUFBRSxhQUFhO0lBQzFDLHFDQUFxQyxFQUFFLFFBQVE7SUFDL0MscUJBQXFCLEVBQUUsVUFBVTtJQUNqQyxjQUFjLEVBQUUsQ0FBQyxLQUFLLEVBQUUsS0FBSyxDQUFDO0lBQzlCLG9CQUFvQixFQUFFLEtBQUs7SUFDM0IsMEJBQTBCLEVBQUUsS0FBSztJQUNqQywrQkFBK0IsRUFBRSxLQUFLO0lBQ3RDLHlFQUF5RSxFQUFFLE1BQU07SUFDakYsbUVBQW1FLEVBQUUsTUFBTTtJQUMzRSwyRUFBMkUsRUFBRSxNQUFNO0lBQ25GLHVDQUF1QyxFQUFFLEtBQUs7SUFDOUMsdUJBQXVCLEVBQUUsTUFBTTtJQUMvQix3QkFBd0IsRUFBRSxPQUFPO0lBQ2pDLCtCQUErQixFQUFFLEtBQUs7SUFDdEMsd0JBQXdC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QztBQUVGLGNBQWMsY0FBYyxDQUFDIiwiZmlsZSI6ImxpYi91dGlscy9pbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTggYnkgRmlsZXN0YWNrLlxuICogU29tZSByaWdodHMgcmVzZXJ2ZWQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7IFNlc3Npb24gfSBmcm9tICcuLi9jbGllbnQnO1xuaW1wb3J0IHsgSG9zdHMgfSBmcm9tICcuLy4uLy4uL2NvbmZpZyc7XG5pbXBvcnQgeyBNYXAgfSBmcm9tICcuL2V4dGVuc2lvbnMnO1xuaW1wb3J0IGZpbGVUeXBlIGZyb20gJ2ZpbGUtdHlwZSc7XG5pbXBvcnQgKiBhcyBpc3V0ZjggZnJvbSAnaXN1dGY4JztcblxuLy8gbW9yZSBpbmZvIGh0dHBzOi8vZ2lzdC5naXRodWIuY29tL0FzaEhlc2tlcy82MDM4MTQwXG5jb25zdCBleHRlbnNpb25Ub01pbWUgPSB7XG4gICd0ZXh0L3ZuZC5kdmIuc3VidGl0bGUnOiAnc3ViJyxcbiAgJ2FwcGxpY2F0aW9uL3gtbXNtZXRhZmlsZSc6ICd3bXonLFxuICAnYXBwbGljYXRpb24veC1tc2knOiAnbXNpJyxcbiAgJ2FwcGxpY2F0aW9uL3gtbXMnOiAnbXMnLFxuICAnYXBwbGljYXRpb24vYXRvbSt4bWwnOiAnYXRvbScsXG4gICdhcHBsaWNhdGlvbi9qc29uJzogWydqc29uJywgJ21hcCcsICd0b3BvanNvbiddLFxuICAnYXBwbGljYXRpb24vbGQranNvbic6ICdqc29ubGQnLFxuICAnYXBwbGljYXRpb24vcnNzK3htbCc6ICdyc3MnLFxuICAnYXBwbGljYXRpb24vdm5kLmdlbytqc29uJzogJ2dlb2pzb24nLFxuICAnYXBwbGljYXRpb24veG1sJzogWydyZGYnLCAneG1sJ10sXG4gICdhcHBsaWNhdGlvbi9qYXZhc2NyaXB0JzogJ2pzJyxcbiAgJ2FwcGxpY2F0aW9uL21hbmlmZXN0K2pzb24nOiAnd2VibWFuaWZlc3QnLFxuICAnYXBwbGljYXRpb24veC13ZWItYXBwLW1hbmlmZXN0K2pzb24nOiAnd2ViYXBwJyxcbiAgJ3RleHQvY2FjaGUtbWFuaWZlc3QnOiAnYXBwY2FjaGUnLFxuICAnaW1hZ2UveC1pY29uJzogWydjdXInLCAnaWNvJ10sXG4gICdhcHBsaWNhdGlvbi9tc3dvcmQnOiAnZG9jJyxcbiAgJ2FwcGxpY2F0aW9uL3ZuZC5tcy1leGNlbCc6ICd4bHMnLFxuICAnYXBwbGljYXRpb24vdm5kLm1zLXBvd2VycG9pbnQnOiAncHB0JyxcbiAgJ2FwcGxpY2F0aW9uL3ZuZC5vcGVueG1sZm9ybWF0cy1vZmZpY2Vkb2N1bWVudC53b3JkcHJvY2Vzc2luZ21sLmRvY3VtZW50JzogJ2RvY3gnLFxuICAnYXBwbGljYXRpb24vdm5kLm9wZW54bWxmb3JtYXRzLW9mZmljZWRvY3VtZW50LnNwcmVhZHNoZWV0bWwuc2hlZXQnOiAneGxzeCcsXG4gICdhcHBsaWNhdGlvbi92bmQub3BlbnhtbGZvcm1hdHMtb2ZmaWNlZG9jdW1lbnQucHJlc2VudGF0aW9ubWwucHJlc2VudGF0aW9uJzogJ3BwdHgnLFxuICAnYXBwbGljYXRpb24vdm5kLmRlYmlhbi5iaW5hcnktcGFja2FnZSc6ICdkZWInLFxuICAnYXBwbGljYXRpb24vZm9udC13b2ZmJzogJ3dvZmYnLFxuICAnYXBwbGljYXRpb24vZm9udC13b2ZmMic6ICd3b2ZmMicsXG4gICdhcHBsaWNhdGlvbi92bmQubXMtZm9udG9iamVjdCc6ICdlb3QnLFxuICAnYXBwbGljYXRpb24veC1mb250LXR0Zic6IFsndHRjJywgJ3R0ZiddLFxuICAnZm9udC9vcGVudHlwZSc6ICdvdGYnLFxuICAnYXBwbGljYXRpb24vamF2YS1hcmNoaXZlJzogWydlYXInLCAnamFyJywgJ3dhciddLFxuICAnYXBwbGljYXRpb24vbWFjLWJpbmhleDQwJzogJ2hxeCcsXG4gICdhcHBsaWNhdGlvbi9vY3RldC1zdHJlYW0nOiBbJ2JpbicsICdkZWInLCAnZGxsJywgJ2RtZycsICdpbWcnLCAnaXNvJywgJ21zaScsICdtc20nLCAnbXNwJywgJ3NhZmFyaWV4dHonXSxcbiAgJ2FwcGxpY2F0aW9uL3Bvc3RzY3JpcHQnOiBbJ2FpJywgJ2VwcycsICdwcyddLFxuICAnYXBwbGljYXRpb24vcnRmJzogJ3J0ZicsXG4gICdhcHBsaWNhdGlvbi92bmQuZ29vZ2xlLWVhcnRoLmttbCt4bWwnOiAna21sJyxcbiAgJ2FwcGxpY2F0aW9uL3ZuZC5nb29nbGUtZWFydGgua216JzogJ2tteicsXG4gICdhcHBsaWNhdGlvbi92bmQud2FwLndtbGMnOiAnd21sYycsXG4gICdhcHBsaWNhdGlvbi94LTd6LWNvbXByZXNzZWQnOiAnN3onLFxuICAnYXBwbGljYXRpb24veC1iYi1hcHB3b3JsZCc6ICdiYmF3JyxcbiAgJ2FwcGxpY2F0aW9uL3gtYml0dG9ycmVudCc6ICd0b3JyZW50JyxcbiAgJ2FwcGxpY2F0aW9uL3gtY2hyb21lLWV4dGVuc2lvbic6ICdjcngnLFxuICAnYXBwbGljYXRpb24veC1jb2NvYSc6ICdjY28nLFxuICAnYXBwbGljYXRpb24veC1qYXZhLWFyY2hpdmUtZGlmZic6ICdqYXJkaWZmJyxcbiAgJ2FwcGxpY2F0aW9uL3gtamF2YS1qbmxwLWZpbGUnOiAnam5scCcsXG4gICdhcHBsaWNhdGlvbi94LW1ha2VzZWxmJzogJ3J1bicsXG4gICdhcHBsaWNhdGlvbi94LWNkLWltYWdlJzogJ2lzbycsXG4gICdhcHBsaWNhdGlvbi94LW9wZXJhLWV4dGVuc2lvbic6ICdvZXgnLFxuICAnYXBwbGljYXRpb24veC1wZXJsJzogWydwbCcsICdwbSddLFxuICAnYXBwbGljYXRpb24veC1waWxvdCc6IFsncGRiJywgJ3ByYyddLFxuICAnYXBwbGljYXRpb24veC1yYXItY29tcHJlc3NlZCc6ICdyYXInLFxuICAnYXBwbGljYXRpb24veC1yZWRoYXQtcGFja2FnZS1tYW5hZ2VyJzogJ3JwbScsXG4gICdhcHBsaWNhdGlvbi94LXNlYSc6ICdzZWEnLFxuICAnYXBwbGljYXRpb24veC1zaG9ja3dhdmUtZmxhc2gnOiAnc3dmJyxcbiAgJ2FwcGxpY2F0aW9uL3gtc3R1ZmZpdCc6ICdzaXQnLFxuICAnYXBwbGljYXRpb24veC10Y2wnOiBbJ3RjbCcsICd0ayddLFxuICAnYXBwbGljYXRpb24veC14NTA5LWNhLWNlcnQnOiBbJ2NydCcsICdkZXInLCAncGVtJ10sXG4gICdhcHBsaWNhdGlvbi94LXhwaW5zdGFsbCc6ICd4cGknLFxuICAnYXBwbGljYXRpb24veC1tcy1kb3MtZXhlY3V0YWJsZSc6ICdleGUnLFxuICAnYXBwbGljYXRpb24veGh0bWwreG1sJzogJ3hodG1sJyxcbiAgJ2FwcGxpY2F0aW9uL3hzbHQreG1sJzogJ3hzbCcsXG4gICdhcHBsaWNhdGlvbi96aXAnOiAnemlwJyxcbiAgJ3RleHQvY3NzJzogJ2NzcycsXG4gICd0ZXh0L2Nzdic6ICdjc3YnLFxuICAndGV4dC9odG1sJzogWydodG0nLCAnaHRtbCcsICdzaHRtbCddLFxuICAndGV4dC9tYXJrZG93bic6ICdtZCcsXG4gICd0ZXh0L21hdGhtbCc6ICdtbWwnLFxuICAndGV4dC9wbGFpbic6ICd0eHQnLFxuICAndGV4dC92Y2FyZCc6IFsndmNhcmQnLCAndmNmJ10sXG4gICd0ZXh0L3ZuZC5yaW0ubG9jYXRpb24ueGxvYyc6ICd4bG9jJyxcbiAgJ3RleHQvdm5kLnN1bi5qMm1lLmFwcC1kZXNjcmlwdG9yJzogJ2phZCcsXG4gICd0ZXh0L3ZuZC53YXAud21sJzogJ3dtbCcsXG4gICd0ZXh0L3Z0dCc6ICd2dHQnLFxuICAndGV4dC94LWNvbXBvbmVudCc6ICdodGMnLFxuICAnYXBwbGljYXRpb24veC1kZXNrdG9wJzogJ2Rlc2t0b3AnLFxuICAndGV4dC94LW1hcmtkb3duJzogJ21kJyxcbiAgJ2FwcGxpY2F0aW9uL3gtdHlwZXNjcmlwdCc6ICd0cycsXG4gICdhcHBsaWNhdGlvbi94LWphdmEtYXJjaGl2ZSc6ICdqYXInLFxuICAnYXBwbGljYXRpb24veC1zaGFyZWRsaWInOiAnc28nLFxufTtcblxuLyoqXG4gKiBSZXNvbHZlIGNkbiB1cmwgYmFzZWQgb24gaGFuZGxlIHR5cGVcbiAqXG4gKiBAcHJpdmF0ZVxuICogQHBhcmFtIHNlc3Npb24gc2Vzc2lvbiBvYmplY3RcbiAqIEBwYXJhbSBoYW5kbGUgZmlsZSBoYW5kbGUgKGhhc2gsIHNyYzovL2FsaWFzLCB1cmwpXG4gKi9cbmV4cG9ydCBjb25zdCByZXNvbHZlQ2RuVXJsID0gKHNlc3Npb246IFNlc3Npb24sIGhhbmRsZTogc3RyaW5nKTogc3RyaW5nID0+IHtcbiAgY29uc3QgY2RuVVJMID0gc2Vzc2lvbi51cmxzLmNkblVybDtcblxuICBpZiAoaGFuZGxlICYmIChoYW5kbGUuaW5kZXhPZignc3JjOicpID09PSAwIHx8IGhhbmRsZS5pbmRleE9mKCdodHRwJykgPT09IDApKSB7XG4gICAgaWYgKCFzZXNzaW9uLmFwaWtleSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdBcGkga2V5IGlzIHJlcXVpcmVkIHdoZW4gc3RvcmFnZSBhbGlhcyBpcyBwcm92aWRlZCcpO1xuICAgIH1cblxuICAgIC8vIGFwaWtleSBpcyByZXF1aXJlZCBmb3IgYWxpYXMgb3IgZXh0ZXJuYWwgc291cmNlcyBjYWxsXG4gICAgcmV0dXJuIGAke2NkblVSTH0vJHtzZXNzaW9uLmFwaWtleX1gO1xuICB9XG5cbiAgcmV0dXJuIGNkblVSTDtcbn07XG5cbi8qKlxuICogUmVzb2x2ZSBhbGwgdXJscyB3aXRoIHByb3ZpZGVkIGNuYW1lc1xuICpcbiAqIEBwcml2YXRlXG4gKiBAcGFyYW0gdXJsc1xuICogQHBhcmFtIGNuYW1lXG4gKi9cbmV4cG9ydCBjb25zdCByZXNvbHZlSG9zdCA9ICh1cmxzOiBIb3N0cywgY25hbWU6IHN0cmluZyk6IEhvc3RzID0+IHtcbiAgaWYgKCFjbmFtZSkge1xuICAgIHJldHVybiB1cmxzO1xuICB9XG5cbiAgY29uc3QgaG9zdHMgPSAvZmlsZXN0YWNrYXBpLmNvbXxmaWxlc3RhY2tjb250ZW50LmNvbS9pO1xuXG4gIE9iamVjdC5rZXlzKHVybHMpLmZvckVhY2goa2V5ID0+IHtcbiAgICB1cmxzW2tleV0gPSB1cmxzW2tleV0ucmVwbGFjZShob3N0cywgY25hbWUpO1xuICB9KTtcblxuICByZXR1cm4gdXJscztcbn07XG5cbi8qKlxuICogUmVtb3ZlcyBlbXB0eSBvcHRpb25zIGZyb20gb2JqZWN0XG4gKlxuICogQHByaXZhdGVcbiAqIEBwYXJhbSBvYmpcbiAqL1xuZXhwb3J0IGNvbnN0IHJlbW92ZUVtcHR5ID0gKG9iajogYW55KSA9PiB7XG4gIGNvbnN0IG5ld09iaiA9IHsgLi4ub2JqIH07XG4gIE9iamVjdC5rZXlzKG5ld09iaikuZm9yRWFjaChrID0+ICFuZXdPYmpba10gJiYgdHlwZW9mIG5ld09ialtrXSAhPT0gJ2Jvb2xlYW4nICYmIGRlbGV0ZSBuZXdPYmpba10pO1xuICByZXR1cm4gbmV3T2JqO1xufTtcblxuLyoqXG4gKiBSZXR1cm5zIHVuaXF1ZSB0aW1lXG4gKi9cbmxldCBsYXN0O1xuZXhwb3J0IGNvbnN0IHVuaXF1ZVRpbWUgPSAoKSA9PiB7XG4gIGNvbnN0IHRpbWUgPSBEYXRlLm5vdygpO1xuICBsYXN0ID0gdGltZSA9PT0gbGFzdCA/IHRpbWUgKyAxIDogdGltZTtcbiAgcmV0dXJuIGxhc3Q7XG59O1xuXG4vKipcbiAqIEdlbmVyYXRlcyByYW5kb20gc3RyaW5nIHdpdGggcHJvdmlkZWQgbGVuZ3RoXG4gKlxuICogQHBhcmFtIGxlblxuICovXG5leHBvcnQgY29uc3QgdW5pcXVlSWQgPSAobGVuOiBudW1iZXIgPSAxMCk6IHN0cmluZyA9PiB7XG4gIHJldHVybiBuZXcgQXJyYXkobGVuKS5qb2luKCkucmVwbGFjZSgvKC58JCkvZywgKCkgPT4gKChNYXRoLnJhbmRvbSgpICogMzYpIHwgMCkudG9TdHJpbmcoMzYpW01hdGgucmFuZG9tKCkgPCAwLjUgPyAndG9TdHJpbmcnIDogJ3RvVXBwZXJDYXNlJ10oKSk7XG59O1xuXG4vKipcbiAqIENoZWNrIGlmIGlucHV0IGlzIGEgc3ZnXG4gKlxuICogQHBhcmFtIHtVaW50OEFycmF5IHwgQnVmZmVyfSBmaWxlXG4gKiBAcmV0dXJucyB7c3RyaW5nfSAtIG1pbWV0eXBlXG4gKi9cbmV4cG9ydCBjb25zdCBnZXRNaW1ldHlwZSA9IChmaWxlOiBVaW50OEFycmF5IHwgQnVmZmVyLCBuYW1lPzogc3RyaW5nKTogc3RyaW5nID0+IHtcbiAgbGV0IHR5cGUgPSBmaWxlVHlwZShmaWxlKTtcblxuICBpZiAodHlwZSAmJiBbJ3RleHQvcGxhaW4nLCAnYXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtJywgJ2FwcGxpY2F0aW9uL3gtbXMnLCAnYXBwbGljYXRpb24veC1tc2knXS5pbmRleE9mKHR5cGUubWltZSkgPT09IC0xKSB7XG4gICAgcmV0dXJuIHR5cGUubWltZTtcbiAgfVxuXG4gIGlmIChuYW1lICYmIG5hbWUuaW5kZXhPZignLicpID4gLTEpIHtcbiAgICBjb25zdCBleHQgPSBuYW1lLnNwbGl0KCcuJykucG9wKCk7XG4gICAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKE1hcCk7XG4gICAgY29uc3QgbWFwTGVuID0ga2V5cy5sZW5ndGg7XG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG1hcExlbjsgaSsrKSB7XG4gICAgICBpZiAoTWFwW2tleXNbaV1dLmluZGV4T2YoZXh0KSA+IC0xKSB7XG4gICAgICAgIHJldHVybiBrZXlzW2ldO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHRyeSB7XG4gICAgaWYgKGlzdXRmOChmaWxlKSkge1xuICAgICAgcmV0dXJuICd0ZXh0L3BsYWluJztcbiAgICB9XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqL1xuICAgIGNvbnNvbGUud2FybignQWRkaXRpb25hbCBtaW1ldHlwZSBjaGVja3MgKHRleHQvcGxhaW4pIGFyZSBjdXJyZW50bHkgbm90IHN1cHBvcnRlZCBmb3IgYnJvd3NlcnMnKTtcbiAgfVxuICAvLyB0aGlzIGlzIG9ubHkgZmFsbGJhY2ssIG9taXQgaXQgaW4gY292ZXJhZ2VcbiAgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi9cbiAgcmV0dXJuICdhcHBsaWNhdGlvbi9vY3RldC1zdHJlYW0nO1xufTtcblxuLyoqXG4gKiBTYW5pdGl6ZXIgT3B0aW9uc1xuICovXG5leHBvcnQgdHlwZSBTYW5pdGl6ZU9wdGlvbnMgPVxuICB8IGJvb2xlYW5cbiAgfCB7XG4gICAgZXhjbHVkZT86IHN0cmluZ1tdO1xuICAgIHJlcGxhY2VtZW50Pzogc3RyaW5nO1xuICB9O1xuXG4vKipcbiAqIFNhbml0aXplIGZpbGUgbmFtZVxuICpcbiAqIEBwYXJhbSBuYW1lXG4gKiBAcGFyYW0ge2Jvb2x9IG9wdGlvbnMgIC0gZW5hYmxlLGRpc2FibGUgc2FuaXRpemVyLCBkZWZhdWx0IGVuYWJsZWRcbiAqIEBwYXJhbSB7c3RyaW5nfSBvcHRpb25zLnJlcGxhY2VtZW50IC0gcmVwbGFjZW1lbnQgZm9yIHNhbml0aXplZCBjaGFycyBkZWZhdWx0cyB0byBcIi1cIlxuICogQHBhcmFtIHtzdHJpbmdbXX0gb3B0aW9ucy5leGNsdWRlIC0gYXJyYXkgd2l0aCBleGNsdWRlZCBjaGFycyBkZWZhdWx0IC0gWydcXCcsICd7JywgJ30nLCd8JywgJyUnLCAnYCcsICdcIicsIFwiJ1wiLCAnficsICdbJywgJ10nLCAnIycsICd8JywgJ14nLCAnPCcsICc+J11cbiAqL1xuZXhwb3J0IGNvbnN0IHNhbml0aXplTmFtZSA9IChuYW1lOiBzdHJpbmcsIG9wdGlvbnM6IFNhbml0aXplT3B0aW9ucyA9IHRydWUpOiBzdHJpbmcgPT4ge1xuICBpZiAodHlwZW9mIG9wdGlvbnMgPT09ICdib29sZWFuJyAmJiAhb3B0aW9ucykge1xuICAgIHJldHVybiBuYW1lO1xuICB9XG5cbiAgbGV0IGV4dDtcblxuICBjb25zdCByZXBsYWNlbWVudCA9IHR5cGVvZiBvcHRpb25zICE9PSAnYm9vbGVhbicgJiYgb3B0aW9ucy5yZXBsYWNlbWVudCA/IG9wdGlvbnMucmVwbGFjZW1lbnQgOiAnLSc7XG4gIGNvbnN0IGV4Y2x1ZGUgPSB0eXBlb2Ygb3B0aW9ucyAhPT0gJ2Jvb2xlYW4nICYmIG9wdGlvbnMuZXhjbHVkZSA/IG9wdGlvbnMuZXhjbHVkZSA6IFsnXFxcXCcsICd7JywgJ30nLCAnfCcsICclJywgJ2AnLCAnXCInLCBcIidcIiwgJ34nLCAnWycsICddJywgJyMnLCAnfCcsICdeJywgJzwnLCAnPiddO1xuXG4gIGlmICghbmFtZSB8fCBuYW1lLmxlbmd0aCA9PT0gMCkge1xuICAgIHJldHVybiAndW5kZWZpbmVkJztcbiAgfVxuXG4gIGNvbnN0IGZpbGVQYXJ0cyA9IG5hbWUuc3BsaXQoJy4nKTtcblxuICBpZiAoZmlsZVBhcnRzLmxlbmd0aCA+IDEpIHtcbiAgICBleHQgPSBmaWxlUGFydHMucG9wKCk7XG4gIH1cblxuICByZXR1cm4gYCR7ZmlsZVBhcnRzXG4gICAgLmpvaW4oJy4nKVxuICAgIC5zcGxpdCgnJylcbiAgICAubWFwKGNoYXIgPT4gKGV4Y2x1ZGUuaW5kZXhPZihjaGFyKSA+IC0xID8gcmVwbGFjZW1lbnQgOiBjaGFyKSlcbiAgICAuam9pbignJyl9JHtleHQgPyAnLicgKyBleHQgOiAnJ31gO1xufTtcblxuLyoqXG4gKiBGaWx0ZXIgb2JqZWN0IHRvIGdpdmVuIGZpZWxkc1xuICpcbiAqIEBwYXJhbSB0b0ZpbHRlclxuICogQHBhcmFtIHJlcXVpcmVkRmllbGRzXG4gKi9cbmV4cG9ydCBjb25zdCBmaWx0ZXJPYmplY3QgPSAodG9GaWx0ZXIsIHJlcXVpcmVkRmllbGRzOiBzdHJpbmdbXSkgPT4ge1xuICBpZiAoIXJlcXVpcmVkRmllbGRzIHx8IHJlcXVpcmVkRmllbGRzLmxlbmd0aCA9PT0gMCkge1xuICAgIHJldHVybiB0b0ZpbHRlcjtcbiAgfVxuXG4gIGlmIChPYmplY3Qua2V5cyh0b0ZpbHRlcikubGVuZ3RoID09PSAwKSB7XG4gICAgcmV0dXJuIHRvRmlsdGVyO1xuICB9XG5cbiAgcmV0dXJuIE9iamVjdC5rZXlzKHRvRmlsdGVyKVxuICAgIC5maWx0ZXIoZiA9PiByZXF1aXJlZEZpZWxkcy5pbmRleE9mKGYpID4gLTEpXG4gICAgLnJlZHVjZSgob2JqLCBrZXkpID0+ICh7IC4uLm9iaiwgW2tleV06IHRvRmlsdGVyW2tleV0gfSksIHt9KTtcbn07XG5cbi8qKlxuICogRGVlcCBjbGVhbnVwIG9iamVjdCBmcm9tIGZ1bmN0aW9uc1xuICpcbiAqIEBwYXJhbSBvYmpcbiAqL1xuZXhwb3J0IGNvbnN0IGNsZWFuVXBDYWxsYmFja3MgPSAob2JqOiBhbnkpID0+IHtcbiAgaWYgKCFvYmogfHwgT2JqZWN0LmtleXMob2JqKS5sZW5ndGggPT09IDApIHtcbiAgICByZXR1cm4gb2JqO1xuICB9XG5cbiAgT2JqZWN0LmtleXMob2JqKS5mb3JFYWNoKGsgPT4ge1xuICAgIGlmICh0eXBlb2Ygb2JqW2tdID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICBvYmpba10gPSB1bmRlZmluZWQ7XG4gICAgfVxuXG4gICAgaWYgKG9ialtrXSA9PT0gT2JqZWN0KG9ialtrXSkpIHtcbiAgICAgIG9ialtrXSA9IGNsZWFuVXBDYWxsYmFja3Mob2JqW2tdKTtcbiAgICB9XG4gIH0pO1xuXG4gIHJldHVybiBvYmo7XG59O1xuXG5leHBvcnQgKiBmcm9tICcuL2luZGV4Lm5vZGUnO1xuIl19

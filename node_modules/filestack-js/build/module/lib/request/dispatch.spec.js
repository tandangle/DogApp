/*
 * Copyright (c) 2018 by Filestack.
 * Some rights reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { __awaiter, __generator } from "tslib";
import * as nock from 'nock';
import { Dispatch } from './dispatch';
import { HttpAdapter } from './adapters/http';
import { FsHttpMethod } from './types';
import { FsRequestError, FsRequestErrorCode } from './error';
jest.mock('./adapters/http');
describe('Request/Dispatch', function () {
    afterEach(function () {
        nock.cleanAll();
    });
    var adapter = new HttpAdapter();
    var url = 'https://filestack.com';
    var configBase = {
        url: url,
        method: FsHttpMethod.GET,
    };
    var fsResponseBase = {
        status: 400,
        statusText: 'error',
        headers: null,
        data: null,
        config: configBase,
    };
    describe('dispatch request', function () {
        it('should return req', function () { return __awaiter(void 0, void 0, void 0, function () {
            var dispatch, req;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        spyOn(adapter, 'request').and.callFake(function () { return Promise.resolve(); });
                        dispatch = new Dispatch(adapter);
                        req = { url: url, method: FsHttpMethod.GET, headers: {} };
                        return [4 /*yield*/, dispatch.request(req)];
                    case 1:
                        _a.sent();
                        expect(adapter.request).toHaveBeenCalledWith(req);
                        return [2 /*return*/];
                }
            });
        }); });
    });
    describe('dispatch request catch', function () {
        it('should return config base', function () { return __awaiter(void 0, void 0, void 0, function () {
            var error, dispatch, request;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        error = new FsRequestError('error msg', configBase, fsResponseBase);
                        spyOn(adapter, 'request').and.callFake(function () { return Promise.reject(error); });
                        dispatch = new Dispatch(adapter);
                        return [4 /*yield*/, dispatch.request(configBase).catch(function (err) { return err; })];
                    case 1:
                        request = _a.sent();
                        expect(adapter.request).toHaveBeenCalledWith(configBase);
                        return [2 /*return*/];
                }
            });
        }); });
        it('should return config base', function () { return __awaiter(void 0, void 0, void 0, function () {
            var error, dispatch;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        fsResponseBase.status = 500;
                        error = new FsRequestError('error msg', configBase, fsResponseBase, FsRequestErrorCode.NETWORK);
                        spyOn(adapter, 'request').and.callFake(function () { return Promise.reject(error); });
                        dispatch = new Dispatch(adapter);
                        return [4 /*yield*/, dispatch.request(configBase).catch(function (err) { return err; })];
                    case 1:
                        _a.sent();
                        expect(adapter.request).toHaveBeenCalledWith(configBase);
                        return [2 /*return*/];
                }
            });
        }); });
        it('should return config', function () { return __awaiter(void 0, void 0, void 0, function () {
            var config, error, dispatch;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        config = {
                            url: url,
                            method: FsHttpMethod.GET,
                            headers: {},
                            retry: {
                                retry: 3,
                            },
                        };
                        fsResponseBase.status = 500;
                        error = new FsRequestError('error msg', config, fsResponseBase, FsRequestErrorCode.NETWORK);
                        spyOn(adapter, 'request').and.callFake(function () { return Promise.reject(error); });
                        dispatch = new Dispatch(adapter);
                        return [4 /*yield*/, dispatch.request(config).catch(function (err) { return err; })];
                    case 1:
                        _a.sent();
                        expect(adapter.request).toHaveBeenCalledWith(config);
                        return [2 /*return*/];
                }
            });
        }); });
    });
});

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9saWIvcmVxdWVzdC9kaXNwYXRjaC5zcGVjLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7Ozs7Ozs7R0FlRzs7QUFFSCxPQUFPLEtBQUssSUFBSSxNQUFNLE1BQU0sQ0FBQztBQUM3QixPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sWUFBWSxDQUFDO0FBQ3RDLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUM5QyxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBQ3ZDLE9BQU8sRUFBRSxjQUFjLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFFN0QsSUFBSSxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO0FBRTdCLFFBQVEsQ0FBQyxrQkFBa0IsRUFBRTtJQUMzQixTQUFTLENBQUM7UUFDUixJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7SUFDbEIsQ0FBQyxDQUFDLENBQUM7SUFFSCxJQUFNLE9BQU8sR0FBRyxJQUFJLFdBQVcsRUFBRSxDQUFDO0lBQ2xDLElBQU0sR0FBRyxHQUFHLHVCQUF1QixDQUFDO0lBQ3BDLElBQU0sVUFBVSxHQUFHO1FBQ2pCLEdBQUcsRUFBRSxHQUFHO1FBQ1IsTUFBTSxFQUFFLFlBQVksQ0FBQyxHQUFHO0tBQ3pCLENBQUM7SUFDRixJQUFJLGNBQWMsR0FBRztRQUNuQixNQUFNLEVBQUUsR0FBRztRQUNYLFVBQVUsRUFBRSxPQUFPO1FBQ25CLE9BQU8sRUFBRSxJQUFJO1FBQ2IsSUFBSSxFQUFFLElBQUk7UUFDVixNQUFNLEVBQUUsVUFBVTtLQUNuQixDQUFDO0lBRUYsUUFBUSxDQUFDLGtCQUFrQixFQUFFO1FBQzNCLEVBQUUsQ0FBQyxtQkFBbUIsRUFBRTs7Ozs7d0JBQ3RCLEtBQUssQ0FBQyxPQUFPLEVBQUUsU0FBUyxDQUFDLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxjQUFNLE9BQUEsT0FBTyxDQUFDLE9BQU8s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Q0FBcUIsQ0FBQyxDQUFDO3dCQUM5RCxRQUFRLEdBQUcsSUFBSSxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUM7d0JBQ3ZDLHFCQUFNLFFBQVEsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsS0FBSyxDQUFDLFVBQUEsR0FBRyxJQUFJLE9BQUEsR0FBRyxFQUFILENBQUcsQ0FBQyxFQUFBOzt3QkFBaEQsU0FBZ0QsQ0FBQzt3QkFDakQsTUFBTSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyxvQkFBb0IsQ0FBQyxNQUFNLENBQUMsQ0FBQzs7OzthQUN0RCxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwiZmlsZSI6ImxpYi9yZXF1ZXN0L2Rpc3BhdGNoLnNwZWMuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogQ29weXJpZ2h0IChjKSAyMDE4IGJ5IEZpbGVzdGFjay5cbiAqIFNvbWUgcmlnaHRzIHJlc2VydmVkLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQgKiBhcyBub2NrIGZyb20gJ25vY2snO1xuaW1wb3J0IHsgRGlzcGF0Y2ggfSBmcm9tICcuL2Rpc3BhdGNoJztcbmltcG9ydCB7IEh0dHBBZGFwdGVyIH0gZnJvbSAnLi9hZGFwdGVycy9odHRwJztcbmltcG9ydCB7IEZzSHR0cE1ldGhvZCB9IGZyb20gJy4vdHlwZXMnO1xuaW1wb3J0IHsgRnNSZXF1ZXN0RXJyb3IsIEZzUmVxdWVzdEVycm9yQ29kZSB9IGZyb20gJy4vZXJyb3InO1xuXG5qZXN0Lm1vY2soJy4vYWRhcHRlcnMvaHR0cCcpO1xuXG5kZXNjcmliZSgnUmVxdWVzdC9EaXNwYXRjaCcsICgpID0+IHtcbiAgYWZ0ZXJFYWNoKCgpID0+IHtcbiAgICBub2NrLmNsZWFuQWxsKCk7XG4gIH0pO1xuXG4gIGNvbnN0IGFkYXB0ZXIgPSBuZXcgSHR0cEFkYXB0ZXIoKTtcbiAgY29uc3QgdXJsID0gJ2h0dHBzOi8vZmlsZXN0YWNrLmNvbSc7XG4gIGNvbnN0IGNvbmZpZ0Jhc2UgPSB7XG4gICAgdXJsOiB1cmwsXG4gICAgbWV0aG9kOiBGc0h0dHBNZXRob2QuR0VULFxuICB9O1xuICBsZXQgZnNSZXNwb25zZUJhc2UgPSB7XG4gICAgc3RhdHVzOiA0MDAsXG4gICAgc3RhdHVzVGV4dDogJ2Vycm9yJyxcbiAgICBoZWFkZXJzOiBudWxsLFxuICAgIGRhdGE6IG51bGwsXG4gICAgY29uZmlnOiBjb25maWdCYXNlLFxuICB9O1xuXG4gIGRlc2NyaWJlKCdkaXNwYXRjaCByZXF1ZXN0JywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgcmV0dXJuIHJlcScsIGFzeW5jICgpID0+IHtcbiAgICAgIHNweU9uKGFkYXB0ZXIsICdyZXF1ZXN0JykuYW5kLmNhbGxGYWtlKCgpID0+IFByb21pc2UucmVzb2x2ZSgpKTtcbiAgICAgIGNvbnN0IGRpc3BhdGNoID0gbmV3IERpc3BhdGNoKGFkYXB0ZXIpO1xuICAgICAgY29uc3QgcmVxID0geyB1cmwsIG1ldGhvZDogRnNIdHRwTWV0aG9kLkdFVCwgaGVhZGVyczoge30gfTtcbiAgICAgIGF3YWl0IGRpc3BhdGNoLnJlcXVlc3QocmVxKTtcbiAgICAgIGV4cGVjdChhZGFwdGVyLnJlcXVlc3QpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKHJlcSk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdkaXNwYXRjaCByZXF1ZXN0IGNhdGNoJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgcmV0dXJuIGNvbmZpZyBiYXNlJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgZXJyb3IgPSBuZXcgRnNSZXF1ZXN0RXJyb3IoJ2Vycm9yIG1zZycsIGNvbmZpZ0Jhc2UsIGZzUmVzcG9uc2VCYXNlKTtcbiAgICAgIHNweU9uKGFkYXB0ZXIsICdyZXF1ZXN0JykuYW5kLmNhbGxGYWtlKCgpID0+IFByb21pc2UucmVqZWN0KGVycm9yKSk7XG4gICAgICBjb25zdCBkaXNwYXRjaCA9IG5ldyBEaXNwYXRjaChhZGFwdGVyKTtcbiAgICAgIGNvbnN0IHJlcXVlc3QgPSBhd2FpdCBkaXNwYXRjaC5yZXF1ZXN0KGNvbmZpZ0Jhc2UpLmNhdGNoKGVyciA9PiBlcnIpO1xuICAgICAgZXhwZWN0KGFkYXB0ZXIucmVxdWVzdCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoY29uZmlnQmFzZSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHJldHVybiBjb25maWcgYmFzZScsIGFzeW5jICgpID0+IHtcbiAgICAgIGZzUmVzcG9uc2VCYXNlLnN0YXR1cyA9IDUwMDtcbiAgICAgIGNvbnN0IGVycm9yID0gbmV3IEZzUmVxdWVzdEVycm9yKCdlcnJvciBtc2cnLCBjb25maWdCYXNlLCBmc1Jlc3BvbnNlQmFzZSwgRnNSZXF1ZXN0RXJyb3JDb2RlLk5FVFdPUkspO1xuICAgICAgc3B5T24oYWRhcHRlciwgJ3JlcXVlc3QnKS5hbmQuY2FsbEZha2UoKCkgPT4gUHJvbWlzZS5yZWplY3QoZXJyb3IpKTtcbiAgICAgIGNvbnN0IGRpc3BhdGNoID0gbmV3IERpc3BhdGNoKGFkYXB0ZXIpO1xuICAgICAgYXdhaXQgZGlzcGF0Y2gucmVxdWVzdChjb25maWdCYXNlKS5jYXRjaChlcnIgPT4gZXJyKTtcbiAgICAgIGV4cGVjdChhZGFwdGVyLnJlcXVlc3QpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKGNvbmZpZ0Jhc2UpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gY29uZmlnJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgY29uZmlnID0ge1xuICAgICAgICB1cmw6IHVybCxcbiAgICAgICAgbWV0aG9kOiBGc0h0dHBNZXRob2QuR0VULFxuICAgICAgICBoZWFkZXJzOiB7fSxcbiAgICAgICAgcmV0cnk6IHtcbiAgICAgICAgICByZXRyeTogMyxcbiAgICAgICAgfSxcbiAgICAgIH07XG4gICAgICBmc1Jlc3BvbnNlQmFzZS5zdGF0dXMgPSA1MDA7XG4gICAgICBjb25zdCBlcnJvciA9IG5ldyBGc1JlcXVlc3RFcnJvcignZXJyb3IgbXNnJywgY29uZmlnLCBmc1Jlc3BvbnNlQmFzZSwgRnNSZXF1ZXN0RXJyb3JDb2RlLk5FVFdPUkspO1xuICAgICAgc3B5T24oYWRhcHRlciwgJ3JlcXVlc3QnKS5hbmQuY2FsbEZha2UoKCkgPT4gUHJvbWlzZS5yZWplY3QoZXJyb3IpKTtcbiAgICAgIGNvbnN0IGRpc3BhdGNoID0gbmV3IERpc3BhdGNoKGFkYXB0ZXIpO1xuICAgICAgYXdhaXQgZGlzcGF0Y2gucmVxdWVzdChjb25maWcpLmNhdGNoKGVyciA9PiBlcnIpO1xuICAgICAgZXhwZWN0KGFkYXB0ZXIucmVxdWVzdCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoY29uZmlnKTtcbiAgICB9KTtcbiAgfSk7XG59KTtcbiJdfQ==

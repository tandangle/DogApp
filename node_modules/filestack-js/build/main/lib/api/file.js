"use strict";
/*
 * Copyright (c) 2018 by Filestack.
 * Some rights reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
Object.defineProperty(exports, "__esModule", { value: true });
var tslib_1 = require("tslib");
var utils_1 = require("../utils");
var filestack_error_1 = require("./../../filestack_error");
var schema_1 = require("./../../schema");
var request_1 = require("../request");
/**
 * Remove given file
 *
 * @private
 * @param session
 * @param handle
 * @param security
 */
exports.remove = function (session, handle, skipStorage, security) {
    if (!handle || typeof handle !== 'string') {
        throw new filestack_error_1.FilestackError('A valid Filestack handle is required for remove');
    }
    if (!(session.policy && session.signature) && (!security || !(security.policy && security.signature))) {
        throw new filestack_error_1.FilestackError('Security policy and signature are required for remove');
    }
    var fileApiUrl = session.urls.fileApiUrl;
    var baseURL = fileApiUrl + "/" + handle;
    var options = {
        key: session.apikey,
        policy: (security && security.policy) || session.policy,
        signature: (security && security.signature) || session.signature,
    };
    if (skipStorage) {
        options.skip_storage = true;
    }
    return request_1.FsRequest.delete(baseURL, {
        filestackHeaders: false,
        params: utils_1.removeEmpty(options),
    });
};
/**
 * Returns file metadata
 *
 * @private
 * @param session
 * @param handle
 * @param opts
 * @param security
 */
exports.metadata = function (session, handle, opts, security) {
    if (!handle || typeof handle !== 'string') {
        throw new filestack_error_1.FilestackError('A valid Filestack handle is required for metadata');
    }
    var validateRes = schema_1.getValidator(schema_1.MetadataParamsSchema)(opts);
    if (validateRes.errors.length) {
        throw new filestack_error_1.FilestackError("Invalid metadata params", validateRes.errors);
    }
    var options = tslib_1.__assign({}, opts);
    options.source_url = options.sourceUrl; // source_url is snake_case
    options.policy = (security && security.policy) || session.policy;
    options.signature = (security && security.signature) || session.signature;
    var baseURL = session.urls.fileApiUrl + "/" + handle + "/metadata";
    return new Promise(function (resolve, reject) {
        request_1.FsRequest.get(baseURL, { params: utils_1.removeEmpty(options), filestackHeaders: false, })
            .then(function (res) { return resolve(tslib_1.__assign(tslib_1.__assign({}, res.data), { handle: handle })); })
            .catch(reject);
    });
};
/**
 * Returns file information
 *
 * @private
 * @param session
 * @param handle
 * @param options
 * @param security
 */
exports.retrieve = function (session, handle, options, security) {
    if (options === void 0) { options = {}; }
    if (!handle || handle.length === 0 || typeof handle !== 'string') {
        throw new filestack_error_1.FilestackError('File handle is required');
    }
    var validateRes = schema_1.getValidator(schema_1.RetrieveParamsSchema)(options);
    if (validateRes.errors.length) {
        throw new filestack_error_1.FilestackError("Invalid retrieve params", validateRes.errors);
    }
    var requestOptions = tslib_1.__assign({}, options);
    requestOptions.key = session.apikey;
    requestOptions.policy = (security && security.policy) || session.policy;
    requestOptions.signature = (security && security.signature) || session.signature;
    var method = request_1.FsHttpMethod.GET;
    if (requestOptions.head) {
        method = request_1.FsHttpMethod.HEAD;
        delete requestOptions.head;
    }
    var extension;
    if (requestOptions.extension && requestOptions.extension.length) {
        extension = requestOptions.extension;
        delete requestOptions.extension;
    }
    var metadata;
    if (requestOptions.metadata) {
        if (method === request_1.FsHttpMethod.HEAD) {
            throw new filestack_error_1.FilestackError('Head and metadata options cannot be used together');
        }
        metadata = requestOptions.metadata;
        delete requestOptions.metadata;
    }
    var baseURL = session.urls.fileApiUrl + "/" + handle + (extension ? "+" + extension : '') + (metadata ? '/metadata' : '');
    return new Promise(function (resolve, reject) {
        request_1.FsRequest.dispatch(baseURL, {
            method: method,
            filestackHeaders: false,
            params: utils_1.removeEmpty(requestOptions),
        })
            .then(function (res) { return resolve(method === request_1.FsHttpMethod.HEAD ? res.headers : res.data); })
            .catch(reject);
    });
};

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9saWIvYXBpL2ZpbGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOzs7Ozs7Ozs7Ozs7Ozs7R0FlRzs7O0FBR0gsa0NBQXVDO0FBQ3ZDLDJEQUF5RDtBQUN6RCx5Q0FBMEY7QUFDMUYsc0NBQXFEO0FBRXJEOzs7Ozs7O0dBT0c7QUFDVSxRQUFBLE1BQU0sR0FBRyxVQUFDLE9BQWdCLEVBQUUsTUFBZSxFQUFFLFdBQXFCLEVBQUUsUUFBbUI7SUFDbEcsSUFBSSxDQUFDLE1BQU0sSUFBSSxPQUFPLE1BQU0sS0FBSyxRQUFRLEVBQUU7UUFDekMsTUFBTSxJQUFJLGdDQUFjLENBQUMsaURBQWlELENBQUMsQ0FBQztLQUM3RTtJQUVELElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxNQUFNLElBQUksT0FBTyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxRQUFRLElBQUksQ0FBQyxDQUFDLFFBQVEsQ0FBQyxNQUFNLElBQUksUUFBUSxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUU7UUFDckcsTUFBTSxJQUFJLGdDQUFjLENBQUMsdURBQXVELENBQUMsQ0FBQztLQUNuRjtJQUVELElBQU0sVUFBVSxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDO0lBQzNDLElBQU0sT0FBTyxHQUFNLFVBQVUsU0FBSSxNQUFRLENBQUM7SUFDMUMsSUFBTSxPQUFPLEdBQVE7UUFDbkIsR0FBRyxFQUFFLE9BQU8sQ0FBQyxNQUFNO1FBQ25CLE1BQU0sRUFBRSxDQUFDLFFBQVEsSUFBSSxRQUFRLENBQUMsTUFBTSxDQUFDLElBQUksT0FBTyxDQUFDLE1BQU07UUFDdkQsU0FBUyxFQUFFLENBQUMsUUFBUSxJQUFJLFFBQVEsQ0FBQyxTQUFTLENBQUMsSUFBSSxPQUFPLENBQUMsU0FBUztLQUNqRSxDQUFDO0lBRUYsSUFBSSxXQUFXLEVBQUU7UUFDZixPQUFPLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQztLQUM3QjtJQUVELE9BQU8sbUJB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TUFBTSxLQUFLLHNCQUFZLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQTlELENBQThELENBQUM7YUFDM0UsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ25CLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDIiwiZmlsZSI6ImxpYi9hcGkvZmlsZS5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTggYnkgRmlsZXN0YWNrLlxuICogU29tZSByaWdodHMgcmVzZXJ2ZWQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7IFNlY3VyaXR5LCBTZXNzaW9uIH0gZnJvbSAnLi4vY2xpZW50JztcbmltcG9ydCB7IHJlbW92ZUVtcHR5IH0gZnJvbSAnLi4vdXRpbHMnO1xuaW1wb3J0IHsgRmlsZXN0YWNrRXJyb3IgfSBmcm9tICcuLy4uLy4uL2ZpbGVzdGFja19lcnJvcic7XG5pbXBvcnQgeyBnZXRWYWxpZGF0b3IsIE1ldGFkYXRhUGFyYW1zU2NoZW1hLCBSZXRyaWV2ZVBhcmFtc1NjaGVtYSB9IGZyb20gJy4vLi4vLi4vc2NoZW1hJztcbmltcG9ydCB7IEZzUmVxdWVzdCwgRnNIdHRwTWV0aG9kIH0gZnJvbSAnLi4vcmVxdWVzdCc7XG5cbi8qKlxuICogUmVtb3ZlIGdpdmVuIGZpbGVcbiAqXG4gKiBAcHJpdmF0ZVxuICogQHBhcmFtIHNlc3Npb25cbiAqIEBwYXJhbSBoYW5kbGVcbiAqIEBwYXJhbSBzZWN1cml0eVxuICovXG5leHBvcnQgY29uc3QgcmVtb3ZlID0gKHNlc3Npb246IFNlc3Npb24sIGhhbmRsZT86IHN0cmluZywgc2tpcFN0b3JhZ2U/OiBib29sZWFuLCBzZWN1cml0eT86IFNlY3VyaXR5KTogUHJvbWlzZTxhbnk+ID0+IHtcbiAgaWYgKCFoYW5kbGUgfHwgdHlwZW9mIGhhbmRsZSAhPT0gJ3N0cmluZycpIHtcbiAgICB0aHJvdyBuZXcgRmlsZXN0YWNrRXJyb3IoJ0EgdmFsaWQgRmlsZXN0YWNrIGhhbmRsZSBpcyByZXF1aXJlZCBmb3IgcmVtb3ZlJyk7XG4gIH1cblxuICBpZiAoIShzZXNzaW9uLnBvbGljeSAmJiBzZXNzaW9uLnNpZ25hdHVyZSkgJiYgKCFzZWN1cml0eSB8fCAhKHNlY3VyaXR5LnBvbGljeSAmJiBzZWN1cml0eS5zaWduYXR1cmUpKSkge1xuICAgIHRocm93IG5ldyBGaWxlc3RhY2tFcnJvcignU2VjdXJpdHkgcG9saWN5IGFuZCBzaWduYXR1cmUgYXJlIHJlcXVpcmVkIGZvciByZW1vdmUnKTtcbiAgfVxuXG4gIGNvbnN0IGZpbGVBcGlVcmwgPSBzZXNzaW9uLnVybHMuZmlsZUFwaVVybDtcbiAgY29uc3QgYmFzZVVSTCA9IGAke2ZpbGVBcGlVcmx9LyR7aGFuZGxlfWA7XG4gIGNvbnN0IG9wdGlvbnM6IGFueSA9IHtcbiAgICBrZXk6IHNlc3Npb24uYXBpa2V5LFxuICAgIHBvbGljeTogKHNlY3VyaXR5ICYmIHNlY3VyaXR5LnBvbGljeSkgfHwgc2Vzc2lvbi5wb2xpY3ksXG4gICAgc2lnbmF0dXJlOiAoc2VjdXJpdHkgJiYgc2VjdXJpdHkuc2lnbmF0dXJlKSB8fCBzZXNzaW9uLnNpZ25hdHVyZSxcbiAgfTtcblxuICBpZiAoc2tpcFN0b3JhZ2UpIHtcbiAgICBvcHRpb25zLnNraXBfc3RvcmFnZSA9IHRydWU7XG4gIH1cblxuICByZXR1cm4gRnNSZXF1ZXN0LmRlbGV0ZShiYXNlVVJMLCB7XG4gICAgZmlsZXN0YWNrSGVhZGVyczogZmFsc2UsXG4gICAgcGFyYW1zOiByZW1vdmVFbXB0eShvcHRpb25zKSxcbiAgfSk7XG59O1xuXG5leHBvcnQgaW50ZXJmYWNlIE1ldGFkYXRhT3B0aW9ucyB7XG4gIHNpemU/OiBib29sZWFuO1xuICBtaW1ldHlwZT86IGJvb2xlYW47XG4gIGZpbGVuYW1lPzogYm9vbGVhbjtcbiAgd2lkdGg/OiBib29sZWFuO1xuICBoZWlnaHQ/OiBib29sZWFuO1xuICB1cGxvYWRlZD86IGJvb2xlYW47XG4gIHdyaXRlYWJsZT86IGJvb2xlYW47XG4gIGNsb3VkPzogYm9vbGVhbjtcbiAgc291cmNlVXJsPzogYm9vbGVhbjtcbiAgbWQ1PzogYm9vbGVhbjtcbiAgc2hhMT86IGJvb2xlYW47XG4gIHNoYTIyND86IGJvb2xlYW47XG4gIHNoYTI1Nj86IGJvb2xlYW47XG4gIHNoYTM4ND86IGJvb2xlYW47XG4gIHNoYTUxMj86IGJvb2xlYW47XG4gIGxvY2F0aW9uPzogYm9vbGVhbjtcbiAgcGF0aD86IGJvb2xlYW47XG4gIGNvbnRhaW5lcj86IGJvb2xlYW47XG4gIGV4aWY/OiBib29sZWFuO1xufVxuXG4vKipcbiAqIFJldHVybnMgZmlsZSBtZXRhZGF0YVxuICpcbiAqIEBwcml2YXRlXG4gKiBAcGFyYW0gc2Vzc2lvblxuICogQHBhcmFtIGhhbmRsZVxuICogQHBhcmFtIG9wdHNcbiAqIEBwYXJhbSBzZWN1cml0eVxuICovXG5leHBvcnQgY29uc3QgbWV0YWRhdGEgPSAoc2Vzc2lvbjogU2Vzc2lvbiwgaGFuZGxlPzogc3RyaW5nLCBvcHRzPzogTWV0YWRhdGFPcHRpb25zLCBzZWN1cml0eT86IFNlY3VyaXR5KTogUHJvbWlzZTxhbnk+ID0+IHtcbiAgaWYgKCFoYW5kbGUgfHwgdHlwZW9mIGhhbmRsZSAhPT0gJ3N0cmluZycpIHtcbiAgICB0aHJvdyBuZXcgRmlsZXN0YWNrRXJyb3IoJ0EgdmFsaWQgRmlsZXN0YWNrIGhhbmRsZSBpcyByZXF1aXJlZCBmb3IgbWV0YWRhdGEnKTtcbiAgfVxuXG4gIGNvbnN0IHZhbGlkYXRlUmVzID0gZ2V0VmFsaWRhdG9yKE1ldGFkYXRhUGFyYW1zU2NoZW1hKShvcHRzKTtcblxuICBpZiAodmFsaWRhdGVSZXMuZXJyb3JzLmxlbmd0aCkge1xuICAgIHRocm93IG5ldyBGaWxlc3RhY2tFcnJvcihgSW52YWxpZCBtZXRhZGF0YSBwYXJhbXNgLCB2YWxpZGF0ZVJlcy5lcnJvcnMpO1xuICB9XG5cbiAgY29uc3Qgb3B0aW9uczogYW55ID0geyAuLi5vcHRzIH07XG4gIG9wdGlvbnMuc291cmNlX3VybCA9IG9wdGlvbnMuc291cmNlVXJsOyAvLyBzb3VyY2VfdXJsIGlzIHNuYWtlX2Nhc2VcbiAgb3B0aW9ucy5wb2xpY3kgPSAoc2VjdXJpdHkgJiYgc2VjdXJpdHkucG9saWN5KSB8fCBzZXNzaW9uLnBvbGljeTtcbiAgb3B0aW9ucy5zaWduYXR1cmUgPSAoc2VjdXJpdHkgJiYgc2VjdXJpdHkuc2lnbmF0dXJlKSB8fCBzZXNzaW9uLnNpZ25hdHVyZTtcblxuICBjb25zdCBiYXNlVVJMID0gYCR7c2Vzc2lvbi51cmxzLmZpbGVBcGlVcmx9LyR7aGFuZGxlfS9tZXRhZGF0YWA7XG4gIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgRnNSZXF1ZXN0LmdldChiYXNlVVJMLCB7IHBhcmFtczogcmVtb3ZlRW1wdHkob3B0aW9ucyksIGZpbGVzdGFja0hlYWRlcnM6IGZhbHNlLCB9KVxuICAgICAgLnRoZW4ocmVzID0+IHJlc29sdmUoeyAuLi5yZXMuZGF0YSwgaGFuZGxlIH0pKVxuICAgICAgLmNhdGNoKHJlamVjdCk7XG4gIH0pO1xufTtcblxuZXhwb3J0IGludGVyZmFjZSBSZXRyaWV2ZU9wdGlvbnMge1xuICBtZXRhZGF0YT86IGJvb2xlYW47XG4gIGhlYWQ/OiBib29sZWFuO1xuICBkbD86IGJvb2xlYW47XG4gIGV4dGVuc2lvbj86IHN0cmluZztcbiAgY2FjaGU/OiBib29sZWFuO1xufVxuXG4vKipcbiAqIFJldHVybnMgZmlsZSBpbmZvcm1hdGlvblxuICpcbiAqIEBwcml2YXRlXG4gKiBAcGFyYW0gc2Vzc2lvblxuICogQHBhcmFtIGhhbmRsZVxuICogQHBhcmFtIG9wdGlvbnNcbiAqIEBwYXJhbSBzZWN1cml0eVxuICovXG5leHBvcnQgY29uc3QgcmV0cmlldmUgPSAoc2Vzc2lvbjogU2Vzc2lvbiwgaGFuZGxlOiBzdHJpbmcsIG9wdGlvbnM6IFJldHJpZXZlT3B0aW9ucyA9IHt9LCBzZWN1cml0eT86IFNlY3VyaXR5KTogUHJvbWlzZTxPYmplY3QgfCBCbG9iPiA9PiB7XG4gIGlmICghaGFuZGxlIHx8IGhhbmRsZS5sZW5ndGggPT09IDAgfHwgdHlwZW9mIGhhbmRsZSAhPT0gJ3N0cmluZycpIHtcbiAgICB0aHJvdyBuZXcgRmlsZXN0YWNrRXJyb3IoJ0ZpbGUgaGFuZGxlIGlzIHJlcXVpcmVkJyk7XG4gIH1cblxuICBjb25zdCB2YWxpZGF0ZVJlcyA9IGdldFZhbGlkYXRvcihSZXRyaWV2ZVBhcmFtc1NjaGVtYSkob3B0aW9ucyk7XG5cbiAgaWYgKHZhbGlkYXRlUmVzLmVycm9ycy5sZW5ndGgpIHtcbiAgICB0aHJvdyBuZXcgRmlsZXN0YWNrRXJyb3IoYEludmFsaWQgcmV0cmlldmUgcGFyYW1zYCwgdmFsaWRhdGVSZXMuZXJyb3JzKTtcbiAgfVxuXG4gIGNvbnN0IHJlcXVlc3RPcHRpb25zOiBhbnkgPSB7IC4uLm9wdGlvbnMgfTtcbiAgcmVxdWVzdE9wdGlvbnMua2V5ID0gc2Vzc2lvbi5hcGlrZXk7XG4gIHJlcXVlc3RPcHRpb25zLnBvbGljeSA9IChzZWN1cml0eSAmJiBzZWN1cml0eS5wb2xpY3kpIHx8IHNlc3Npb24ucG9saWN5O1xuICByZXF1ZXN0T3B0aW9ucy5zaWduYXR1cmUgPSAoc2VjdXJpdHkgJiYgc2VjdXJpdHkuc2lnbmF0dXJlKSB8fCBzZXNzaW9uLnNpZ25hdHVyZTtcblxuICBsZXQgbWV0aG9kOiBGc0h0dHBNZXRob2QgPSBGc0h0dHBNZXRob2QuR0VUO1xuXG4gIGlmIChyZXF1ZXN0T3B0aW9ucy5oZWFkKSB7XG4gICAgbWV0aG9kID0gRnNIdHRwTWV0aG9kLkhFQUQ7XG4gICAgZGVsZXRlIHJlcXVlc3RPcHRpb25zLmhlYWQ7XG4gIH1cblxuICBsZXQgZXh0ZW5zaW9uO1xuXG4gIGlmIChyZXF1ZXN0T3B0aW9ucy5leHRlbnNpb24gJiYgcmVxdWVzdE9wdGlvbnMuZXh0ZW5zaW9uLmxlbmd0aCkge1xuICAgIGV4dGVuc2lvbiA9IHJlcXVlc3RPcHRpb25zLmV4dGVuc2lvbjtcbiAgICBkZWxldGUgcmVxdWVzdE9wdGlvbnMuZXh0ZW5zaW9uO1xuICB9XG5cbiAgbGV0IG1ldGFkYXRhO1xuICBpZiAocmVxdWVzdE9wdGlvbnMubWV0YWRhdGEpIHtcbiAgICBpZiAobWV0aG9kID09PSBGc0h0dHBNZXRob2QuSEVBRCkge1xuICAgICAgdGhyb3cgbmV3IEZpbGVzdGFja0Vycm9yKCdIZWFkIGFuZCBtZXRhZGF0YSBvcHRpb25zIGNhbm5vdCBiZSB1c2VkIHRvZ2V0aGVyJyk7XG4gICAgfVxuXG4gICAgbWV0YWRhdGEgPSByZXF1ZXN0T3B0aW9ucy5tZXRhZGF0YTtcbiAgICBkZWxldGUgcmVxdWVzdE9wdGlvbnMubWV0YWRhdGE7XG4gIH1cblxuICBjb25zdCBiYXNlVVJMID0gYCR7c2Vzc2lvbi51cmxzLmZpbGVBcGlVcmx9LyR7aGFuZGxlfWAgKyAoZXh0ZW5zaW9uID8gYCske2V4dGVuc2lvbn1gIDogJycpICsgKG1ldGFkYXRhID8gJy9tZXRhZGF0YScgOiAnJyk7XG5cbiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICBGc1JlcXVlc3QuZGlzcGF0Y2goYmFzZVVSTCwge1xuICAgICAgbWV0aG9kLFxuICAgICAgZmlsZXN0YWNrSGVhZGVyczogZmFsc2UsXG4gICAgICBwYXJhbXM6IHJlbW92ZUVtcHR5KHJlcXVlc3RPcHRpb25zKSxcbiAgICB9KVxuICAgICAgLnRoZW4ocmVzID0+IHJlc29sdmUobWV0aG9kID09PSBGc0h0dHBNZXRob2QuSEVBRCA/IHJlcy5oZWFkZXJzIDogcmVzLmRhdGEpKVxuICAgICAgLmNhdGNoKHJlamVjdCk7XG4gIH0pO1xufTtcbiJdfQ==

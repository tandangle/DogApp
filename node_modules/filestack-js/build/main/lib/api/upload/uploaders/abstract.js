"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var tslib_1 = require("tslib");
/*
 * Copyright (c) 2019 by Filestack.
 * Some rights reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
var debug_1 = require("debug");
var EventEmitter = require("eventemitter3");
var utils_1 = require("./../../../utils");
var filestack_error_1 = require("./../../../../filestack_error");
// regular part size
exports.DEFAULT_PART_SIZE = 6 * 1024 * 1024;
// Minimum part size for upload by multipart
exports.MIN_PART_SIZE = 5 * 1024 * 1024;
// when mode is set to fallback or intelligent, this part size is required
exports.INTELLIGENT_CHUNK_SIZE = 8 * 1024 * 1024;
// Mobile Chunk size for ii
exports.INTELLIGENT_MOBILE_CHUNK_SIZE = 1024 * 1024;
// minimum intelligent chunk size
exports.MIN_CHUNK_SIZE = 32 * 1024;
exports.DEFAULT_STORE_LOCATION = 's3';
var debug = debug_1.default('fs:upload:abstract');
var UploaderAbstract = /** @class */ (function (_super) {
    tslib_1.__extends(UploaderAbstract, _super);
    function UploaderAbstract(storeOptions, concurrency) {
        if (concurrency === void 0) { concurrency = 3; }
        var _this = _super.call(this) || this;
        _this.storeOptions = storeOptions;
        _this.concurrency = concurrency;
        // Parts size options
        _this.partSize = exports.DEFAULT_PART_SIZE;
        // chunk size for ii uploads
        _this.intelligentChunkSize = utils_1.isMobile() ? exports.INTELLIGENT_MOBILE_CHUNK_SIZE : exports.INTELLIGENT_CHUNK_SIZE;
        _this.timeout = 30 * 1000;
        _this.uploadMode = "default" /* DEFAULT */;
        _this.isModeLocked = false; // if account does not support ii in fallback mode we should abort
        _this.integrityCheck = true;
        _this.uploadTags = null;
        return _this;
    }
    UploaderAbstract.prototype.setSecurity = function (security) {
        debug('Set security %O', security);
        this.security = security;
    };
    UploaderAbstract.prototype.setApikey = function (apikey) {
        debug("Set apikey to " + apikey);
        this.apikey = apikey;
    };
    UploaderAbstract.prototype.setTimeout = function (timeout) {
        debug("Set request timeout to " + timeout);
        this.timeout = timeout;
    };
    UploaderAbstract.prototype.setRetryConfig = function (cfg) {
        debug("Set retry config to " + cfg);
        this.retryConfig = cfg;
    };
    UploaderAbstract.prototype.setUrl = function (url) {
        debug("Set upload url to " + url);
        this.url = url;
    };
    UploaderAbstract.prototype.setUploadTags = function (tags) {
        debug("Set tags to %O", tags);
        this.uploadTags = tags;
    };
    /**
     * Set state of checking file integrity
     * @param state
     */
    UploaderAbstract.prototype.setIntegrityCheck = function (state) {
        this.integrityCheck = state;
    };
    /**
     * Sets upload mode
     *
     * @param {UploadMode} mode
     * @param {boolean} [lock=false]
     * @returns
     * @memberof MultipartUploader
     */
    UploaderAbstract.prototype.setUploadMode = function (mode, lock) {
        if (lock === void 0) { lock = false; }
        // this shouldnt happend but for safety reasons if will stay
        /* istanbul ignore next */
        if (this.isModeLocked === true) {
            debug("Cannot switch mode to " + mode + ". Locked! Probably mode is not supported at this apikey");
            return;
        }
        this.isModeLocked = lock;
        debug("Set upload mode to " + mode);
        this.uploadMode = mode;
    };
    /**
     * Set upload part size
     * if part size is smaller than minimum 5mb it will throw error
     *
     * @param {number} size
     * @returns {void}
     * @memberof S3Uploader
     */
    UploaderAbstract.prototype.setPartSize = function (size) {
        if (this.uploadMode !== "default" /* DEFAULT */) {
            debug('Cannot set part size because upload mode is other than default. ');
            return;
        }
        debug("Set part size to " + size);
        if (size < exports.MIN_PART_SIZE) {
            throw new filestack_error_1.FilestackError('Minimum part size is 5MB');
        }
        this.partSize = size;
    };
    /**
     * Returns current part size
     */
    UploaderAbstract.prototype.getPartSize = function () {
        return this.partSize;
    };
    /**
     * Set start part size for ii
     *
     * @param {number} size
     * @memberof S3Uploader
     */
    UploaderAbstract.prototype.setIntelligentChunkSize = function (size) {
        debug("Set inteligent chunk size to " + size);
        if (size < exports.MIN_CHUNK_SIZE) {
            throw new filestack_error_1.FilestackError("Minimum intelligent chunk size is " + exports.MIN_CHUNK_SIZE);
        }
        this.intelligentChunkSize = size;
    };
    /**
     * Returns intelligent chunk size
     */
    UploaderAbstract.prototype.getIntelligentChunkSize = function () {
        return this.intelligentChunkSize;
    };
    /**
     * Returns filestack upload url
     *
     * @private
     * @returns
     * @memberof MultipartUploader
     */
    UploaderAbstract.prototype.getUrl = function () {
        if (!this.url) {
            throw new filestack_error_1.FilestackError('Upload url not set');
        }
        return this.url;
    };
    return UploaderAbstract;
}(EventEmitter));
exports.UploaderAbstract = UploaderAbstract;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9saWIvYXBpL3VwbG9hZC91cGxvYWRlcnMvYWJzdHJhY3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUE7Ozs7Ozs7Ozs7Ozs7OztHQWVHO0FBQ0gsK0JBQTBCO0FBQzFCLDRDQUE4QztBQU05QywwQ0FBNEM7QUFDNUMsaUVBQStEO0FBRS9ELG9CQUFvQjtBQUNQLFFBQUEsaUJBQWlCLEdBQUcsQ0FBQyxHQUFHLElBQUksR0FBRyxJQUFJLENBQUM7QUFFakQsNENBQTRDO0FBQy9CLFFBQUEsYUFBYSxHQUFHLENBQUMsR0FBRyxJQUFJLEdBQUcsSUFBSSxDQUFDO0FBRTdDLDBFQUEwRTtBQUM3RCxRQUFBLHNCQUFzQixHQUFHLENBQUMsR0FBRyxJQUFJLEdBQUcsSUFBSSxDQUFDO0FBRXRELDJCQUEyQjtBQUNkLFFBQUEsNkJBQTZCLEdBQUcsSUFBSSxHQUFHLElBQUksQ0FBQztBQUV6RCxpQ0FBaUM7QUFDcEIsUUFBQSxjQUFjLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQztBQUUzQixRQUFBLHNCQUFzQixHQUFHLElBQUksQ0FBQztBQUUzQyxJQUFNLEtBQUssR0FBRyxlQUFLLENBQUMsb0JBQW9CLENBQUMsQ0FBQztBQVExQztJQUErQyw0Q0FBWTtJQXNCekQsMEJBQStCLFlBQWdDLEVBQXFCLFdBQXVCO1FBQXZCLDRCQUFBLEVBQUEsZUFBdUI7UUFBM0csWUFDRSxpQkFBTyxTQUNSO1FBRjhCLGtCQUFZLEdBQVosWUFBWSxDQUFvQjtRQUFxQixpQkFBVyxHQUFYLFdBQVcsQ0FBWTtRQXJCM0cscUJBQXFCO1FBQ1gsY0FBUSxHQUFXLHlCQUFpQixDQUFDO1FBRS9DLDRCQUE0QjtRQUNsQiwwQkFBb0IsR0FBVyxnQkFBUSxFQUFFLENBQUMsQ0FBQyxDQUFDLHFDQUE2QixDQUFDLENBQUMsQ0FBQyw4QkFBc0IsQ0FBQztRQUluRyxhQUFPLEdBQVcsRUFBRSxHQUFHLElBQUksQ0FBQztRQUM1QixnQkFBVSwyQkFBa0M7UUFN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SUFDSSxrREFBdUIsR0FBOUI7UUFDRSxPQUFPLElBQUksQ0FBQyxvQkFBb0IsQ0FBQztJQUNuQyxDQUFDO0lBRUQ7Ozs7OztPQU1HO0lBQ0ksaUNBQU0sR0FBYjtRQUNFLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFO1lBQ2IsTUFBTSxJQUFJLGdDQUFjLENBQUMsb0JBQW9CLENBQUMsQ0FBQztTQUNoRDtRQUVELE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQztJQUNsQixDQUFDO0lBeUJILHVCQUFDO0FBQUQsQ0FoTEEsQUFnTEMsQ0FoTDhDLFlBQVksR0FnTDFEO0FBaExxQiw0Q0FBZ0IiLCJmaWxlIjoibGliL2FwaS91cGxvYWQvdXBsb2FkZXJzL2Fic3RyYWN0LmpzIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIENvcHlyaWdodCAoYykgMjAxOSBieSBGaWxlc3RhY2suXG4gKiBTb21lIHJpZ2h0cyByZXNlcnZlZC5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cbmltcG9ydCBEZWJ1ZyBmcm9tICdkZWJ1Zyc7XG5pbXBvcnQgKiBhcyBFdmVudEVtaXR0ZXIgZnJvbSAnZXZlbnRlbWl0dGVyMyc7XG5cbmltcG9ydCB7IEZpbGUsIFVwbG9hZFRhZ3MgfSBmcm9tICcuLy4uL2ZpbGUnO1xuaW1wb3J0IHsgU3RvcmVVcGxvYWRPcHRpb25zIH0gZnJvbSAnLi8uLi90eXBlcyc7XG5pbXBvcnQgeyBTZWN1cml0eSB9IGZyb20gJy4vLi4vLi4vLi4vY2xpZW50JztcbmltcG9ydCB7IEZzUmV0cnlDb25maWcgfSBmcm9tICcuLy4uLy4uLy4uL3JlcXVlc3QnO1xuaW1wb3J0IHsgaXNNb2JpbGUgfSBmcm9tICcuLy4uLy4uLy4uL3V0aWxzJztcbmltcG9ydCB7IEZpbGVzdGFja0Vycm9yIH0gZnJvbSAnLi8uLi8uLi8uLi8uLi9maWxlc3RhY2tfZXJyb3InO1xuXG4vLyByZWd1bGFyIHBhcnQgc2l6ZVxuZXhwb3J0IGNvbnN0IERFRkFVTFRfUEFSVF9TSVpFID0gNiAqIDEwMjQgKiAxMDI0O1xuXG4vLyBNaW5pbXVtIHBhcnQgc2l6ZSBmb3IgdXBsb2FkIGJ5IG11bHRpcGFydFxuZXhwb3J0IGNvbnN0IE1JTl9QQVJUX1NJWkUgPSA1ICogMTAyNCAqIDEwMjQ7XG5cbi8vIHdoZW4gbW9kZSBpcyBzZXQgdG8gZmFsbGJhY2sgb3IgaW50ZWxsaWdlbnQsIHRoaXMgcGFydCBzaXplIGlzIHJlcXVpcmVkXG5leHBvcnQgY29uc3QgSU5URUxMSUdFTlRfQ0hVTktfU0laRSA9IDggKiAxMDI0ICogMTAyNDtcblxuLy8gTW9iaWxlIENodW5rIHNpemUgZm9yIGlpXG5leHBvcnQgY29uc3QgSU5URUxMSUdFTlRfTU9CSUxFX0NIVU5LX1NJWkUgPSAxMDI0ICogMTAyNDtcblxuLy8gbWluaW11bSBpbnRlbGxpZ2VudCBjaHVuayBzaXplXG5leHBvcnQgY29uc3QgTUlOX0NIVU5LX1NJWkUgPSAzMiAqIDEwMjQ7XG5cbmV4cG9ydCBjb25zdCBERUZBVUxUX1NUT1JFX0xPQ0FUSU9OID0gJ3MzJztcblxuY29uc3QgZGVidWcgPSBEZWJ1ZygnZnM6dXBsb2FkOmFic3RyYWN0Jyk7XG5cbmV4cG9ydCBjb25zdCBlbnVtIFVwbG9hZE1vZGUge1xuICBERUZBVUxUID0gJ2RlZmF1bHQnLFxuICBJTlRFTExJR0VOVCA9ICdpbnRlbGxpZ2VudCcsXG4gIEZBTExCQUNLID0gJ2ZhbGxiYWNrJyxcbn1cblxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIFVwbG9hZGVyQWJzdHJhY3QgZXh0ZW5kcyBFdmVudEVtaXR0ZXIge1xuICAvLyBQYXJ0cyBzaXplIG9wdGlvbnNcbiAgcHJvdGVjdGVkIHBhcnRTaXplOiBudW1iZXIgPSBERUZBVUxUX1BBUlRfU0laRTtcblxuICAvLyBjaHVuayBzaXplIGZvciBpaSB1cGxvYWRzXG4gIHByb3RlY3RlZCBpbnRlbGxpZ2VudENodW5rU2l6ZTogbnVtYmVyID0gaXNNb2JpbGUoKSA/IElOVEVMTElHRU5UX01PQklMRV9DSFVOS19TSVpFIDogSU5URUxMSUdFTlRfQ0hVTktfU0laRTtcblxuICAvLyB1cGxvYWQgb3B0aW9uc1xuICBwcm90ZWN0ZWQgdXJsOiBzdHJpbmc7XG4gIHByb3RlY3RlZCB0aW1lb3V0OiBudW1iZXIgPSAzMCAqIDEwMDA7XG4gIHByb3RlY3RlZCB1cGxvYWRNb2RlOiBVcGxvYWRNb2RlID0gVXBsb2FkTW9kZS5ERUZBVUxUO1xuXG4gIC8vIGFwcGxpY2F0aW9uIHNldHRpbmdzXG4gIHByb3RlY3RlZCBhcGlrZXk6IHN0cmluZztcbiAgcHJvdGVjdGVkIHNlY3VyaXR5OiBTZWN1cml0eTtcblxuICBwcm90ZWN0ZWQgaXNNb2RlTG9ja2VkOiBib29sZWFuID0gZmFsc2U7IC8vIGlmIGFjY291bnQgZG9lcyBub3Qgc3VwcG9ydCBpaSBpbiBmYWxsYmFjayBtb2RlIHdlIHNob3VsZCBhYm9ydFxuICBwcm90ZWN0ZWQgcmV0cnlDb25maWc6IEZzUmV0cnlDb25maWc7XG4gIHByb3RlY3RlZCBpbnRlZ3JpdHlDaGVjazogYm9vbGVhbiA9IHRydWU7XG5cbiAgcHJvdGVjdGVkIHVwbG9hZFRhZ3M6IFVwbG9hZFRhZ3MgPSBudWxsO1xuXG4gIGNvbnN0cnVjdG9yKHByb3RlY3RlZCByZWFkb25seSBzdG9yZU9wdGlvbnM6IFN0b3JlVXBsb2FkT3B0aW9ucywgcHJvdGVjdGVkIHJlYWRvbmx5IGNvbmN1cnJlbmN5OiBudW1iZXIgPSAzKSB7XG4gICAgc3VwZXIoKTtcbiAgfVxuXG4gIHB1YmxpYyBzZXRTZWN1cml0eShzZWN1cml0eTogU2VjdXJpdHkpOiB2b2lkIHtcbiAgICBkZWJ1ZygnU2V0IHNlY3VyaXR5ICVPJywgc2VjdXJpdHkpO1xuICAgIHRoaXMuc2VjdXJpdHkgPSBzZWN1cml0eTtcbiAgfVxuXG4gIHB1YmxpYyBzZXRBcGlrZXkoYXBpa2V5OiBzdHJpbmcpOiB2b2lkIHtcbiAgICBkZWJ1ZyhgU2V0IGFwaWtleSB0byAke2FwaWtleX1gKTtcbiAgICB0aGlzLmFwaWtleSA9IGFwaWtleTtcbiAgfVxuXG4gIHB1YmxpYyBzZXRUaW1lb3V0KHRpbWVvdXQ6IG51bWJlcik6IHZvaWQge1xuICAgIGRlYnVnKGBTZXQgcmVxdWVzdCB0aW1lb3V0IHRvICR7dGltZW91dH1gKTtcbiAgICB0aGlzLnRpbWVvdXQgPSB0aW1lb3V0O1xuICB9XG5cbiAgcHVibGljIHNldFJldHJ5Q29uZmlnKGNmZzogRnNSZXRyeUNvbmZpZykge1xuICAgIGRlYnVnKGBTZXQgcmV0cnkgY29uZmlnIHRvICR7Y2ZnfWApO1xuICAgIHRoaXMucmV0cnlDb25maWcgPSBjZmc7XG4gIH1cblxuICBwdWJsaWMgc2V0VXJsKHVybDogc3RyaW5nKTogdm9pZCB7XG4gICAgZGVidWcoYFNldCB1cGxvYWQgdXJsIHRvICR7dXJsfWApO1xuICAgIHRoaXMudXJsID0gdXJsO1xuICB9XG5cbiAgcHVibGljIHNldFVwbG9hZFRhZ3ModGFnczogVXBsb2FkVGFncykge1xuICAgIGRlYnVnKGBTZXQgdGFncyB0byAlT2AsIHRhZ3MpO1xuICAgIHRoaXMudXBsb2FkVGFncyA9IHRhZ3M7XG4gIH1cblxuICAvKipcbiAgICogU2V0IHN0YXRlIG9mIGNoZWNraW5nIGZpbGUgaW50ZWdyaXR5XG4gICAqIEBwYXJhbSBzdGF0ZVxuICAgKi9cbiAgcHVibGljIHNldEludGVncml0eUNoZWNrKHN0YXRlKSB7XG4gICAgdGhpcy5pbnRlZ3JpdHlDaGVjayA9IHN0YXRlO1xuICB9XG5cbiAgLyoqXG4gICAqIFNldHMgdXBsb2FkIG1vZGVcbiAgICpcbiAgICogQHBhcmFtIHtVcGxvYWRNb2RlfSBtb2RlXG4gICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2xvY2s9ZmFsc2VdXG4gICAqIEByZXR1cm5zXG4gICAqIEBtZW1iZXJvZiBNdWx0aXBhcnRVcGxvYWRlclxuICAgKi9cbiAgcHVibGljIHNldFVwbG9hZE1vZGUobW9kZTogVXBsb2FkTW9kZSwgbG9jazogYm9vbGVhbiA9IGZhbHNlKTogdm9pZCB7XG4gICAgLy8gdGhpcyBzaG91bGRudCBoYXBwZW5kIGJ1dCBmb3Igc2FmZXR5IHJlYXNvbnMgaWYgd2lsbCBzdGF5XG4gICAgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi9cbiAgICBpZiAodGhpcy5pc01vZGVMb2NrZWQgPT09IHRydWUpIHtcbiAgICAgIGRlYnVnKGBDYW5ub3Qgc3dpdGNoIG1vZGUgdG8gJHttb2RlfS4gTG9ja2VkISBQcm9iYWJseSBtb2RlIGlzIG5vdCBzdXBwb3J0ZWQgYXQgdGhpcyBhcGlrZXlgKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0aGlzLmlzTW9kZUxvY2tlZCA9IGxvY2s7XG5cbiAgICBkZWJ1ZyhgU2V0IHVwbG9hZCBtb2RlIHRvICR7bW9kZX1gKTtcblxuICAgIHRoaXMudXBsb2FkTW9kZSA9IG1vZGU7XG4gIH1cblxuICAvKipcbiAgICogU2V0IHVwbG9hZCBwYXJ0IHNpemVcbiAgICogaWYgcGFydCBzaXplIGlzIHNtYWxsZXIgdGhhbiBtaW5pbXVtIDVtYiBpdCB3aWxsIHRocm93IGVycm9yXG4gICAqXG4gICAqIEBwYXJhbSB7bnVtYmVyfSBzaXplXG4gICAqIEByZXR1cm5zIHt2b2lkfVxuICAgKiBAbWVtYmVyb2YgUzNVcGxvYWRlclxuICAgKi9cbiAgcHVibGljIHNldFBhcnRTaXplKHNpemU6IG51bWJlcik6IHZvaWQge1xuICAgIGlmICh0aGlzLnVwbG9hZE1vZGUgIT09IFVwbG9hZE1vZGUuREVGQVVMVCkge1xuICAgICAgZGVidWcoJ0Nhbm5vdCBzZXQgcGFydCBzaXplIGJlY2F1c2UgdXBsb2FkIG1vZGUgaXMgb3RoZXIgdGhhbiBkZWZhdWx0LiAnKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBkZWJ1ZyhgU2V0IHBhcnQgc2l6ZSB0byAke3NpemV9YCk7XG5cbiAgICBpZiAoc2l6ZSA8IE1JTl9QQVJUX1NJWkUpIHtcbiAgICAgIHRocm93IG5ldyBGaWxlc3RhY2tFcnJvcignTWluaW11bSBwYXJ0IHNpemUgaXMgNU1CJyk7XG4gICAgfVxuXG4gICAgdGhpcy5wYXJ0U2l6ZSA9IHNpemU7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyBjdXJyZW50IHBhcnQgc2l6ZVxuICAgKi9cbiAgcHVibGljIGdldFBhcnRTaXplKCkge1xuICAgIHJldHVybiB0aGlzLnBhcnRTaXplO1xuICB9XG5cbiAgLyoqXG4gICAqIFNldCBzdGFydCBwYXJ0IHNpemUgZm9yIGlpXG4gICAqXG4gICAqIEBwYXJhbSB7bnVtYmVyfSBzaXplXG4gICAqIEBtZW1iZXJvZiBTM1VwbG9hZGVyXG4gICAqL1xuICBwdWJsaWMgc2V0SW50ZWxsaWdlbnRDaHVua1NpemUoc2l6ZTogbnVtYmVyKTogdm9pZCB7XG4gICAgZGVidWcoYFNldCBpbnRlbGlnZW50IGNodW5rIHNpemUgdG8gJHtzaXplfWApO1xuICAgIGlmIChzaXplIDwgTUlOX0NIVU5LX1NJWkUpIHtcbiAgICAgIHRocm93IG5ldyBGaWxlc3RhY2tFcnJvcihgTWluaW11bSBpbnRlbGxpZ2VudCBjaHVuayBzaXplIGlzICR7TUlOX0NIVU5LX1NJWkV9YCk7XG4gICAgfVxuICAgIHRoaXMuaW50ZWxsaWdlbnRDaHVua1NpemUgPSBzaXplO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgaW50ZWxsaWdlbnQgY2h1bmsgc2l6ZVxuICAgKi9cbiAgcHVibGljIGdldEludGVsbGlnZW50Q2h1bmtTaXplKCk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMuaW50ZWxsaWdlbnRDaHVua1NpemU7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyBmaWxlc3RhY2sgdXBsb2FkIHVybFxuICAgKlxuICAgKiBAcHJpdmF0ZVxuICAgKiBAcmV0dXJuc1xuICAgKiBAbWVtYmVyb2YgTXVsdGlwYXJ0VXBsb2FkZXJcbiAgICovXG4gIHB1YmxpYyBnZXRVcmwoKTogc3RyaW5nIHtcbiAgICBpZiAoIXRoaXMudXJsKSB7XG4gICAgICB0aHJvdyBuZXcgRmlsZXN0YWNrRXJyb3IoJ1VwbG9hZCB1cmwgbm90IHNldCcpO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLnVybDtcbiAgfVxuXG4gIC8qKlxuICAgKiBQYXVzZSB1cGxvYWQgcXVldWVcbiAgICpcbiAgICogQG1lbWJlcm9mIE11bHRpcGFydFVwbG9hZGVyXG4gICAqL1xuICBwdWJsaWMgYWJzdHJhY3QgcGF1c2UoKTogdm9pZDtcbiAgLyoqXG4gICAqIHJlc3VtZSB1cGxvYWQgcXVldWUgaWYgaXRzIHBhdXNlZFxuICAgKlxuICAgKiBAbWVtYmVyb2YgTXVsdGlwYXJ0VXBsb2FkZXJcbiAgICovXG4gIHB1YmxpYyBhYnN0cmFjdCByZXN1bWUoKTogdm9pZDtcblxuICAvKipcbiAgICogQWJvcnRzIHF1ZXVlIChhbGwgcGVuZGluZyByZXF1ZXN0cyB3aXRoIHdpbGwgYmUgYWJvcnRlZClcbiAgICpcbiAgICogQG1lbWJlcm9mIE11bHRpcGFydFVwbG9hZGVyXG4gICAqL1xuICBwdWJsaWMgYWJzdHJhY3QgYWJvcnQobXNnPzogc3RyaW5nKTogdm9pZDtcblxuICBwdWJsaWMgYWJzdHJhY3QgYWRkRmlsZShmaWxlOiBGaWxlKTogc3RyaW5nO1xuXG4gIHB1YmxpYyBhYnN0cmFjdCBhc3luYyBleGVjdXRlKCk6IFByb21pc2U8YW55Pjtcbn1cbiJdfQ==

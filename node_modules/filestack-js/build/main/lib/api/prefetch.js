"use strict";
/*
 * Copyright (c) 2018 by Filestack.
 * Some rights reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
Object.defineProperty(exports, "__esModule", { value: true });
var tslib_1 = require("tslib");
// import Debug from 'debug';
var filestack_error_1 = require("./../../filestack_error");
var client_1 = require("./../client");
var request_1 = require("../request");
var utils_1 = require("./../utils");
var PrefetchEvents;
(function (PrefetchEvents) {
    PrefetchEvents["PICKER"] = "picker";
    PrefetchEvents["TRANSFORM_UI"] = "transform_ui";
})(PrefetchEvents = exports.PrefetchEvents || (exports.PrefetchEvents = {}));
/**
 * @private
 */
var Prefetch = /** @class */ (function () {
    function Prefetch(param) {
        if (param instanceof client_1.Client) {
            this.session = param.session;
        }
        else {
            this.session = param;
        }
    }
    /**
     * Returns filestack options from backend according to input params
     *
     * @param param0
     */
    Prefetch.prototype.getConfig = function (_a) {
        var pickerOptions = _a.pickerOptions, settings = _a.settings, permissions = _a.permissions, events = _a.events;
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var paramsToSend, pickerOptionsToSend;
            var _this = this;
            return tslib_1.__generator(this, function (_b) {
                paramsToSend = {
                    apikey: this.session.apikey,
                };
                if (this.session.policy && this.session.signature) {
                    paramsToSend.security = { policy: this.session.policy, signature: this.session.signature };
                }
                // if (this.session.prefetch && events) {
                //   return FsRequest.post(`${this.session.urls.uploadApiUrl}/prefetch`, { ...paramsToSend, events }).then(() => this.session.prefetch);
                // }
                // we should always ask for this setting for picker
                if (!settings) {
                    settings = ['inapp_browser'];
                }
                else {
                    settings = settings.concat(['inapp_browser']);
                    // make arrray unique
                    settings = settings.filter(function (v, i) { return settings.indexOf(v) === i; });
                }
                if (pickerOptions && Object.keys(pickerOptions).length) {
                    pickerOptionsToSend = utils_1.cleanUpCallbacks(tslib_1.__assign({}, pickerOptions));
                }
                paramsToSend = tslib_1.__assign(tslib_1.__assign({}, paramsToSend), { permissions: permissions,
                    settings: settings, picker_config: pickerOptionsToSend, events: events });
                this.session.prefetch = null;
                return [2 /*return*/, request_1.FsRequest.post(this.session.urls.uploadApiUrl + "/prefetch", paramsToSend).then(function (res) {
                        /* istanbul ignore if */
                        if (res.status !== 200) {
                            throw new filestack_error_1.FilestackError('There is a problem with prefetch request');
                        }
                        var data = res.data;
                        // if backend not returning updated_config cay we take old config and return
                        if (data.updated_config) {
                            // reassign callback from old config to new one returned from backend
                            data.pickerOptions = _this.reassignCallbacks(pickerOptions, data.updated_config || {});
                            delete data.updated_config;
                        }
                        else {
                            data.pickerOptions = pickerOptions;
                        }
                        _this.session.prefetch = data;
                        return data;
                    })];
            });
        });
    };
    /**
     * Reassign callbacks from old picker configuration
     *
     * @param objOld
     * @param objTarget
     */
    Prefetch.prototype.reassignCallbacks = function (objOld, objTarget) {
        if (!objOld || Object.keys(objOld).length === 0) {
            return objOld;
        }
        for (var k in objOld) {
            if (typeof objOld[k] === 'function') {
                objTarget[k] = objOld[k];
            }
            if (objOld[k] === Object(objOld[k])) {
                objTarget[k] = this.reassignCallbacks(objOld[k], objTarget[k]);
            }
        }
        return objTarget;
    };
    return Prefetch;
}());
exports.Prefetch = Prefetch;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9saWIvYXBpL3ByZWZldGNoLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7Ozs7Ozs7Ozs7O0dBZUc7OztBQUVILDZCQUE2QjtBQUM3QiwyREFBeUQ7QUFDekQsc0NBQXdEO0FBRXhELHNDQUF1QztBQUN2QyxvQ0FBOEM7QUFnQjlDLElBQVksY0FHWDtBQUhELFdBQVksY0FBYztJQUN4QixtQ0FBaUIsQ0FBQTtJQUNqQiwrQ0FBNkIsQ0FBQTtBQUMvQixDQUFDLEVBSFcsY0FBYyxHQUFkLHNCQUFjLEtBQWQsc0JBQWMsUUFHekI7QUF5QkQ7O0dBRUc7QUFDSDtJQUlFLGtCQUFZLEtBQXVCO1FBQ2pDLElBQUksS0FBSyxZQUFZLGVBQU0sRUFBRTtZQUMzQixJQUFJLENBQUMsT0FBTyxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUM7U0FDOUI7YUFBTTtZQUNMLElBQUksQ0FBQyxPQUFPLEdBQUcsS0FBSyxDQUFDO1NBQ3RCO0lBQ0gsQ0FBQztJQUVEOzs7O09BSUc7SUFDRyw0QkFBUyxHQUFmLFVBQWdCLEVBQWlFO1lBQS9ELGdDQUFhLEVBQUUsc0JBQVEsRUFBRSw0QkFBVyxFQUFFLGtCQUFNOzs7OztnQkFDeEQsWUFBWSxHQUFvQjtvQkFDbEMsTUFBTSxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTTtpQkFDNUIsQ0FBQztnQkFFRixJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxFQUFFO29CQUNqRCxZQUFZLENBQUMsUUFBUSxHQUFHLEVBQUUsTUFBTSxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLFNBQVMsRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsRUFBRSxDQUFDO2lCQUM1RjtnQkFFRCx5Q0FBeUM7Z0JBQ3pDLHdJQUF3STtnQkFDeEksSUFBSTtnQkFFSixtREFBbUQ7Z0JBQ25ELElBQUksQ0FBQyxRQUFRLEVBQUU7b0JBQ2IsUUFBUSxHQUFHLENBQUMsZUFBZSxDQUFDLENBQUM7aUJBQzlCO3FCQUFNO29CQUNMLFFBQVEsR0FBRyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQztvQkFDOUMscUJBQXFCO29CQUNyQixRQUFRLEdBQUcsUUFBUSxDQUFDLE1BQU0sQ0FBQyxVQUFDLENBQUMsRUFBRSxDQUFDLElBQUssT0FBQSxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsRUFBekIsQ0FBeUIsQ0FBQyxDQUFDO2lCQUNqRTtnQkFHRCxJQUFJLGFBQWEsSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDLE1BQU0sRUFBRTtvQkFDdEQsbUJBQW1CLEdBQUcsd0JBQWdCLHNCQUFNLGFBQWEsRUFBRyxDQUFDO2lCQUM5RDtnQkFFRCxZQUFZLHlDQUNQLFlBQVksS0FDZixXQUFXLGFBQUE7b0JBQ1gsUUFBUSxVQUFBLEVBQ1IsYUFBYSxFQUFFLG1CQUFtQixFQUNsQyxNQUFNLFFBQUEsR0FDUCxDQUFDO2dCQUVGLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQztnQkFFN0Isc0JBQU8sbUJBQVMsQ0FBQyxJQUFJLENBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsWUFBWSxjQUFXLEVBQUUsWUFBWSxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQUMsR0FBRzt3QkFDekYsd0JBQXdCO3dCQUN4QixJQUFJLEdBQUcsQ0FBQyxNQUFNLEtBQUssR0FBRyxFQUFFOzRCQUN0QixNQUFNLElBQUksZ0NBQWMsQ0FBQywwQ0FBMEMsQ0FBQyxDQUFDO3lCQUN0RTt3QkFFRCxJQUFJLElBQUksR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDO3dCQUVwQiw0RUFBNEU7d0JBQzVFLElBQUksSUFBSSxDQUFDLGNBQWMsRUFBRTs0QkFDdkIscUVBQXFFOzRCQUNyRSxJQUFJLENBQUMsYUFBYSxHQUFHLEtBQUksQ0FBQyxpQkFBaUIsQ0FBQyxhQUFhLEVBQUUsSUFBSSxDQUFDLGNBQWMsSUFBSSxFQUFFLENBQUMsQ0FBQzs0QkFDdEYsT0FBTyxJQUFJLENBQUMsY0FBYyxDQUFDO3lCQUM1Qjs2QkFBTTs0QkFDTCxJQUFJLENBQUMsYUFBYSxHQUFHLGFBQWEsQ0FBQzt5QkFDcEM7d0JBRUQsS0FBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDO3dCQUU3QixPQUFPLElBQUksQ0FBQztvQkFDZCxDQUFDLENBQUMsRUFBQzs7O0tBQ0o7SUFFRDs7Ozs7T0FLRztJQUNLLG9DQUFpQixHQUF6QixVQUEwQixNQUFNLEVBQUUsU0FBUztRQUN6QyxJQUFJLENBQUMsTUFBTSxJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtZQUMvQyxPQUFPLE1BQU0sQ0FBQztTQUNmO1FBRUQsS0FBSyxJQUFNLENBQUMsSUFBSSxNQUFNLEVBQUU7WUFDdEIsSUFBSSxPQUFPLE1BQU0sQ0FBQyxDQUFDLENBQUMsS0FBSyxVQUFVLEVBQUU7Z0JBQ25DLFNBQVMsQ0FBQyxDQUFDLENBQUMsR0FBRyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7YUFDMUI7WUFFRCxJQUFJLE1BQU0sQ0FBQyxDQUFDLENBQUMsS0FBSyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUU7Z0JBQ25DLFNBQVMsQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO2FBQ2hFO1NBQ0Y7UUFFRCxPQUFPLFNBQVMsQ0FBQztJQUNuQixDQUFDO0lBQ0gsZUFBQztBQUFELENBcEdBLEFBb0dDLElBQUE7QUFwR1ksNEJBQVEiLCJmaWxlIjoibGliL2FwaS9wcmVmZXRjaC5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTggYnkgRmlsZXN0YWNrLlxuICogU29tZSByaWdodHMgcmVzZXJ2ZWQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbi8vIGltcG9ydCBEZWJ1ZyBmcm9tICdkZWJ1Zyc7XG5pbXBvcnQgeyBGaWxlc3RhY2tFcnJvciB9IGZyb20gJy4vLi4vLi4vZmlsZXN0YWNrX2Vycm9yJztcbmltcG9ydCB7IFNlc3Npb24sIFNlY3VyaXR5LCBDbGllbnQgfSBmcm9tICcuLy4uL2NsaWVudCc7XG5pbXBvcnQgeyBQaWNrZXJPcHRpb25zIH0gZnJvbSAnLi8uLi9waWNrZXInO1xuaW1wb3J0IHsgRnNSZXF1ZXN0IH0gZnJvbSAnLi4vcmVxdWVzdCc7XG5pbXBvcnQgeyBjbGVhblVwQ2FsbGJhY2tzIH0gZnJvbSAnLi8uLi91dGlscyc7XG5cbi8vIGNvbnN0IGRlYnVnID0gRGVidWcoJ2ZzOnByZWZldGNoJyk7XG5cbmV4cG9ydCB0eXBlIFByZWZldGNoU2V0dGluZ3MgPSB7XG4gIGluYXBwX2Jyb3dzZXI/OiBib29sZWFuO1xufTtcblxuZXhwb3J0IHR5cGUgUHJlZmV0Y2hQZXJtaXNzaW9ucyA9IHtcbiAgaW50ZWxsaWdlbnRfaW5nZXN0aW9uPzogYm9vbGVhbjtcbiAgd2hpdGVsYWJlbD86IGJvb2xlYW47XG4gIHRyYW5zZm9ybXNfdWk/OiBib29sZWFuO1xuICBlbmhhbmNlPzogYm9vbGVhbjtcbiAgYWR2YW5jZWRfZW5oYW5jZT86IGJvb2xlYW47XG59O1xuXG5leHBvcnQgZW51bSBQcmVmZXRjaEV2ZW50cyB7XG4gIFBJQ0tFUiA9ICdwaWNrZXInLFxuICBUUkFOU0ZPUk1fVUkgPSAndHJhbnNmb3JtX3VpJyxcbn1cblxuZXhwb3J0IHR5cGUgUHJlZmV0Y2hPcHRpb25zID0ge1xuICBwaWNrZXJPcHRpb25zPzogUGlja2VyT3B0aW9ucztcbiAgc2V0dGluZ3M/OiBBcnJheTxrZXlvZiBQcmVmZXRjaFNldHRpbmdzPjtcbiAgcGVybWlzc2lvbnM/OiBBcnJheTxrZXlvZiBQcmVmZXRjaFBlcm1pc3Npb25zPjtcbiAgZXZlbnRzPzogUHJlZmV0Y2hFdmVudHNbXTtcbn07XG5cbmludGVyZmFjZSBQcmVmZXRjaFJlcXVlc3Qge1xuICBhcGlrZXk6IHN0cmluZztcbiAgc2VjdXJpdHk/OiBTZWN1cml0eTtcbiAgcGVybWlzc2lvbnM/OiBBcnJheTxrZXlvZiBQcmVmZXRjaFBlcm1pc3Npb25zPjtcbiAgc2V0dGluZ3M/OiBBcnJheTxrZXlvZiBQcmVmZXRjaFNldHRpbmdzPjtcbiAgZXZlbnRzPzogUHJlZmV0Y2hFdmVudHNbXTtcbiAgcGlja2VyX2NvbmZpZz86IFBpY2tlck9wdGlvbnM7XG59XG5cbmV4cG9ydCB0eXBlIFByZWZldGNoUmVzcG9uc2UgPSB7XG4gIGJsb2NrZWQ/OiBib29sZWFuIHwgc3RyaW5nO1xuICBzZXR0aW5ncz86IFByZWZldGNoU2V0dGluZ3M7XG4gIHBlcm1pc3Npb25zPzogUHJlZmV0Y2hQZXJtaXNzaW9ucztcbiAgcGlja2VyT3B0aW9uczogUGlja2VyT3B0aW9ucztcbn07XG5cbi8qKlxuICogQHByaXZhdGVcbiAqL1xuZXhwb3J0IGNsYXNzIFByZWZldGNoIHtcblxuICBwcml2YXRlIHNlc3Npb246IFNlc3Npb247XG5cbiAgY29uc3RydWN0b3IocGFyYW06IFNlc3Npb24gfCBDbGllbnQpIHtcbiAgICBpZiAocGFyYW0gaW5zdGFuY2VvZiBDbGllbnQpIHtcbiAgICAgIHRoaXMuc2Vzc2lvbiA9IHBhcmFtLnNlc3Npb247XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuc2Vzc2lvbiA9IHBhcmFtO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIGZpbGVzdGFjayBvcHRpb25zIGZyb20gYmFja2VuZCBhY2NvcmRpbmcgdG8gaW5wdXQgcGFyYW1zXG4gICAqXG4gICAqIEBwYXJhbSBwYXJhbTBcbiAgICovXG4gIGFzeW5jIGdldENvbmZpZyh7IHBpY2tlck9wdGlvbnMsIHNldHRpbmdzLCBwZXJtaXNzaW9ucywgZXZlbnRzIH06IFByZWZldGNoT3B0aW9ucyk6IFByb21pc2U8UHJlZmV0Y2hSZXNwb25zZT4ge1xuICAgIGxldCBwYXJhbXNUb1NlbmQ6IFByZWZldGNoUmVxdWVzdCA9IHtcbiAgICAgIGFwaWtleTogdGhpcy5zZXNzaW9uLmFwaWtleSxcbiAgICB9O1xuXG4gICAgaWYgKHRoaXMuc2Vzc2lvbi5wb2xpY3kgJiYgdGhpcy5zZXNzaW9uLnNpZ25hdHVyZSkge1xuICAgICAgcGFyYW1zVG9TZW5kLnNlY3VyaXR5ID0geyBwb2xpY3k6IHRoaXMuc2Vzc2lvbi5wb2xpY3ksIHNpZ25hdHVyZTogdGhpcy5zZXNzaW9uLnNpZ25hdHVyZSB9O1xuICAgIH1cblxuICAgIC8vIGlmICh0aGlzLnNlc3Npb24ucHJlZmV0Y2ggJiYgZXZlbnRzKSB7XG4gICAgLy8gICByZXR1cm4gRnNSZXF1ZXN0LnBvc3QoYCR7dGhpcy5zZXNzaW9uLnVybHMudXBsb2FkQXBpVXJsfS9wcmVmZXRjaGAsIHsgLi4ucGFyYW1zVG9TZW5kLCBldmVudHMgfSkudGhlbigoKSA9PiB0aGlzLnNlc3Npb24ucHJlZmV0Y2gpO1xuICAgIC8vIH1cblxuICAgIC8vIHdlIHNob3VsZCBhbHdheXMgYXNrIGZvciB0aGlzIHNldHRpbmcgZm9yIHBpY2tlclxuICAgIGlmICghc2V0dGluZ3MpIHtcbiAgICAgIHNldHRpbmdzID0gWydpbmFwcF9icm93c2VyJ107XG4gICAgfSBlbHNlIHtcbiAgICAgIHNldHRpbmdzID0gc2V0dGluZ3MuY29uY2F0KFsnaW5hcHBfYnJvd3NlciddKTtcbiAgICAgIC8vIG1ha2UgYXJycmF5IHVuaXF1ZVxuICAgICAgc2V0dGluZ3MgPSBzZXR0aW5ncy5maWx0ZXIoKHYsIGkpID0+IHNldHRpbmdzLmluZGV4T2YodikgPT09IGkpO1xuICAgIH1cblxuICAgIGxldCBwaWNrZXJPcHRpb25zVG9TZW5kO1xuICAgIGlmIChwaWNrZXJPcHRpb25zICYmIE9iamVjdC5rZXlzKHBpY2tlck9wdGlvbnMpLmxlbmd0aCkge1xuICAgICAgcGlja2VyT3B0aW9uc1RvU2VuZCA9IGNsZWFuVXBDYWxsYmFja3MoeyAuLi5waWNrZXJPcHRpb25zIH0pO1xuICAgIH1cblxuICAgIHBhcmFtc1RvU2VuZCA9IHtcbiAgICAgIC4uLnBhcmFtc1RvU2VuZCxcbiAgICAgIHBlcm1pc3Npb25zLFxuICAgICAgc2V0dGluZ3MsXG4gICAgICBwaWNrZXJfY29uZmlnOiBwaWNrZXJPcHRpb25zVG9TZW5kLFxuICAgICAgZXZlbnRzLFxuICAgIH07XG5cbiAgICB0aGlzLnNlc3Npb24ucHJlZmV0Y2ggPSBudWxsO1xuXG4gICAgcmV0dXJuIEZzUmVxdWVzdC5wb3N0KGAke3RoaXMuc2Vzc2lvbi51cmxzLnVwbG9hZEFwaVVybH0vcHJlZmV0Y2hgLCBwYXJhbXNUb1NlbmQpLnRoZW4oKHJlcykgPT4ge1xuICAgICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovXG4gICAgICBpZiAocmVzLnN0YXR1cyAhPT0gMjAwKSB7XG4gICAgICAgIHRocm93IG5ldyBGaWxlc3RhY2tFcnJvcignVGhlcmUgaXMgYSBwcm9ibGVtIHdpdGggcHJlZmV0Y2ggcmVxdWVzdCcpO1xuICAgICAgfVxuXG4gICAgICBsZXQgZGF0YSA9IHJlcy5kYXRhO1xuXG4gICAgICAvLyBpZiBiYWNrZW5kIG5vdCByZXR1cm5pbmcgdXBkYXRlZF9jb25maWcgY2F5IHdlIHRha2Ugb2xkIGNvbmZpZyBhbmQgcmV0dXJuXG4gICAgICBpZiAoZGF0YS51cGRhdGVkX2NvbmZpZykge1xuICAgICAgICAvLyByZWFzc2lnbiBjYWxsYmFjayBmcm9tIG9sZCBjb25maWcgdG8gbmV3IG9uZSByZXR1cm5lZCBmcm9tIGJhY2tlbmRcbiAgICAgICAgZGF0YS5waWNrZXJPcHRpb25zID0gdGhpcy5yZWFzc2lnbkNhbGxiYWNrcyhwaWNrZXJPcHRpb25zLCBkYXRhLnVwZGF0ZWRfY29uZmlnIHx8IHt9KTtcbiAgICAgICAgZGVsZXRlIGRhdGEudXBkYXRlZF9jb25maWc7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBkYXRhLnBpY2tlck9wdGlvbnMgPSBwaWNrZXJPcHRpb25zO1xuICAgICAgfVxuXG4gICAgICB0aGlzLnNlc3Npb24ucHJlZmV0Y2ggPSBkYXRhO1xuXG4gICAgICByZXR1cm4gZGF0YTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZWFzc2lnbiBjYWxsYmFja3MgZnJvbSBvbGQgcGlja2VyIGNvbmZpZ3VyYXRpb25cbiAgICpcbiAgICogQHBhcmFtIG9iak9sZFxuICAgKiBAcGFyYW0gb2JqVGFyZ2V0XG4gICAqL1xuICBwcml2YXRlIHJlYXNzaWduQ2FsbGJhY2tzKG9iak9sZCwgb2JqVGFyZ2V0KSB7XG4gICAgaWYgKCFvYmpPbGQgfHwgT2JqZWN0LmtleXMob2JqT2xkKS5sZW5ndGggPT09IDApIHtcbiAgICAgIHJldHVybiBvYmpPbGQ7XG4gICAgfVxuXG4gICAgZm9yIChjb25zdCBrIGluIG9iak9sZCkge1xuICAgICAgaWYgKHR5cGVvZiBvYmpPbGRba10gPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgb2JqVGFyZ2V0W2tdID0gb2JqT2xkW2tdO1xuICAgICAgfVxuXG4gICAgICBpZiAob2JqT2xkW2tdID09PSBPYmplY3Qob2JqT2xkW2tdKSkge1xuICAgICAgICBvYmpUYXJnZXRba10gPSB0aGlzLnJlYXNzaWduQ2FsbGJhY2tzKG9iak9sZFtrXSwgb2JqVGFyZ2V0W2tdKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gb2JqVGFyZ2V0O1xuICB9XG59XG4iXX0=

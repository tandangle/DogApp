"use strict";
/*
 * Copyright (c) 2018 by Filestack.
 * Some rights reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
Object.defineProperty(exports, "__esModule", { value: true });
var tslib_1 = require("tslib");
var nock = require("nock");
var dispatch_1 = require("./dispatch");
var http_1 = require("./adapters/http");
var types_1 = require("./types");
var error_1 = require("./error");
jest.mock('./adapters/http');
describe('Request/Dispatch', function () {
    afterEach(function () {
        nock.cleanAll();
    });
    var adapter = new http_1.HttpAdapter();
    var url = 'https://filestack.com';
    var configBase = {
        url: url,
        method: types_1.FsHttpMethod.GET,
    };
    var fsResponseBase = {
        status: 400,
        statusText: 'error',
        headers: null,
        data: null,
        config: configBase,
    };
    describe('dispatch request', function () {
        it('should return req', function () { return tslib_1.__awaiter(void 0, void 0, void 0, function () {
            var dispatch, req;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        spyOn(adapter, 'request').and.callFake(function () { return Promise.resolve(); });
                        dispatch = new dispatch_1.Dispatch(adapter);
                        req = { url: url, method: types_1.FsHttpMethod.GET, headers: {} };
                        return [4 /*yield*/, dispatch.request(req)];
                    case 1:
                        _a.sent();
                        expect(adapter.request).toHaveBeenCalledWith(req);
                        return [2 /*return*/];
                }
            });
        }); });
    });
    describe('dispatch request catch', function () {
        it('should return config base', function () { return tslib_1.__awaiter(void 0, void 0, void 0, function () {
            var error, dispatch, request;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        error = new error_1.FsRequestError('error msg', configBase, fsResponseBase);
                        spyOn(adapter, 'request').and.callFake(function () { return Promise.reject(error); });
                        dispatch = new dispatch_1.Dispatch(adapter);
                        return [4 /*yield*/, dispatch.request(configBase).catch(function (err) { return err; })];
                    case 1:
                        request = _a.sent();
                        expect(adapter.request).toHaveBeenCalledWith(configBase);
                        return [2 /*return*/];
                }
            });
        }); });
        it('should return config base', function () { return tslib_1.__awaiter(void 0, void 0, void 0, function () {
            var error, dispatch;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        fsResponseBase.status = 500;
                        error = new error_1.FsRequestError('error msg', configBase, fsResponseBase, error_1.FsRequestErrorCode.NETWORK);
                        spyOn(adapter, 'request').and.callFake(function () { return Promise.reject(error); });
                        dispatch = new dispatch_1.Dispatch(adapter);
                        return [4 /*yield*/, dispatch.request(configBase).catch(function (err) { return err; })];
                    case 1:
                        _a.sent();
                        expect(adapter.request).toHaveBeenCalledWith(configBase);
                        return [2 /*return*/];
                }
            });
        }); });
        it('should return config', function () { return tslib_1.__awaiter(void 0, void 0, void 0, function () {
            var config, error, dispatch;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        config = {
                            url: url,
                            method: types_1.FsHttpMethod.GET,
                            headers: {},
                            retry: {
                                retry: 3,
                            },
                        };
                        fsResponseBase.status = 500;
                        error = new error_1.FsRequestError('error msg', config, fsResponseBase, error_1.FsRequestErrorCode.NETWORK);
                        spyOn(adapter, 'request').and.callFake(function () { return Promise.reject(error); });
                        dispatch = new dispatch_1.Dispatch(adapter);
                        return [4 /*yield*/, dispatch.request(config).catch(function (err) { return err; })];
                    case 1:
                        _a.sent();
                        expect(adapter.request).toHaveBeenCalledWith(config);
                        return [2 /*return*/];
                }
            });
        }); });
    });
});

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9saWIvcmVxdWVzdC9kaXNwYXRjaC5zcGVjLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7Ozs7Ozs7Ozs7O0dBZUc7OztBQUVILDJCQUE2QjtBQUM3Qix1Q0FBc0M7QUFDdEMsd0NBQThDO0FBQzlDLGlDQUF1QztBQUN2QyxpQ0FBNkQ7QUFFN0QsSUFBSSxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO0FBRTdCLFFBQVEsQ0FBQyxrQkFBa0IsRUFBRTtJQUMzQixTQUFTLENBQUM7UUFDUixJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7SUFDbEIsQ0FBQyxDQUFDLENBQUM7SUFFSCxJQUFNLE9BQU8sR0FBRyxJQUFJLGtCQUFXLEVBQUUsQ0FBQztJQUNsQyxJQUFNLEdBQUcsR0FBRyx1QkFBdUIsQ0FBQztJQUNwQyxJQUFNLFVBQVUsR0FBRztRQUNqQixHQUFHLEVBQUUsR0FBRztRQUNSLE1BQU0sRUFBRSxvQkFBWSxDQUFDLEdBQUc7S0FDekIsQ0FBQztJQUNGLElBQUksY0FBYyxHQUFHO1FBQ25CLE1BQU0sRUFBRSxHQUFHO1FBQ1gsVUFBVSxFQUFFLE9BQU87UUFDbkIsT0FBTyxFQUFFLElBQUk7UUFDYixJQUFJLEVBQUUsSUFBSTtRQUNWLE1BQU0sRUFBRSxVQUFVO0tBQ25CLENBQUM7SUFFRixRQUFRLENBQUMsa0JBQWtCLEVBQUU7UUFDM0IsRUFBRSxDQUFDLG1CQUFtQixFQUFFOzs7Ozt3QkFDdEIsS0FBSyxDQUFDLE9BQU8sRUFBRSxTQUFTLENBQUMsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLGNBQU0sT0FBQSxPQUFPLENBQUMsT0FBTyxFQUFFLEVBQWpCLENBQWlCLENBQUMsQ0FBQzt3QkFDMUQsUUFBUSxHQUFHLElBQUksbUJBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQzt3QkFDakMsR0FBRyxHQUFHLEVBQUUsR0FBRyxLQUFBLEVBQUUsTUFBTSxFQUFFLG9CQUFZLENBQUMsR0FBRyxFQUFFLE9B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T0FBQSxHQUFHLEVBQUgsQ0FBRyxDQUFDLEVBQUE7O3dCQUFoRCxTQUFnRCxDQUFDO3dCQUNqRCxNQUFNLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDLG9CQUFvQixDQUFDLE1BQU0sQ0FBQyxDQUFDOzs7O2FBQ3RELENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJmaWxlIjoibGliL3JlcXVlc3QvZGlzcGF0Y2guc3BlYy5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTggYnkgRmlsZXN0YWNrLlxuICogU29tZSByaWdodHMgcmVzZXJ2ZWQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCAqIGFzIG5vY2sgZnJvbSAnbm9jayc7XG5pbXBvcnQgeyBEaXNwYXRjaCB9IGZyb20gJy4vZGlzcGF0Y2gnO1xuaW1wb3J0IHsgSHR0cEFkYXB0ZXIgfSBmcm9tICcuL2FkYXB0ZXJzL2h0dHAnO1xuaW1wb3J0IHsgRnNIdHRwTWV0aG9kIH0gZnJvbSAnLi90eXBlcyc7XG5pbXBvcnQgeyBGc1JlcXVlc3RFcnJvciwgRnNSZXF1ZXN0RXJyb3JDb2RlIH0gZnJvbSAnLi9lcnJvcic7XG5cbmplc3QubW9jaygnLi9hZGFwdGVycy9odHRwJyk7XG5cbmRlc2NyaWJlKCdSZXF1ZXN0L0Rpc3BhdGNoJywgKCkgPT4ge1xuICBhZnRlckVhY2goKCkgPT4ge1xuICAgIG5vY2suY2xlYW5BbGwoKTtcbiAgfSk7XG5cbiAgY29uc3QgYWRhcHRlciA9IG5ldyBIdHRwQWRhcHRlcigpO1xuICBjb25zdCB1cmwgPSAnaHR0cHM6Ly9maWxlc3RhY2suY29tJztcbiAgY29uc3QgY29uZmlnQmFzZSA9IHtcbiAgICB1cmw6IHVybCxcbiAgICBtZXRob2Q6IEZzSHR0cE1ldGhvZC5HRVQsXG4gIH07XG4gIGxldCBmc1Jlc3BvbnNlQmFzZSA9IHtcbiAgICBzdGF0dXM6IDQwMCxcbiAgICBzdGF0dXNUZXh0OiAnZXJyb3InLFxuICAgIGhlYWRlcnM6IG51bGwsXG4gICAgZGF0YTogbnVsbCxcbiAgICBjb25maWc6IGNvbmZpZ0Jhc2UsXG4gIH07XG5cbiAgZGVzY3JpYmUoJ2Rpc3BhdGNoIHJlcXVlc3QnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gcmVxJywgYXN5bmMgKCkgPT4ge1xuICAgICAgc3B5T24oYWRhcHRlciwgJ3JlcXVlc3QnKS5hbmQuY2FsbEZha2UoKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkpO1xuICAgICAgY29uc3QgZGlzcGF0Y2ggPSBuZXcgRGlzcGF0Y2goYWRhcHRlcik7XG4gICAgICBjb25zdCByZXEgPSB7IHVybCwgbWV0aG9kOiBGc0h0dHBNZXRob2QuR0VULCBoZWFkZXJzOiB7fSB9O1xuICAgICAgYXdhaXQgZGlzcGF0Y2gucmVxdWVzdChyZXEpO1xuICAgICAgZXhwZWN0KGFkYXB0ZXIucmVxdWVzdCkudG9IYXZlQmVlbkNhbGxlZFdpdGgocmVxKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2Rpc3BhdGNoIHJlcXVlc3QgY2F0Y2gnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gY29uZmlnIGJhc2UnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBlcnJvciA9IG5ldyBGc1JlcXVlc3RFcnJvcignZXJyb3IgbXNnJywgY29uZmlnQmFzZSwgZnNSZXNwb25zZUJhc2UpO1xuICAgICAgc3B5T24oYWRhcHRlciwgJ3JlcXVlc3QnKS5hbmQuY2FsbEZha2UoKCkgPT4gUHJvbWlzZS5yZWplY3QoZXJyb3IpKTtcbiAgICAgIGNvbnN0IGRpc3BhdGNoID0gbmV3IERpc3BhdGNoKGFkYXB0ZXIpO1xuICAgICAgY29uc3QgcmVxdWVzdCA9IGF3YWl0IGRpc3BhdGNoLnJlcXVlc3QoY29uZmlnQmFzZSkuY2F0Y2goZXJyID0+IGVycik7XG4gICAgICBleHBlY3QoYWRhcHRlci5yZXF1ZXN0KS50b0hhdmVCZWVuQ2FsbGVkV2l0aChjb25maWdCYXNlKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcmV0dXJuIGNvbmZpZyBiYXNlJywgYXN5bmMgKCkgPT4ge1xuICAgICAgZnNSZXNwb25zZUJhc2Uuc3RhdHVzID0gNTAwO1xuICAgICAgY29uc3QgZXJyb3IgPSBuZXcgRnNSZXF1ZXN0RXJyb3IoJ2Vycm9yIG1zZycsIGNvbmZpZ0Jhc2UsIGZzUmVzcG9uc2VCYXNlLCBGc1JlcXVlc3RFcnJvckNvZGUuTkVUV09SSyk7XG4gICAgICBzcHlPbihhZGFwdGVyLCAncmVxdWVzdCcpLmFuZC5jYWxsRmFrZSgoKSA9PiBQcm9taXNlLnJlamVjdChlcnJvcikpO1xuICAgICAgY29uc3QgZGlzcGF0Y2ggPSBuZXcgRGlzcGF0Y2goYWRhcHRlcik7XG4gICAgICBhd2FpdCBkaXNwYXRjaC5yZXF1ZXN0KGNvbmZpZ0Jhc2UpLmNhdGNoKGVyciA9PiBlcnIpO1xuICAgICAgZXhwZWN0KGFkYXB0ZXIucmVxdWVzdCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoY29uZmlnQmFzZSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHJldHVybiBjb25maWcnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBjb25maWcgPSB7XG4gICAgICAgIHVybDogdXJsLFxuICAgICAgICBtZXRob2Q6IEZzSHR0cE1ldGhvZC5HRVQsXG4gICAgICAgIGhlYWRlcnM6IHt9LFxuICAgICAgICByZXRyeToge1xuICAgICAgICAgIHJldHJ5OiAzLFxuICAgICAgICB9LFxuICAgICAgfTtcbiAgICAgIGZzUmVzcG9uc2VCYXNlLnN0YXR1cyA9IDUwMDtcbiAgICAgIGNvbnN0IGVycm9yID0gbmV3IEZzUmVxdWVzdEVycm9yKCdlcnJvciBtc2cnLCBjb25maWcsIGZzUmVzcG9uc2VCYXNlLCBGc1JlcXVlc3RFcnJvckNvZGUuTkVUV09SSyk7XG4gICAgICBzcHlPbihhZGFwdGVyLCAncmVxdWVzdCcpLmFuZC5jYWxsRmFrZSgoKSA9PiBQcm9taXNlLnJlamVjdChlcnJvcikpO1xuICAgICAgY29uc3QgZGlzcGF0Y2ggPSBuZXcgRGlzcGF0Y2goYWRhcHRlcik7XG4gICAgICBhd2FpdCBkaXNwYXRjaC5yZXF1ZXN0KGNvbmZpZykuY2F0Y2goZXJyID0+IGVycik7XG4gICAgICBleHBlY3QoYWRhcHRlci5yZXF1ZXN0KS50b0hhdmVCZWVuQ2FsbGVkV2l0aChjb25maWcpO1xuICAgIH0pO1xuICB9KTtcbn0pO1xuIl19
